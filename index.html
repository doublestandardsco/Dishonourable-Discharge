<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dishonourable Discharge</title>
  <style>
    :root{
      --bg:#0a0a0a; --bg2:#1a1a2e; --bg3:#16213e;
      --red:#ff4757; --vio:#5f27cd; --vio2:#7c3aed; --ora:#ffa500; --blue:#3498db;
      --fg:#e0e0e0; --muted:#9bbcff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Courier New',monospace; color:var(--fg);
      min-height:100vh; background:linear-gradient(135deg,var(--bg),var(--bg2),var(--bg3));
      padding:18px;
    }
    .wrap{max-width:980px;margin:0 auto;background:rgba(0,0,0,.9);border:2px solid var(--red);
      border-radius:16px; padding:22px; box-shadow:0 0 40px rgba(255,71,87,.25); position:relative}
    .stamp{position:absolute;top:20px;right:20px;background:var(--red);color:#000;
      padding:7px 14px;border:3px solid #000;transform:rotate(10deg);font-weight:bold}
    h1{margin:0 0 6px;color:var(--red);text-shadow:0 0 18px rgba(255,71,87,.7);letter-spacing:3px;text-align:center}
    .sub{color:var(--vio);text-align:center;margin-bottom:20px}
    .section{background:rgba(255,255,255,.03);border-left:4px solid var(--vio);border-radius:10px;padding:18px;margin:14px 0}
    .title{color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:760px){.g2,.g3{grid-template-columns:1fr}}
    label{display:block;margin-bottom:6px;color:var(--vio);font-weight:bold;font-size:.88em;letter-spacing:.5px}
    input,select,textarea{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid var(--vio);border-radius:8px;color:var(--fg)}
    .btn{background:linear-gradient(45deg,var(--red),#ff6b7a);color:#000;border:none;padding:12px 16px;border-radius:8px;
      font-weight:bold;cursor:pointer;transition:.15s;text-transform:uppercase;letter-spacing:1px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(255,71,87,.45)}
    .btn.sec{background:linear-gradient(45deg,var(--vio),var(--vio2));color:#fff}
    .btn.out{background:transparent;border:2px dashed var(--vio);color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{font-size:.85em;color:var(--muted)}
    .muted{opacity:.75}
    .card{border:1px dashed var(--vio);border-radius:10px;padding:10px}
    .good{color:#8ef08e}.bad{color:#ff9aa2}
    .dossier{border:2px solid var(--red);border-radius:12px;background:linear-gradient(135deg,rgba(255,71,87,.1),rgba(95,39,205,.1));padding:16px;margin:12px 0;position:relative}
    .dossier:before{content:"CLASSIFIED";position:absolute;top:-10px;left:18px;background:var(--red);color:#000;padding:3px 10px;font-size:.72em;font-weight:bold}
    .code{color:var(--red);font-weight:bold}
    .log{max-height:260px;overflow:auto;background:rgba(0,0,0,.45);border:2px solid var(--vio);border-radius:10px;padding:12px}
    .line{border-left:3px solid var(--vio);padding-left:10px;margin:8px 0;background:rgba(95,39,205,.12);border-radius:4px}
    .hidden{display:none}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--vio),transparent);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stamp">TOP SECRET</div>
    <h1>DISHONOURABLE DISCHARGE</h1>
    <div class="sub">Operation: Alpine Debrief</div>

    <!-- GM PANEL -->
    <div id="gmPanel" class="section">
      <div class="title">üéÆ Game Master Control</div>
      <div class="grid g3">
        <div>
          <label>Game Key</label>
          <input id="sessionId" placeholder="e.g. QT1" />
        </div>
        <div>
          <label>Player Limit</label>
          <select id="playerCount">
            <option>3</option><option>4</option><option>5</option>
            <option selected>6</option><option>8</option><option>12</option>
          </select>
        </div>
        <div>
          <label>Final Night (unlocks scans/accusations)</label>
          <input type="datetime-local" id="finalNightAt"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="createGame()">Create Game</button>
        <button class="btn sec" onclick="refreshState()">Refresh State</button>
        <button class="btn out" onclick="copyGameLink()">Copy Join Link (Key Only)</button>
      </div>
      <div id="gmMsg" class="small" style="margin-top:8px"></div>
      <div id="seatList" class="grid g3" style="margin-top:10px"></div>
    </div>

    <!-- LOGIN PANEL -->
    <div id="loginPanel" class="section">
      <div class="title">üîê Player Login</div>
      <div class="grid g3">
        <div>
          <label>Your Name</label>
          <input id="playerName" placeholder="e.g. Kaleb"/>
        </div>
        <div>
          <label>Game Key</label>
          <input id="gameKeyLogin" placeholder="e.g. QT1"/>
        </div>
        <div>
          <label>Seat Key</label>
          <input id="seatKey" placeholder="e.g. AB1C-9XYZ"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="joinGame()">Join Game</button>
        <button class="btn sec" onclick="refreshState()">Refresh State</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashPanel" class="section hidden">
      <div class="title">üßæ Agent Dashboard</div>

      <div class="dossier">
        <div class="row" style="justify-content:space-between">
          <div><span class="code" id="codenameText">‚Äî</span> <span class="small muted">(Agent ID <span id="agentIdText">‚Äî</span>)</span></div>
          <div class="small">Game: <span id="gameKeyText">‚Äî</span></div>
        </div>
        <div class="hr"></div>
        <div class="grid g2">
          <div class="card">
            <div class="small muted">Your Name</div>
            <div id="realNameText">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Adopted Name</div>
            <div id="aliasText">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Cover Identity</div>
            <div id="coverText">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Role</div>
            <div id="roleText">‚Äî</div>
          </div>
        </div>
        <div class="grid g2" style="margin-top:10px">
          <div class="card">
            <div class="small muted">Public Bio</div>
            <div id="publicBioText">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Private Bio (you only)</div>
            <div id="privateBioText">‚Äî</div>
          </div>
        </div>
        <div id="murdererCard" class="card" style="margin-top:10px; display:none">
          <div class="small good">‚ò†Ô∏è Secret Directive (Murderer)</div>
          <div id="murdererDirective">‚Äî</div>
        </div>
      </div>

      <div class="section" style="border-left-color:var(--blue)">
        <div class="title">üóÇÔ∏è Public Roster</div>
        <div id="rosterList"></div>
      </div>

      <div class="section" style="border-left-color:var(--ora)">
        <div class="title">üì° Operation Log</div>
        <div id="logView" class="log"></div>
      </div>

      <div class="row">
        <button class="btn sec" onclick="refreshState()">Refresh</button>
        <button class="btn out" onclick="leaveSeat()">Leave Seat (Clear Local)</button>
      </div>
    </div>
  </div>

<script>
/* ======== helpers ======== */
const $ = id => document.getElementById(id);
const now = () => Date.now();
const fmt = ts => new Date(ts).toLocaleString();
function logLocal(msg){ console.log(msg); }
function uiMsg(id, text){ const el=$(id); if(el) el.textContent = text||''; }

/* ======== character pack (12) ======== */
/* deterministic assignment from Seat Key (to reduce dupes) */
const CHARACTERS = [
  { alias:"Val√©rie 'Val' Marchand", codename:"LACEHUNTER",
    cover:"Luxury Skiwear Designer",
    publicBio:"French AF comms ‚Üí NATO PSYOPS ‚Äòtactical glam‚Äô. Gives unsolicited ‚Äòrunway checks‚Äô.",
    privateBio:"Got busted tailoring a general‚Äôs thermals. Can‚Äôt pass a mirror without preening.",
    perks:["Honorific Lock: others must call you ‚ÄúMonsieur Val‚Äù.","Style Verdict: on 'Runway check', target holds an awkward 10-sec pose."],
    quirk:"Wears a silk cravat. Applies lip balm mid-sentence.",
    con:"If he catches his reflection he must stop & preen for 3s.",
    role:"wildcard"
  },
  { alias:"Kaimana 'Kai' Savai'i", codename:"SNOWBLIND",
    cover:"Extreme Sports Photographer",
    publicBio:"RFMF (Fiji) recon tracker; can find happy hour with GPS accuracy.",
    privateBio:"Refused to hunt an innocent defector (his brother). Collects slang like shell casings.",
    perks:["Breadcrumb Command: choose a trigger word; speakers owe a clue or take penalty for 10 min.",
           "Switchback: say 'First tracks' ‚Üí everyone rotates seats; last seated owes you a favour."],
    quirk:"Whispers intel and ends with 'copy?'",
    con:"If someone says 'family'/'ohana', must deliver a 1-sentence heartfelt lesson.",
    role:"innocent"
  },
  { alias:"Basia 'Bas' Nowak", codename:"FROSTBITE",
    cover:"Adventure Safety Coordinator",
    publicBio:"Polish GROM cold-weather specialist. Loves lists & laminated check cards.",
    privateBio:"Interrogation ‚Äòcultural differences‚Äô. Considers silence a confession.",
    perks:["Interrogator‚Äôs Pause: on 'Answer the question', target must reply in ‚â§5 words.",
           "Cold Protocol: greetings become fist-bump only until cleared."],
    quirk:"Over-enunciates like radio checks; NATO phonetic for numbers.",
    con:"When asked 'what‚Äôs the plan?' must present a checklist or salute & claim 'I am improvising.'",
    role:"handler"
  },
  { alias:"Ira 'Iris' Khatri", codename:"BLACKRUN",
    cover:"Avalanche Risk Specialist",
    publicBio:"Para (SF) mountain warfare; predicts disasters in people as easily as in snow.",
    privateBio:"The avalanche that saved lives also hid sins; she‚Äôll never tell whose.",
    perks:["Beacon Check: phones face-down 5 min; touching = penalty.",
           "Disaster Brief: two table taps resets topic & assigns next speaker."],
    quirk:"Adds 'allegedly' to claims if alcohol is present.",
    con:"On triangles/angles she estimates degrees aloud; if off by >10¬∞ must sketch a napkin protractor.",
    role:"wildcard"
  },
  { alias:"Pilar 'Pili' Casta√±o", codename:"POWDER KEG",
    cover:"Luxury Lodge Event Coordinator",
    publicBio:"Spanish social engineer; diplomacy with a splash of chaos.",
    privateBio:"Ran weapons through receptions. Still RSVP‚Äôs 'maybe' to Interpol.",
    perks:["VIP Gate: others must introduce you with a flamboyant invented title.",
           "Guest List: 'You‚Äôre on the list' ‚Üí 2-min private chat to assign a micro-task."],
    quirk:"Refuses real names; assigns callsigns.",
    con:"On any rumour she must add 'exclusive source' + wink; if asked later 'source?' she must admit 'It was me.'",
    role:"wildcard"
  },
  { alias:"Dmitri 'Dima' Volkov", codename:"ICEPICK",
    cover:"Artisanal Spirits Consultant",
    publicBio:"Ex-Spetsnaz (allegedly). Measures every drink‚Äôs temperature. Speaks in Celsius.",
    privateBio:"Defected‚Äî or didn‚Äôt. Awaits a signal only he would recognize.",
    perks:["Cold Stare: on eye contact the other must break first or penalty.",
           "Vodka Toast Override: on 'Na zdorovye', all must toast; 30s to find alcohol or penalty."],
    quirk:"Answers 'roger' instead of 'yes' and ends sentences with 'over.'",
    con:"When a new person arrives, he must pat pockets: 'ID, keys, exit‚Äîroger'; if caught skipping ‚Üí 10-sec bug sweep.",
    role:"innocent"
  },
  { alias:"Rowan 'Ro' Hart", codename:"WOLFTRAP",
    cover:"Night Security Analyst",
    publicBio:"Ex-infantry turned nightclub perimeter whisperer. Hears bouncers before the bass.",
    privateBio:"Thinks velvet ropes are guidelines. Once dated a smoke machine.",
    perks:["Line Cutter: may insert yourself into any group; someone must introduce you within 20s.",
           "Bouncer‚Äôs Choice: point to the door; one person must accompany you for a 60s 'perimeter check'."],
    quirk:"Counts exits out loud (quietly) when entering a room.",
    con:"If music changes, must freeze for 3s like a motion sensor.",
    role:"innocent"
  },
  { alias:"Asher 'Ash' Del Mar", codename:"SEALEVEL",
    cover:"Hydro Logistics Planner",
    publicBio:"Special forces boat guy who gets altitude sickness looking at menus.",
    privateBio:"Smuggled a jet-ski into a hotel fountain. Twice.",
    perks:["High-Water Mark: pick a 'shoreline' on the table; items crossing it owe you a sip.",
           "Docking Fee: anyone returning to the group pays you a one-word status update."],
    quirk:"Adds boat metaphors to everything.",
    con:"If someone says 'wave', must salute like a lifeguard.",
    role:"wildcard"
  },
  { alias:"Noah 'Knox' Keegan", codename:"SWITCHBACK",
    cover:"Mountain Bike Guide",
    publicBio:"Downhill brain, uphill charm. Always plotting the next corner.",
    privateBio:"Claims a scar for each Greek letter he can remember. That‚Äôs‚Ä¶ many.",
    perks:["Gear Check: on 'Drop a gear', everyone lowers voice one notch for 2 min.",
           "Trail Marshal: you decide who speaks next for 60s."],
    quirk:"Claps once when he stands up.",
    con:"If someone says 'brake', must freeze mid-gesture for 2s.",
    role:"innocent"
  },
  { alias:"Jamie 'Harrow' Quinn", codename:"BONESAW",
    cover:"Field Medic (Former)",
    publicBio:"Good with stitches; terrible with boundaries. Brings tape to conversations.",
    privateBio:"Kept a toe tag as a bookmark. It fell out at a funeral.",
    perks:["Triage: you may interrupt any chat to ask 'Vitals?'‚Äîanswer must be a number.",
           "Sterile Field: designate a 30cm zone around your drink; violators owe an apology shot."],
    quirk:"Calls snacks 'oral medication'.",
    con:"If someone says 'owie', must produce a bandage (real or improvised).",
    role:"wildcard"
  },
  { alias:"Elliot 'Ledger' Vance", codename:"COUNTERSIGN",
    cover:"Casino Surveillance",
    publicBio:"Counts cards, people, and regrets. Mostly people.",
    privateBio:"Wears mirrored sunglasses at night because 'math is bright'.",
    perks:["Tell Read: you may ask someone to repeat a sentence slower.",
           "Double Down: once, force a yes/no commitment from the table."],
    quirk:"Murmurs odds to himself.",
    con:"If anyone says a number >10, must whisper a different random number.",
    role:"handler"
  },
  { alias:"Rafe 'Static' Moretti", codename:"JAMMER",
    cover:"RF Tech",
    publicBio:"Carries more antennas than personality. Still‚Ä¶ weirdly charming.",
    privateBio:"Blocked a wedding livestream so the bride‚Äôs ex couldn‚Äôt watch. She thanked him.",
    perks:["Signal Check: say 'Bars?' and everyone must show phone lock screen for 3s.",
           "Dead Zone: pick a corner where nobody may use phones for 5 min."],
    quirk:"Says 'Copy' to compliments.",
    con:"If someone says 'loud', must turn an imaginary knob.",
    role:"innocent"
  }
];

function pickCharacterForSeat(seatKey){
  // hash seat key -> index
  let h = 0; for(const c of seatKey) h = (h*31 + c.charCodeAt(0)) >>> 0;
  const base = CHARACTERS[h % CHARACTERS.length];
  // shallow clone
  return JSON.parse(JSON.stringify(base));
}

/* ======== state ======== */
let gameState = {};          // full session from server
let currentPlayer = null;    // my player object

/* ======== API ======== */
async function api(op, body={}){
  if(op==='get'){
    const id = body.id;
    const r = await fetch(`/api/game?id=${encodeURIComponent(id)}`);
    return r.json();
  }
  const r = await fetch('/api/game', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({op, ...body}) });
  return r.json();
}

/* ======== GM actions ======== */
async function createGame(){
  const sessionId = ($('sessionId').value||'').toUpperCase().trim();
  const playerLimit = Number($('playerCount').value||6);
  const finalNightAt = $('finalNightAt').value ? new Date($('finalNightAt').value).getTime() : null;

  const res = await api('create', { sessionId, playerLimit, finalNightAt });
  if(!res.ok){ uiMsg('gmMsg', '‚ùå '+(res.error||'Create failed')); return; }

  localStorage.setItem('gm_session', res.session.id);
  uiMsg('gmMsg', `‚úÖ Game ${res.session.id} created (limit ${res.session.playerLimit})`);
  $('gameKeyLogin').value = res.session.id;
  renderSeats(res.seats);
  await refreshState();
}

function renderSeats(seats){
  $('seatList').innerHTML = seats.map(s=>`
    <div class="card">
      <div><strong>${s.token}</strong></div>
      <div class="row" style="margin-top:6px">
        <button class="btn sec" style="padding:6px 10px" onclick="copyText('${s.token}')">Copy</button>
      </div>
    </div>
  `).join('');
}
function copyText(t){ navigator.clipboard.writeText(t); }
function copyGameLink(){
  const id = $('sessionId').value || localStorage.getItem('gm_session') || '';
  if(!id){ uiMsg('gmMsg','No game key yet.'); return; }
  const url = `${location.origin}${location.pathname}?session=${encodeURIComponent(id)}`;
  copyText(url);
  uiMsg('gmMsg','Copied join link (key only).');
}

/* ======== Player actions ======== */
async function joinGame(){
  const sessionId = ($('gameKeyLogin').value||'').toUpperCase().trim();
  const seatToken = ($('seatKey').value||'').toUpperCase().trim();
  const playerName = ($('playerName').value||'').trim();
  if(!sessionId || !seatToken){ uiMsg('loginMsg','Enter game key and seat key'); return; }

  const character = pickCharacterForSeat(seatToken);
  // also store alias on dossier explicitly
  character.adoptedName = character.alias;

  const res = await api('join', { sessionId, seatToken, playerName, character });
  if(!res.ok){ uiMsg('loginMsg', '‚ùå '+(res.error||'Join failed')); return; }

  localStorage.setItem('session', res.session.id);
  localStorage.setItem('seatToken', seatToken);
  localStorage.setItem('playerId', res.player.id);

  currentPlayer = res.player;
  await refreshState();
  showDashboard();
}

async function refreshState(){
  const id = localStorage.getItem('session') || localStorage.getItem('gm_session') || ($('sessionId').value||'').toUpperCase();
  if(!id) return;

  const res = await api('get', { id });
  if(!res.ok){ return; }
  gameState = res.session;

  // if I'm logged in, refresh my player record
  const myId = localStorage.getItem('playerId');
  if(myId){
    const me = (gameState.players||[]).find(p=>p.id===myId);
    if(me) currentPlayer = me;
  }

  // render UI bits if dashboard visible
  renderRoster();
  renderLog();
  renderDossier();
}

function showDashboard(){
  $('gmPanel').classList.add('hidden');
  $('loginPanel').classList.add('hidden');
  $('dashPanel').classList.remove('hidden');
  $('gameKeyText').textContent = gameState.id || localStorage.getItem('session') || '‚Äî';
  renderDossier();
  renderRoster();
  renderLog();
}

function leaveSeat(){
  localStorage.removeItem('session');
  localStorage.removeItem('seatToken');
  localStorage.removeItem('playerId');
  location.href = location.pathname; // reload to login
}

/* ======== Rendering ======== */
function renderDossier(){
  if(!currentPlayer) return;
  $('codenameText').textContent = currentPlayer.codename || 'OPERATIVE';
  $('agentIdText').textContent = currentPlayer.id || '‚Äî';
  $('realNameText').textContent = currentPlayer.realName || '‚Äî';
  $('aliasText').textContent = currentPlayer.adoptedName || currentPlayer.alias || '‚Äî';
  $('coverText').textContent = currentPlayer.cover || '‚Äî';
  $('roleText').textContent = currentPlayer.role || '‚Äî';
  $('publicBioText').textContent = currentPlayer.publicBio || '‚Äî';
  $('privateBioText').textContent = currentPlayer.privateBio || '‚Äî';

  // murderer directive (if me)
  const panel = $('murdererCard');
  if(gameState.murderer && gameState.murderer.id === currentPlayer.id){
    panel.style.display = 'block';
    $('murdererDirective').textContent = gameState.murderer.act || '‚Äî';
  }else{
    panel.style.display = 'none';
  }
}

function renderRoster(){
  const list = gameState.players || [];
  if(!list.length){ $('rosterList').innerHTML = '<div class="muted">No agents yet.</div>'; return; }
  $('rosterList').innerHTML = list.map(p=>{
    const perks = (p.perks||[]).map(x=>`<li>${x}</li>`).join('') || '<li>‚Äî</li>';
    const me = (currentPlayer && p.id===currentPlayer.id) ? ' (you)' : '';
    return `
      <div class="card" style="margin:8px 0">
        <div class="row" style="justify-content:space-between">
          <div><strong class="code">${p.codename}</strong> ‚Äî ${p.realName}${me}</div>
          <div class="small muted">${p.id}</div>
        </div>
        <div class="small">${p.cover||''}</div>
        <div class="grid g3" style="margin-top:8px">
          <div><div class="small muted">Public Bio</div>${p.publicBio||'‚Äî'}</div>
          <div><div class="small muted">Quirk</div>${p.quirk||'‚Äî'}</div>
          <div><div class="small muted">Con</div>${p.con||'‚Äî'}</div>
        </div>
        <div style="margin-top:6px"><div class="small muted">Perks</div><ul style="margin:6px 0 0 18px">${perks}</ul></div>
      </div>
    `;
  }).join('');
}

function renderLog(){
  const log = gameState.gameLog || [];
  $('logView').innerHTML = log.slice(-200).map(l=>`<div class="line"><strong>[${new Date(l.ts).toLocaleTimeString()}]</strong> ${l.msg}</div>`).join('') || '<div class="muted">No events yet.</div>';
  const el = $('logView'); el.scrollTop = el.scrollHeight;
}

/* ======== boot / auto-rejoin ======== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // if URL has ?session=... prefill GM + login key
  const qs = new URLSearchParams(location.search);
  const urlSession = (qs.get('session')||'').toUpperCase();
  if(urlSession){
    $('sessionId').value = urlSession;
    $('gameKeyLogin').value = urlSession;
    localStorage.setItem('gm_session', urlSession);
  }

  // Auto-rejoin if we have a seat
  const session = localStorage.getItem('session');
  const seatToken = localStorage.getItem('seatToken');
  if(session && seatToken){
    try{
      await api('join', { sessionId: session, seatToken, playerName:'' });
      await refreshState();
      showDashboard();
    }catch(e){ /* ignore */ }
  }else{
    // Otherwise just load any GM session info to show logs/roster
    const gm = localStorage.getItem('gm_session');
    if(gm){ $('sessionId').value = gm; $('gameKeyLogin').value = gm; await refreshState(); }
  }
});
</script>
</body>
</html>
