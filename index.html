<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dishonourable Discharge</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Courier New',monospace;background:linear-gradient(135deg,#0a0a0a,#1a1a2e,#16213e);color:#e0e0e0;min-height:100vh;padding:10px;overflow-x:hidden}
    .container{max-width:900px;margin:0 auto;background:rgba(0,0,0,.9);border:2px solid #ff4757;border-radius:15px;padding:25px;box-shadow:0 0 40px rgba(255,71,87,.3);backdrop-filter:blur(10px);position:relative}
    .classified-stamp{position:absolute;top:20px;right:20px;background:#ff4757;color:#000;padding:8px 15px;transform:rotate(15deg);font-weight:bold;font-size:.9em;border:3px solid #000}
    .header{text-align:center;margin-bottom:30px;border-bottom:3px solid #ff4757;padding-bottom:20px}
    .header h1{color:#ff4757;font-size:2.4em;text-shadow:0 0 20px rgba(255,71,87,.8);margin-bottom:10px;letter-spacing:3px}
    .subtitle{color:#5f27cd;font-size:1.1em;font-style:italic;text-transform:uppercase;letter-spacing:1px}
    .section{margin-bottom:24px;padding:18px;background:rgba(255,255,255,.03);border-radius:10px;border-left:4px solid #5f27cd}
    .section-title{color:#ff4757;font-size:1.2em;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px}
    .form-group{margin-bottom:12px}
    label{display:block;margin-bottom:6px;color:#5f27cd;font-weight:bold;text-transform:uppercase;font-size:.85em}
    input[type="text"],input[type="datetime-local"],select,textarea{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid #5f27cd;border-radius:8px;color:#e0e0e0;font-family:'Courier New',monospace;font-size:.95em}
    .btn{background:linear-gradient(45deg,#ff4757,#ff6b7a);color:#000;border:none;padding:12px 16px;border-radius:8px;font-size:1em;font-weight:bold;cursor:pointer;transition:.2s;font-family:'Courier New',monospace;text-transform:uppercase;letter-spacing:1px}
    .btn.full{width:100%}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,71,87,.5)}
    .btn-secondary{background:linear-gradient(45deg,#5f27cd,#7c3aed);color:#fff}
    .btn-danger{background:linear-gradient(45deg,#ff3838,#ff6b6b)}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .dossier{background:linear-gradient(135deg,rgba(255,71,87,.1),rgba(95,39,205,.1));border:2px solid #ff4757;padding:16px;margin:16px 0;border-radius:12px;position:relative}
    .dossier::before{content:"CLASSIFIED";position:absolute;top:-10px;left:20px;background:#ff4757;color:#000;padding:4px 10px;font-size:.75em;font-weight:bold}
    .codename{color:#ff4757;font-size:1.6em;margin-bottom:10px;text-align:center;text-shadow:0 0 10px rgba(255,71,87,.5)}
    .dossier-field{margin-bottom:10px;display:flex;gap:10px;align-items:flex-start}
    .field-label{color:#5f27cd;font-weight:bold;min-width:140px;text-transform:uppercase;font-size:.85em}
    .field-value{color:#e0e0e0;flex:1;line-height:1.4}
    .secret-section{background:rgba(255,71,87,.1);border:2px solid #ff4757;border-radius:8px;padding:12px;margin:12px 0;position:relative}
    .secret-section::before{content:"üîí EYES ONLY";position:absolute;top:-10px;left:12px;background:#ff4757;color:#000;padding:3px 8px;font-size:.7em;font-weight:bold}
    .perk-box{background:linear-gradient(135deg,rgba(95,39,205,.2),rgba(116,185,255,.1));border:2px solid #5f27cd;border-radius:10px;padding:14px;margin:14px 0;text-align:center}
    .quirk-box{background:linear-gradient(135deg,rgba(255,71,87,.2),rgba(255,107,122,.1));border:2px solid #ff4757;border-radius:10px;padding:14px;margin:14px 0}
    .scanner-section{background:rgba(0,0,0,.7);padding:16px;border-radius:12px;margin:16px 0;border:2px solid #5f27cd}
    .game-log{background:rgba(0,0,0,.5);border:2px solid #5f27cd;border-radius:10px;padding:14px;margin:16px 0;max-height:320px;overflow-y:auto}
    .log-entry{margin-bottom:10px;font-size:.9em;padding:8px;border-left:3px solid #5f27cd;padding-left:12px;background:rgba(95,39,205,.1);border-radius:5px}
    .vote-section{background:linear-gradient(135deg,rgba(231,76,60,.3),rgba(192,57,43,.2));border:3px solid #e74c3c;border-radius:15px;padding:16px;margin:18px 0;text-align:center}
    .intel-panel{background:rgba(52,152,219,.1);border:2px solid #3498db;border-radius:10px;padding:14px;margin:14px 0}
    .hidden{display:none}
    .progress-bar{width:100%;height:10px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:linear-gradient(90deg,#5f27cd,#ff4757);border-radius:5px;transition:width .3s}
    .roster-card{border:1px dashed #5f27cd;border-radius:10px;padding:10px;margin:8px 0}
    .small{font-size:.85em;color:#9bbcff}
    .muted{opacity:.7}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    @media(max-width:720px){.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="classified-stamp">TOP SECRET</div>
    <div class="header">
      <h1>DISHONOURABLE DISCHARGE</h1>
      <div class="subtitle">Operation: Alpine Debrief</div>
    </div>

    <!-- Game Master Setup -->
    <div id="gameSetup" class="section">
      <div class="section-title">üéÆ Game Master Control</div>
      <div class="grid grid-2">
        <div class="form-group">
          <label>Game Session ID</label>
          <input type="text" id="sessionId" placeholder="Unique session ID">
        </div>
        <div class="form-group">
          <label>Number of Players</label>
          <select id="playerCount">
            <option value="3">3 Players</option>
            <option value="4">4 Players</option>
            <option value="5">5 Players</option>
            <option value="6" selected>6 Players</option>
            <option value="12">12 Players (expanded)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Final Night Starts (Scans/Accusations unlock)</label>
          <input type="datetime-local" id="finalNightAt">
        </div>
        <div class="form-group">
          <label>Game Ends</label>
          <input type="datetime-local" id="gameEndsAt">
        </div>
      </div>
      <div class="grid grid-2" style="margin-top:10px">
        <button id="btnInit" class="btn" onclick="initializeGame()">Initialize New Game</button>
        <button id="btnLoad" class="btn btn-secondary" onclick="loadExistingGame()">Load Existing Session</button>
      </div>
      <div id="gmHelp" class="small muted" style="margin-top:8px">
        Share links look like <em>?session=ABC123&player=agent_xxx</em>. Final-night gating updates automatically.
      </div>
    </div>

    <!-- Player Onboarding -->
    <div id="onboarding" class="hidden">
      <div class="section">
        <div class="section-title">üîê Agent Recruitment</div>
        <div style="background:#ff4757;color:#000;padding:12px;margin:14px 0;text-align:center;font-weight:bold;transform:rotate(-1deg);">
          ‚ö†Ô∏è CLASSIFIED OPERATION - AUTHORIZED PERSONNEL ONLY ‚ö†Ô∏è
        </div>
        <div class="form-group">
          <label>Agent Name</label>
          <input type="text" id="playerName" placeholder="Enter your real name" required>
        </div>
        <div class="form-group">
          <label>Session Code</label>
          <input type="text" id="joinSessionId" placeholder="Enter session ID from Game Master">
        </div>
        <button class="btn full" id="btnDeploy" onclick="registerPlayer()">Deploy Agent</button>
      </div>
    </div>

    <!-- Player Profile -->
    <div id="playerProfile" class="hidden">
      <div class="dossier">
        <div class="codename" id="playerCodename">LOADING...</div>
        <div class="dossier-field"><span class="field-label">Agent Name:</span><span class="field-value" id="realName">-</span></div>
        <div class="dossier-field"><span class="field-label">Agent ID:</span>
          <span class="field-value"><span id="playerIdText">-</span>
            <button class="btn btn-secondary" style="padding:6px 10px;margin-left:8px;font-size:.85em" onclick="copyPlayerId()">Copy</button>
          </span>
        </div>
        <div class="dossier-field"><span class="field-label">Cover Identity:</span><span class="field-value" id="coverIdentity">-</span></div>
        <div class="dossier-field"><span class="field-label">Background:</span><span class="field-value" id="background">-</span></div>
        <div class="dossier-field"><span class="field-label">Discharge:</span><span class="field-value" id="discharge">-</span></div>

        <div class="secret-section">
          <div class="field-label">Mission Objective:</div>
          <div class="field-value" id="secret">-</div>
        </div>

        <div class="dossier-field"><span class="field-label">Behavioral Quirk:</span><span class="field-value" id="oddity">-</span></div>
        <div class="dossier-field"><span class="field-label">Perks:</span><span class="field-value" id="perkList">-</span></div>
        <div class="dossier-field"><span class="field-label">Con:</span><span class="field-value" id="conText">-</span></div>
      </div>

      <!-- Role Assignment -->
      <div class="intel-panel" id="rolePanel">
        <h4>üéØ OPERATIONAL ROLE</h4>
        <div id="roleDescription">Classified pending mission briefing...</div>
        <div id="roleObjective"></div>
      </div>

      <!-- Murderer Secret -->
      <div id="murdererPanel" class="intel-panel hidden">
        <h4>‚ò†Ô∏è SECRET DIRECTIVE (Murderer)</h4>
        <div id="murdererDirective"></div>
      </div>

      <!-- Ability (always visible now) -->
      <div class="perk-box" id="abilityBox">
        <h4>‚ö° SPECIAL ABILITY</h4>
        <div id="abilityDescription">‚Äî</div>
        <span id="abilityStatus" class="status-badge status-ready">READY</span>
        <div class="grid grid-3" style="margin-top:10px">
          <div>
            <label class="small">Target (optional)</label>
            <select id="abilityTargetSelect"></select>
          </div>
          <div>
            <label class="small">‚Ä¶or type Agent ID</label>
            <input type="text" id="abilityTargetId" placeholder="agent_xxx">
          </div>
          <div style="align-self:end">
            <button class="btn" id="btnUseAbility" onclick="useAbility()">Use Ability</button>
          </div>
        </div>
      </div>

      <!-- Public Roster -->
      <div class="intel-panel">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h4>üóÇÔ∏è Public Roster (Basic bios + perks/quirks/cons)</h4>
          <button class="btn btn-secondary" id="btnRefreshRoster" onclick="renderRoster()">Refresh</button>
        </div>
        <div id="rosterList"></div>
      </div>

      <!-- Action Submission -->
      <div class="intel-panel">
        <h4>üìù Submit Action / Penalty / Task</h4>
        <div class="grid grid-3">
          <div>
            <label>Action Type</label>
            <select id="actionType">
              <option value="penalty">Report Penalty</option>
              <option value="task_complete">Complete Task</option>
              <option value="murderer_act">Report Murderer Act</option>
              <option value="use_ability">Use Ability (also above)</option>
            </select>
          </div>
          <div>
            <label>Target Player</label>
            <select id="actionTarget"></select>
          </div>
          <div>
            <label>Details</label>
            <input type="text" id="actionDetails" placeholder="What happened / instructions"/>
          </div>
        </div>
        <div class="grid" style="margin-top:10px">
          <button class="btn" id="btnSubmitAction" onclick="submitAction()">Submit</button>
        </div>
      </div>

      <!-- Challenge System -->
      <div class="intel-panel">
        <div class="challenge-header" style="color:#ffa500;font-weight:bold;margin-bottom:8px">üìã ACTIVE MISSION</div>
        <div id="challengeText">No active mission. Request new assignment below.</div>
        <div class="progress-bar"><div class="progress-fill" id="challengeProgress" style="width: 0%"></div></div>
        <div id="challengeReward" class="intel-panel hidden" style="margin-top:10px"><strong>Mission Reward:</strong> <span id="rewardText"></span></div>
        <div class="grid grid-2" style="margin-top:10px">
          <button class="btn btn-secondary" id="btnDrawChallenge" onclick="drawChallenge()">Request Mission</button>
          <button class="btn" id="completeBtn" onclick="completeChallenge()" disabled>Complete Mission</button>
        </div>
      </div>

      <!-- Scanner (Final Night Only) -->
      <div class="scanner-section" id="scannerBlock">
        <h4>üîç OPERATIVE SCANNER (Unlocks Final Night)</h4>
        <div id="scanGateNotice" class="small muted"></div>
        <div class="grid grid-3" style="margin-top:8px">
          <div>
            <label>Target (select)</label>
            <select id="scanSelect"></select>
          </div>
          <div>
            <label>‚Ä¶or type Agent ID</label>
            <input type="text" id="scanInput" placeholder="agent_xxx">
          </div>
          <div style="align-self:end" class="grid">
            <button class="btn btn-secondary" id="btnScan" onclick="scanAgent()">Scan Target</button>
            <button class="btn btn-danger" id="btnAccuse" onclick="accuseAgent()">Make Accusation</button>
          </div>
        </div>
      </div>

      <!-- Final Vote -->
      <div class="vote-section" id="finalVote" style="display:none;">
        <h3>üó≥Ô∏è FINAL JUDGMENT</h3>
        <p>The moment of truth has arrived. Who is the traitor among us?</p>
        <select id="suspectSelect"><option value="">Select your suspect...</option></select>
        <div class="grid" style="margin-top:10px"><button class="btn btn-danger" id="btnVote" onclick="castFinalVote()">Cast Vote</button></div>
      </div>

      <!-- Inbox for targeted actions -->
      <div class="intel-panel">
        <h4>üì® Your Inbox</h4>
        <div id="inboxList" class="small"></div>
      </div>

      <!-- Game Log -->
      <div class="game-log" id="gameLog">
        <strong>üì° OPERATION LOG</strong>
        <div class="log-entry">Agent deployment initiated. Secure channels established.</div>
      </div>

      <!-- Timers -->
      <div class="intel-panel">
        <div id="timers" class="small"></div>
      </div>
    </div>
  </div>

<script>
/* ===================== UTIL ===================== */
const byId = id=>document.getElementById(id);
const now = ()=>Date.now();
const safe = v => (v===undefined||v===null)?'':String(v);
const toTs = v => { if(!v) return null; const t=new Date(v); const n=t.getTime(); return Number.isFinite(n)?n:null; };
const fmtTime = ts => ts? new Date(ts).toLocaleString() : '‚Äî';

function addToLog(message){
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry';
  logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
  const log = byId('gameLog'); if(log){ log.appendChild(logEntry); log.scrollTop = log.scrollHeight; }
  gameState.gameLog.push({timestamp,message});
  saveGameState();
}

function pushInbox(playerId, msg){
  if(!gameState.playerMessages[playerId]) gameState.playerMessages[playerId]=[];
  gameState.playerMessages[playerId].push({...msg, ts: now()});
}

function renderInbox(){
  const list = byId('inboxList');
  if(!list) return;
  const cp = gameState.currentPlayer?.id;
  const msgs = cp ? (gameState.playerMessages[cp]||[]) : [];
  if(!msgs.length){ list.innerHTML = '<div class="muted">No messages yet.</div>'; return; }
  list.innerHTML = msgs.slice().reverse().map(m=>{
    const when = new Date(m.ts).toLocaleTimeString();
    return `<div class="roster-card"><div class="small">${when} ‚Äî <strong>${m.type}</strong> from ${m.from}</div><div>${m.text}</div></div>`;
  }).join('');
}

/* ===================== STATE ===================== */
let gameState = {
  sessionId:'',
  players:[],
  currentPlayer:null,
  gamePhase:'setup',
  masterPlayer:null,
  rolePool:[],
  challengesCompleted:{},
  scanHistory:[],
  votes:{},
  gameLog:[],
  accusations:[],
  finalNightAt:null,
  gameEndsAt:null,
  murderer:null,
  playerMessages:{},
  lastPlayerId:null
};

function saveGameState(){
  if(gameState.sessionId){
    try{
      localStorage.setItem(`game_${gameState.sessionId}`, JSON.stringify(gameState));
      localStorage.setItem(`current_${gameState.sessionId}`, gameState.currentPlayer?.id || '');
    }catch(e){ console.warn('Save error:', e); }
  }
}

function loadGameState(){
  const params = new URLSearchParams(location.search);
  const sessionId = params.get('session');
  const playerParam = params.get('player');
  if(!sessionId) return;
  try{
    const saved = localStorage.getItem(`game_${sessionId}`);
    if(saved){
      gameState = JSON.parse(saved);
      // choose player: URL param first, else lastPlayerId
      const last = playerParam || localStorage.getItem(`current_${sessionId}`) || gameState.lastPlayerId;
      const player = (last && gameState.players.find(p=>p.id===last)) || null;
      if(player){
        gameState.currentPlayer = player;
        showProfile();
      }else{
        byId('onboarding').classList.remove('hidden');
        byId('gameSetup').classList.add('hidden');
        byId('joinSessionId').value = sessionId;
      }
      updateFinalNightGate();
      startTickers();
    }
  }catch(e){ console.warn('Load error:', e); }
}

/* ===================== ROLES & DATA ===================== */
const roles = {
  flipped_agent:{ name:"The Flipped Agent", objective:"Stay hidden while sowing chaos. Frame others or recruit allies.", winCondition:"Survive final vote OR flip another player" },
  handler:{ name:"The Handler", objective:"Identify the traitor through investigation and deduction.", winCondition:"Correctly identify Flipped Agent in final vote" },
  wildcard:{ name:"The Wildcard", objective:"Survive and adapt. Can align with either side.", winCondition:"Align with winning side OR complete solo objectives" },
  innocent:{ name:"Innocent Operative", objective:"Identify the traitor and survive the final vote.", winCondition:"Vote out Flipped Agent OR survive to the end" }
};

const characterDatabase = [
  { id:"lacehunter", codename:"LACEHUNTER", cover:"Luxury Skiwear Designer",
    background:"Former French AF comms ‚Üí NATO PSYOPS 'tactical glam technician'",
    discharge:"Non-disciplinary separation after morale incident involving glitter & thermals",
    secret:"Hunt your ghoster; gather three clues from the group",
    oddity:"Silk cravat; lip balm mid-sentence; calls everyone 'Lieutenant Thirsttrap'",
    perks:[
      "Honorific Lock: must be addressed as ‚ÄúMonsieur Val‚Äù (slip = penalty).",
      "Style Verdict: on ‚ÄúRunway check,‚Äù target holds a 10-sec pose."
    ],
    con:"If he catches his reflection nearby he must stop & preen for 3s; interruptions force a whispered 'couture' restart.",
    ability:{ id:"fashion_emergency", name:"Fashion Emergency", desc:"Force any two players to swap one visible clothing item immediately.", uses:1 }
  },
  { id:"snowblind", codename:"SNOWBLIND", cover:"Extreme Sports Photographer",
    background:"RFMF Recon tracker (Fiji). Finds rumour and happy hour with equal precision.",
    discharge:"Honourable; refused to track an innocent defector (his brother)",
    secret:"Collect 3 strangers‚Äô hometown slang; compile a 'tracking lexicon'",
    oddity:"Whispers intel like classified comms; ends with ‚Äúcopy?‚Äù",
    perks:[
      "Breadcrumb Command: choose a trigger word; speakers owe a clue or take penalty for 10 min.",
      "Switchback: say ‚ÄúFirst tracks‚Äù ‚Üí everyone rotates seats; last seated owes you a favour."
    ],
    con:"If someone says 'family'/'ohana', he must deliver a 1-sentence heartfelt lesson.",
    ability:{ id:"hire_tail", name:"Hire a Tail", desc:"Recruit one player to shadow you 10‚Äì30 min; deliver intel every 5 min or take penalties.", uses:1 }
  },
  { id:"frostbite", codename:"FROSTBITE", cover:"Adventure Safety Coordinator",
    background:"Polish GROM cold-weather & interrogation specialist.",
    discharge:"Honourable; 'cultural differences' with interrogation methods",
    secret:"Convince a stranger to wear your gloves for 'evidence preservation' and pose like a crime scene silhouette",
    oddity:"Over-enunciates like a radio check; numbers in NATO phonetic",
    perks:[
      "Interrogator‚Äôs Pause: on 'Answer the question,' target must reply in ‚â§5 words.",
      "Cold Protocol: greetings become fist-bump only until cleared."
    ],
    con:"When asked 'what's the plan?' must produce a checklist or salute and declare 'I am improvising.'",
    ability:{ id:"coerce_asset", name:"Coerce an Asset", desc:"Designate a player your Asset for 15 min; complete 2 simple tasks or take penalties.", uses:1 }
  },
  { id:"blackrun", codename:"BLACKRUN", cover:"Avalanche Risk Specialist",
    background:"Indian Para (SF) mountain warfare; predicts social disasters too.",
    discharge:"Medical; survived the avalanche that ended her unit",
    secret:"Run a spontaneous 'safety briefing' with strangers; redistribute props that must be worn",
    oddity:"Adds 'allegedly' to any claim when alcohol is present",
    perks:[
      "Beacon Check: on call, all phones face-down 5 min; touching = penalty.",
      "Disaster Brief: two table taps resets topic & picks next speaker."
    ],
    con:"On triangles/angles she must estimate degrees aloud; off by >10¬∞ ‚Üí sketch a napkin protractor.",
    ability:{ id:"avalanche_protocol", name:"Avalanche Protocol", desc:"Clap twice: 30-sec evac drill. Everyone swaps seats & surrenders a small item; you redistribute.", uses:1 }
  },
  { id:"powder_keg", codename:"POWDER KEG", cover:"Luxury Lodge Event Coordinator",
    background:"Spanish social engineer who pairs diplomacy with drama.",
    discharge:"Dishonourable‚Äîran weapons through receptions.",
    secret:"Get a stranger to announce you as 'Her Excellency the Ambassador of Apr√®s'",
    oddity:"Refuses real names; assigns everyone a callsign",
    perks:[
      "VIP Gate: others must introduce you with a grand invented title (miss = penalty).",
      "Guest List: say 'You‚Äôre on the list' ‚Üí 2-min private chat to assign a micro-task."
    ],
    con:"On any rumour she must add 'exclusive source' + wink; if asked 'source?' later she must confess 'It was me.'",
    ability:{ id:"task_mark", name:"Task the Mark", desc:"Nominate any player to get a phone #, key/card, or selfie with anyone within 20 min. Failure = penalty.", uses:1 }
  },
  { id:"icepick", codename:"ICEPICK", cover:"Artisanal Spirits Consultant",
    background:"Ex-Spetsnaz interrogator; defected (or didn‚Äôt).",
    discharge:"'Defected' during the Sochi Olympics‚Äîallegedly",
    secret:"Learn a new vodka toast and perform it with the group",
    oddity:"Answers 'roger' instead of 'yes' and ends sentences with 'over.'",
    perks:[
      "Cold Stare: on eye contact, the other must break first or penalty.",
      "Vodka Toast Override: on 'Na zdorovye,' all must toast with alcohol; no drink ‚Üí 30s to get some or penalty."
    ],
    con:"When a new person arrives, he must pat pockets 'ID, keys, exit‚Äîroger'; if caught skipping ‚Üí 10-sec bug sweep.",
    ability:{ id:"charm_offensive", name:"Charm Offensive (vodka-only)", desc:"Before midnight compel 3 people to buy you vodka drinks. Refusal/wrong drink = penalty.", uses:1 }
  }
];

const murdererActs = [
  "Leave one coaster upside-down at a table you visit.",
  "Say the word 'almond' twice in different conversations.",
  "Touch the back of a chair before sitting, every time.",
  "Hum two short notes before speaking, at least three times.",
  "Place a napkin folded into a triangle at a random spot.",
  "Tap the table twice with your index finger before drinking."
];

/* ===================== INIT / GM ===================== */
function assignRoles(playerCount){
  let pool=[];
  if(playerCount<=3) pool=['flipped_agent','handler','wildcard'];
  else if(playerCount===4) pool=['flipped_agent','handler','wildcard','wildcard'];
  else if(playerCount===5) pool=['flipped_agent','handler','wildcard','wildcard','innocent'];
  else if(playerCount===6) pool=['flipped_agent','handler','wildcard','wildcard','innocent','innocent'];
  else pool = Array.from({length:playerCount}, (_,i)=> i===0?'flipped_agent': (i%3?'wildcard':'innocent'));
  gameState.rolePool = pool.sort(()=>Math.random()-0.5);
  addToLog(`üéØ Roles prepared for ${pool.length} operatives`);
}

function maybeAssignMurderer(){
  if(gameState.murderer || gameState.players.length<3) return;
  const pick = gameState.players[Math.floor(Math.random()*gameState.players.length)];
  const act  = murdererActs[Math.floor(Math.random()*murdererActs.length)];
  gameState.murderer = { id: pick.id, act, performedDates:[] };
  addToLog('‚ò†Ô∏è A secret murderer has been assigned.');
  saveGameState();
}

function initializeGame(){
  try{
    const sessionId = safe(byId('sessionId').value).trim();
    const playerCount = parseInt(byId('playerCount').value,10)||3;
    if(!sessionId){ alert('Please enter a session ID'); return; }
    gameState.sessionId = sessionId;
    gameState.gamePhase = 'setup';
    gameState.masterPlayer = 'gm_' + Math.random().toString(36).slice(2,11);
    gameState.players = [];
    gameState.playerMessages = {};
    gameState.murderer = null;
    gameState.lastPlayerId = null;
    gameState.finalNightAt = toTs(byId('finalNightAt').value);
    gameState.gameEndsAt   = toTs(byId('gameEndsAt').value);
    assignRoles(playerCount);
    byId('gameSetup').classList.add('hidden');
    byId('onboarding').classList.remove('hidden');
    saveGameState();
    addToLog(`üéÆ New game ${sessionId} for up to ${playerCount} players`);
    if(gameState.finalNightAt) addToLog(`üïõ Final Night: ${fmtTime(gameState.finalNightAt)}`);
    if(gameState.gameEndsAt) addToLog(`üèÅ Ends: ${fmtTime(gameState.gameEndsAt)}`);
    updateFinalNightGate(); startTickers();
  }catch(err){ addToLog(`‚ùå Init error: ${err.message||err}`); }
}

function loadExistingGame(){
  const sessionId = safe(byId('sessionId').value).trim();
  if(!sessionId){ alert('Please enter a session ID'); return; }
  const saved = localStorage.getItem(`game_${sessionId}`);
  if(!saved){ alert('Session not found'); return; }
  gameState = JSON.parse(saved);
  byId('gameSetup').classList.add('hidden');
  byId('onboarding').classList.remove('hidden');
  addToLog(`üì° Loaded session ${sessionId}`);
  updateFinalNightGate(); startTickers();
}

/* ===================== PLAYER JOIN ===================== */
function registerPlayer(){
  try{
    const playerName = safe(byId('playerName').value).trim();
    const sessionId = safe(byId('joinSessionId').value).trim();
    if(!playerName || !sessionId){ alert('Enter your name and session ID'); return; }
    if(!gameState.sessionId || gameState.sessionId!==sessionId){
      const saved = localStorage.getItem(`game_${sessionId}`);
      if(saved) gameState = JSON.parse(saved);
      else { alert('Session not found. Initialize first.'); return; }
    }
    if(gameState.players.length >= gameState.rolePool.length){ alert('Session is full'); return; }
    const playerId = 'agent_' + Math.random().toString(36).slice(2,11);
    const available = characterDatabase.filter(c=> !gameState.players.some(p=>p.characterId===c.id));
    if(!available.length){ alert('No more characters available'); return; }
    const character = available[Math.floor(Math.random()*available.length)];
    const roleIndex = gameState.players.length;
    const assignedRole = gameState.rolePool[roleIndex] || 'innocent';
    const player = {
      id: playerId, realName: playerName, characterId: character.id,
      codename: character.codename, cover: character.cover,
      background: character.background, discharge: character.discharge,
      secret: character.secret, oddity: character.oddity,
      perks: character.perks||[], con: character.con||'',
      role: assignedRole, ability: {...character.ability},
      challengesCompleted:0, completedChallenges:[], activeChallenge:null,
      abilityUsed:false, scanCount:0, isRevealed:false
    };
    deployPlayer(player);
  }catch(err){ addToLog(`‚ùå Register error: ${err.message||err}`); }
}

function deployPlayer(player){
  gameState.currentPlayer = player;
  gameState.players.push(player);
  if(!gameState.playerMessages[player.id]) gameState.playerMessages[player.id]=[];
  gameState.lastPlayerId = player.id;
  saveGameState();
  showProfile();
  maybeAssignMurderer();
  addToLog(`üöÅ Agent ${player.codename} (${player.realName}) deployed`);
}

function showProfile(){
  byId('onboarding').classList.add('hidden');
  byId('playerProfile').classList.remove('hidden');
  displayPlayerProfile(gameState.currentPlayer);
  populateSelectors();
  renderRoster();
  renderInbox();
  revealMurdererIfMe();
  updateFinalNightGate();
  startTickers();
}

function displayPlayerProfile(player){
  // Guard all DOM references to avoid null crashes
  const set = (id, val)=>{ const el=byId(id); if(el) el.textContent = val; };
  set('playerCodename', player.codename);
  set('realName', player.realName);
  set('playerIdText', player.id);
  set('coverIdentity', player.cover);
  set('background', player.background);
  set('discharge', player.discharge);
  set('secret', player.secret);
  set('oddity', player.oddity);
  const perkEl = byId('perkList'); if(perkEl){ perkEl.innerHTML = player.perks?.length? `<ul>${player.perks.map(p=>`<li>${p}</li>`).join('')}</ul>` : '‚Äî'; }
  set('conText', player.con || '‚Äî');

  const roleInfo = roles[player.role] || { name:'Innocent Operative', objective:'Survive & complete personal objectives', winCondition:'Stay alive and avoid suspicion' };
  const rd = byId('roleDescription'); if(rd) rd.innerHTML = `<strong>${roleInfo.name}</strong><br>${roleInfo.objective}`;
  const ro = byId('roleObjective');   if(ro) ro.innerHTML = `<strong>Victory Condition:</strong> ${roleInfo.winCondition}`;

  const ad = byId('abilityDescription'); if(ad) ad.textContent = player.ability?.desc || '‚Äî';

  // Ability status
  const as = byId('abilityStatus');
  if(as){ as.className = 'status-badge ' + (player.abilityUsed?'status-used':'status-ready'); as.textContent = player.abilityUsed?'USED':'READY'; }

  updateChallengeProgress();
}

function revealMurdererIfMe(){
  const me = gameState.currentPlayer;
  const panel = byId('murdererPanel');
  if(!panel) return;
  if(gameState.murderer && me && me.id===gameState.murderer.id){
    panel.classList.remove('hidden');
    const md = byId('murdererDirective'); if(md) md.textContent = `Each day perform the act without being caught: ${gameState.murderer.act}`;
  }else{
    panel.classList.add('hidden');
  }
}

/* ===================== SELECTS & ROSTER ===================== */
function populateSelectors(){
  const others = gameState.players.filter(p=> !gameState.currentPlayer || p.id!==gameState.currentPlayer.id);
  const fill = (selId, allowSelf=false)=>{
    const sel = byId(selId); if(!sel) return;
    sel.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
    const list = allowSelf? gameState.players : others;
    list.forEach(p=>{
      const o=document.createElement('option');
      o.value=p.id; o.textContent=`${p.codename} (${p.realName})`;
      sel.appendChild(o);
    });
  };
  fill('abilityTargetSelect');      // others
  fill('actionTarget');             // others
  fill('scanSelect');               // others
  const sus = byId('suspectSelect');
  if(sus){
    sus.innerHTML = '<option value="">Select your suspect...</option>';
    others.forEach(p=>{
      const o=document.createElement('option');
      o.value=p.id; o.textContent=`${p.codename} (${p.realName})`;
      sus.appendChild(o);
    });
  }
}

function renderRoster(){
  const container = byId('rosterList'); if(!container) return;
  if(!gameState.players.length){ container.innerHTML = '<div class="muted">No agents yet.</div>'; return; }
  container.innerHTML = gameState.players.map(p=>{
    const perks = (p.perks||[]).map(x=>`<li>${x}</li>`).join('') || '<li>‚Äî</li>';
    return `
      <div class="roster-card">
        <div class="flex" style="justify-content:space-between">
          <div><strong>${p.codename}</strong> ‚Äî ${p.realName}</div>
          <div class="small muted">${p.id}</div>
        </div>
        <div class="small">${p.cover}</div>
        <div class="grid grid-3" style="margin-top:8px">
          <div><strong>Quirk:</strong><br>${p.oddity}</div>
          <div><strong>Con:</strong><br>${p.con||'‚Äî'}</div>
          <div><strong>Perks:</strong><ul>${perks}</ul></div>
        </div>
      </div>
    `;
  }).join('');
}

/* ===================== ABILITY & ACTIONS ===================== */
function playerById(id){ return gameState.players.find(p=>p.id===id); }

function useAbility(){
  const me = gameState.currentPlayer; if(!me?.ability) return;
  if(me.abilityUsed){ addToLog('‚ö†Ô∏è Ability already used'); return; }
  const selId = byId('abilityTargetSelect')?.value || '';
  const typed = safe(byId('abilityTargetId')?.value).trim();
  const target = playerById(selId || typed);
  const tLabel = target ? `${target.codename} (${target.realName})` : '‚Äî';
  me.abilityUsed = true;
  const as = byId('abilityStatus'); if(as){ as.className='status-badge status-used'; as.textContent='USED'; }
  addToLog(`‚ö° ${me.codename} used "${me.ability.name}" on ${tLabel}`);
  if(target){
    pushInbox(target.id, { from: me.codename, type:'Ability', text:`"${me.ability.name}": ${me.ability.desc}` });
  }
  saveGameState();
  renderInbox();
}

function titleFor(t){
  return t==='penalty'?'Penalty':
         t==='task_complete'?'Task Complete':
         t==='murderer_act'?'Murderer Act':
         'Ability';
}
function labelFor(id){
  const p = playerById(id);
  return p? `${p.codename} (${p.realName})` : (id||'‚Äî');
}

function submitAction(){
  const me = gameState.currentPlayer; if(!me) return;
  const type = byId('actionType').value;
  const target = byId('actionTarget').value;
  const details = safe(byId('actionDetails').value).trim() || '(no details)';
  let text = '';
  if(type==='penalty') text = `Penalty on ${labelFor(target)} ‚Äî ${details}`;
  else if(type==='task_complete') text = `Task complete by ${me.codename} ‚Äî ${details}`;
  else if(type==='murderer_act') text = `Murderer act report by ${me.codename} ‚Äî ${details}`;
  else if(type==='use_ability') text = `Ability use on ${labelFor(target)} ‚Äî ${details}`;
  addToLog(`üìù ${text}`);
  if(target) pushInbox(target, { from: me.codename, type: titleFor(type), text: details });
  saveGameState();
  renderInbox();
  byId('actionDetails').value=''; byId('actionTarget').value='';
}

/* ===================== CHALLENGES ===================== */
const challenges = [
  { id:"goggle_dinner", text:"Wear ski goggles to dinner; never explain why", reward:"Perk refresh + basic intel" },
  { id:"tactical_drinking", text:"Shotgun beer if called out for saying 'tactical'", reward:"Scan immunity for 2 hours" },
  { id:"cia_inquiry", text:"Ask 3 strangers where the CIA safehouse is", reward:"Learn one player's role type" },
  { id:"snowball_diplomacy", text:"Challenge someone to snowball duel; loser does shoey", reward:"Force challenge redraw" },
  { id:"mystery_artifact", text:"Bring random item to bar; convince stranger it's priceless", reward:"Bonus ability usage" },
  { id:"room_recon", text:"Gain legitimate access to someone else's room for 15 min", reward:"Deep scan ability" },
  { id:"accent_acquisition", text:"Speak only in fake Russian accent for 3 hours", reward:"Counter-intel for 24h" },
  { id:"fashion_police", text:"Critique outfits using military terminology", reward:"Learn Coil intel fragment" },
  { id:"surveillance_photo", text:"Take candid photo of each player undetected", reward:"Identity protection" },
  { id:"loyalty_test", text:"Get someone to break a minor rule for you", reward:"Recruitment ability" }
];

function drawChallenge(){
  const me = gameState.currentPlayer;
  if(!me){ alert('No player active'); return; }
  if(me.challengesCompleted>=10){ alert('Max 10/10'); return; }
  const available = challenges.filter(c=> !(me.completedChallenges||[]).includes(c.id));
  if(!available.length){ alert('No more challenges'); return; }
  const ch = available[Math.floor(Math.random()*available.length)];
  me.activeChallenge = ch;
  byId('challengeText').textContent = ch.text;
  byId('rewardText').textContent = ch.reward;
  byId('challengeReward').classList.remove('hidden');
  byId('completeBtn').disabled = false;
  saveGameState();
  addToLog(`üìã New mission: "${ch.text.substring(0,60)}..."`);
}

function completeChallenge(){
  const me = gameState.currentPlayer; if(!me?.activeChallenge) return;
  const ch = me.activeChallenge;
  me.challengesCompleted++;
  if(!me.completedChallenges) me.completedChallenges=[];
  me.completedChallenges.push(ch.id);
  me.activeChallenge = null;
  processReward(ch);
  byId('challengeText').textContent = 'Mission completed! Request new assignment when ready.';
  byId('completeBtn').disabled = true;
  byId('challengeReward').classList.add('hidden');
  updateChallengeProgress();
  saveGameState();
  addToLog(`‚úÖ Mission "${ch.text.substring(0,40)}..." completed`);
}

function processReward(ch){
  const count = gameState.currentPlayer.challengesCompleted;
  let reward = ch.reward;
  if(count===1) reward='Intel: "Someone is not who they claim to be"';
  else if(count===3){ reward='Scan immunity for 24h'; gameState.currentPlayer.scanImmunity = now()+24*60*60*1000; }
  else if(count===5){ reward='Deep intel: role distribution'; showRoleDistribution(); }
  else if(count===7){ reward='Nuclear option unlocked'; gameState.currentPlayer.nuclearAccess=true; }
  addToLog(`üèÜ Reward: ${reward}`);
}

function updateChallengeProgress(){
  const me = gameState.currentPlayer; if(!me) return;
  const count = me.challengesCompleted;
  byId('challengeCount').textContent = count;
  byId('challengeProgress').style.width = `${(count/10)*100}%`;
  let level='Basic'; if(count>=7) level='Maximum'; else if(count>=5) level='Advanced'; else if(count>=3) level='Intermediate';
  byId('intelLevel').textContent = level;
}

function showRoleDistribution(){
  const roleCount = {};
  gameState.rolePool.forEach(r=> roleCount[r]=(roleCount[r]||0)+1 );
  const text = Object.entries(roleCount).map(([r,c])=>{
    const name = roles[r]?.name||r; return `‚Ä¢ ${name}: ${c}`;
  }).join('\n');
  addToLog(`üìä Role Distribution:\n${text}`);
}

/* ===================== SCAN / ACCUSE (Final Night only) ===================== */
function getRandomPsychProfile(){
  const a=['High stress','Deceptive patterns','Loyalty normal','Paranoia elevated','Combat ready','Trust compromised'];
  return a[Math.floor(Math.random()*a.length)];
}
function performScan(target){
  const lines = [
    `Quirk check: ${target.oddity}`,
    `Challenge status: ${target.challengesCompleted>0 ? 'Active recently' : 'No recent activity'}`,
    `Behavioral read: ${target.role==='flipped_agent' ? 'deceptive cues' : 'standard stress markers'}`,
    `Equipment: carrying ${Math.floor(Math.random()*5)+1} suspicious items`,
    `Comms: ${target.role==='handler' ? 'encrypted chatter' : 'normal traffic'}`,
    `Psyche: ${getRandomPsychProfile()}`
  ];
  return lines[Math.floor(Math.random()*lines.length)];
}

function scanAgent(){
  if(!finalNightOpen()){ addToLog('‚õî Scans locked until Final Night'); return; }
  const me = gameState.currentPlayer;
  const sel = byId('scanSelect')?.value || '';
  const typed = safe(byId('scanInput')?.value).trim();
  const target = playerById(sel || typed);
  if(!target){ alert('Pick a target or type an Agent ID'); return; }
  if(gameState.scanHistory.some(s=> s.scanner===me.id && s.target===target.id)){
    addToLog(`‚ö†Ô∏è Already scanned ${target.codename}`); return;
  }
  const result = performScan(target);
  gameState.scanHistory.push({ scanner: me.id, target: target.id, timestamp: now(), result });
  addToLog(`üîç Scanned ${target.codename}: ${result}`);
  saveGameState();
}

function accuseAgent(){
  if(!finalNightOpen()){ addToLog('‚õî Accusations locked until Final Night'); return; }
  const me = gameState.currentPlayer;
  const sel = byId('scanSelect')?.value || '';
  const typed = safe(byId('scanInput')?.value).trim();
  const target = playerById(sel || typed);
  if(!target){ alert('Pick a target or type an Agent ID'); return; }
  if(!confirm(`Accuse ${target.codename}? This cannot be undone.`)) return;
  gameState.accusations.push({ accuser: me.id, accused: target.id, timestamp: now() });
  addToLog(`üö® FORMAL ACCUSATION: ${me.codename} ‚Üí ${target.codename}`);
  saveGameState();
  if(gameState.accusations.length >= Math.floor(gameState.players.length/2)) triggerFinalVote();
}

function triggerFinalVote(){
  gameState.gamePhase='voting';
  const v = byId('finalVote'); if(v) v.style.display='block';
  const sel = byId('suspectSelect');
  if(sel){
    sel.innerHTML='<option value="">Select your suspect...</option>';
    gameState.players.forEach(p=>{
      if(p.id!==gameState.currentPlayer.id){
        const o=document.createElement('option');
        o.value=p.id; o.textContent=`${p.codename} (${p.realName})`;
        sel.appendChild(o);
      }
    });
  }
  addToLog('üó≥Ô∏è FINAL VOTE INITIATED');
}

function castFinalVote(){
  const suspectId = byId('suspectSelect').value;
  if(!suspectId){ alert('Select a suspect'); return; }
  const me = gameState.currentPlayer;
  gameState.votes[me.id] = suspectId;
  const suspect = playerById(suspectId);
  addToLog(`üó≥Ô∏è Vote cast by ${me.codename} ‚Üí ${suspect.codename}`);
  byId('finalVote').innerHTML = '<h3>Vote Submitted</h3><p>Awaiting results from other operatives...</p>';
  saveGameState();
}

/* ===================== TIME GATES ===================== */
function finalNightOpen(){ return gameState.finalNightAt && now() >= gameState.finalNightAt; }
function updateFinalNightGate(){
  const gate = byId('scannerBlock'), note = byId('scanGateNotice');
  if(!gate || !note) return;
  if(!gameState.finalNightAt){
    gate.classList.remove('hidden');
    note.textContent='Set a Final Night time in GM controls to gate scanning/accusations.';
    Array.from(gate.querySelectorAll('button,input,select')).forEach(el=> el.disabled = true);
    return;
  }
  const open = finalNightOpen();
  gate.style.opacity = open ? '1' : '.5';
  Array.from(gate.querySelectorAll('button,input,select')).forEach(el=> el.disabled = !open);
  note.textContent = open ? '‚úÖ Scans & accusations are UNLOCKED.' : `üîí Locked until Final Night: ${fmtTime(gameState.finalNightAt)}`;
  const tDiv = byId('timers');
  const ends = gameState.gameEndsAt ? ` | Ends: ${fmtTime(gameState.gameEndsAt)}` : '';
  if(tDiv) tDiv.textContent = `Final Night: ${fmtTime(gameState.finalNightAt)}${ends}`;
}
let tickerHandle=null;
function startTickers(){
  if(tickerHandle) clearInterval(tickerHandle);
  tickerHandle = setInterval(()=>{ updateFinalNightGate(); renderInbox(); }, 15000);
}

/* ===================== MISC ===================== */
function copyPlayerId(){
  const id = byId('playerIdText')?.textContent?.trim(); if(!id) return;
  navigator.clipboard.writeText(id).then(()=>addToLog('üìã Player ID copied'));
}

/* ===================== DEBUG & EXPOSE ===================== */
function debugGameState(){ console.log('Game State:', gameState); return gameState; }
function resetGame(){
  if(confirm('Reset the entire game?')){
    const sid = gameState.sessionId;
    if(sid) localStorage.removeItem(`game_${sid}`);
    location.href = location.pathname;
  }
}
window.gameDebug = { state:()=>gameState, reset:resetGame, addLog:addToLog, triggerVote:triggerFinalVote };

Object.assign(window, {
  initializeGame, loadExistingGame, registerPlayer,
  drawChallenge, completeChallenge,
  useAbility, submitAction,
  scanAgent, accuseAgent, castFinalVote,
  renderRoster, debugGameState, copyPlayerId
});

/* ===================== BOOT ===================== */
document.addEventListener('DOMContentLoaded', ()=>{
  const bind = (id, fn)=>{ const el = byId(id); if(el) el.addEventListener('click', (e)=>{ e.preventDefault?.(); fn(); }); };
  bind('btnInit', initializeGame);
  bind('btnLoad', loadExistingGame);
  // URL-based autoload
  loadGameState();
  // Demo helper
  if(!gameState.sessionId && location.search.includes('demo')){
    byId('sessionId').value = 'DEMO_' + Math.random().toString(36).slice(2,8);
    byId('playerCount').value = '6';
  }
  console.log('DOM ready.');
});
</script>
</body>
</html>
