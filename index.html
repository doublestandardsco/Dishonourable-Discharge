<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dishonourable Discharge</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Courier New',monospace;background:linear-gradient(135deg,#0a0a0a,#1a1a2e,#16213e);color:#e0e0e0;min-height:100vh;padding:10px;overflow-x:hidden}
    .container{max-width:900px;margin:0 auto;background:rgba(0,0,0,0.9);border:2px solid #ff4757;border-radius:15px;padding:25px;box-shadow:0 0 40px rgba(255,71,87,.3);backdrop-filter:blur(10px);position:relative}
    .classified-stamp{position:absolute;top:20px;right:20px;background:#ff4757;color:#000;padding:8px 15px;transform:rotate(15deg);font-weight:bold;font-size:.9em;border:3px solid #000}
    .header{text-align:center;margin-bottom:30px;border-bottom:3px solid #ff4757;padding-bottom:20px;position:relative}
    .header h1{color:#ff4757;font-size:2.6em;text-shadow:0 0 20px rgba(255,71,87,.8);margin-bottom:10px;letter-spacing:3px}
    .subtitle{color:#5f27cd;font-size:1.1em;font-style:italic;text-transform:uppercase;letter-spacing:1px}
    .section{margin-bottom:24px;padding:18px;background:rgba(255,255,255,.03);border-radius:10px;border-left:4px solid #5f27cd}
    .section-title{color:#ff4757;font-size:1.2em;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px}
    .form-group{margin-bottom:12px}
    label{display:block;margin-bottom:6px;color:#5f27cd;font-weight:bold;text-transform:uppercase;font-size:.85em}
    input[type="text"],input[type="datetime-local"],input[type="file"],select,textarea{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid #5f27cd;border-radius:8px;color:#e0e0e0;font-family:'Courier New',monospace;font-size:.95em}
    textarea{min-height:70px}
    input[type="file"]{padding:10px;border-style:dashed}
    .btn{background:linear-gradient(45deg,#ff4757,#ff6b7a);color:#000;border:none;padding:12px 16px;border-radius:8px;font-size:1em;font-weight:bold;cursor:pointer;transition:.25s;font-family:'Courier New',monospace;text-transform:uppercase;letter-spacing:1px}
    .btn.full{width:100%}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,71,87,.5)}
    .btn-secondary{background:linear-gradient(45deg,#5f27cd,#7c3aed);color:#fff}
    .btn-danger{background:linear-gradient(45deg,#ff3838,#ff6b6b)}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .dossier{background:linear-gradient(135deg,rgba(255,71,87,.1),rgba(95,39,205,.1));border:2px solid #ff4757;padding:16px;margin:16px 0;border-radius:12px;position:relative}
    .dossier::before{content:"CLASSIFIED";position:absolute;top:-10px;left:20px;background:#ff4757;color:#000;padding:4px 10px;font-size:.75em;font-weight:bold}
    .codename{color:#ff4757;font-size:1.6em;margin-bottom:10px;text-align:center;text-shadow:0 0 10px rgba(255,71,87,.5)}
    .dossier-field{margin-bottom:10px;display:flex;gap:10px;align-items:flex-start}
    .field-label{color:#5f27cd;font-weight:bold;min-width:140px;text-transform:uppercase;font-size:.85em}
    .field-value{color:#e0e0e0;flex:1;line-height:1.4}
    .secret-section{background:rgba(255,71,87,.1);border:2px solid #ff4757;border-radius:8px;padding:12px;margin:12px 0;position:relative}
    .secret-section::before{content:"üîí EYES ONLY";position:absolute;top:-10px;left:12px;background:#ff4757;color:#000;padding:3px 8px;font-size:.7em;font-weight:bold}
    .perk-box{background:linear-gradient(135deg,rgba(95,39,205,.2),rgba(116,185,255,.1));border:2px solid #5f27cd;border-radius:10px;padding:14px;margin:14px 0;text-align:center;position:relative}
    .perk-hidden{filter:blur(3px);cursor:pointer;transition:filter .3s}
    .perk-revealed{filter:none}
    .quirk-box{background:linear-gradient(135deg,rgba(255,71,87,.2),rgba(255,107,122,.1));border:2px solid #ff4757;border-radius:10px;padding:14px;margin:14px 0}
    .qr-section{text-align:center;margin:18px 0;padding:14px;background:rgba(255,255,255,.05);border-radius:15px;border:2px solid #5f27cd}
    .qr-code{margin:10px auto;padding:10px;background:white;border-radius:12px;display:inline-block}
    .challenge-card{background:linear-gradient(135deg,rgba(255,140,0,.2),rgba(255,165,0,.1));border:2px solid #ffa500;border-radius:12px;padding:16px;margin:16px 0;position:relative}
    .challenge-card::before{content:"MISSION BRIEFING";position:absolute;top:-10px;left:20px;background:#ffa500;color:#000;padding:4px 10px;font-size:.75em;font-weight:bold}
    .challenge-header{color:#ffa500;font-weight:bold;margin-bottom:10px;font-size:1.05em}
    .status-badge{display:inline-block;padding:6px 10px;border-radius:20px;font-size:.75em;font-weight:bold;margin-left:8px;text-transform:uppercase}
    .status-ready{background:#27ae60;color:#fff}
    .status-used{background:#e74c3c;color:#fff}
    .status-cooldown{background:#f39c12;color:#000}
    .scanner-section{background:rgba(0,0,0,.7);padding:16px;border-radius:12px;margin:16px 0;border:2px solid #5f27cd}
    .game-log{background:rgba(0,0,0,.5);border:2px solid #5f27cd;border-radius:10px;padding:14px;margin:16px 0;max-height:320px;overflow-y:auto}
    .log-entry{margin-bottom:10px;font-size:.9em;padding:8px;border-left:3px solid #5f27cd;padding-left:12px;background:rgba(95,39,205,.1);border-radius:5px}
    .vote-section{background:linear-gradient(135deg,rgba(231,76,60,.3),rgba(192,57,43,.2));border:3px solid #e74c3c;border-radius:15px;padding:16px;margin:18px 0;text-align:center}
    .intel-panel{background:rgba(52,152,219,.1);border:2px solid #3498db;border-radius:10px;padding:14px;margin:14px 0}
    .hidden{display:none}
    .progress-bar{width:100%;height:10px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:linear-gradient(90deg,#5f27cd,#ff4757);border-radius:5px;transition:width .3s}
    .selfie-preview{max-width:200px;border:3px solid #5f27cd;border-radius:15px;margin:12px auto;display:block}
    .roster-card{border:1px dashed #5f27cd;border-radius:10px;padding:10px;margin:8px 0}
    .small{font-size:.85em;color:#9bbcff}
    .muted{opacity:.7}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    @media(max-width:720px){.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="classified-stamp">TOP SECRET</div>
    <div class="header">
      <h1>DISHONOURABLE DISCHARGE</h1>
      <div class="subtitle">Operation: Alpine Debrief</div>
    </div>

    <!-- Game Master Setup -->
    <div id="gameSetup" class="section">
      <div class="section-title">üéÆ Game Master Control</div>
      <div class="grid grid-2">
        <div class="form-group">
          <label>Game Session ID</label>
          <input type="text" id="sessionId" placeholder="Unique session ID">
        </div>
        <div class="form-group">
          <label>Number of Players</label>
          <select id="playerCount">
            <option value="3">3 Players</option>
            <option value="4">4 Players</option>
            <option value="5">5 Players</option>
            <option value="6">6 Players</option>
            <option value="12">12 Players (expanded)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Final Night Starts (Accusations/Scans unlock)</label>
          <input type="datetime-local" id="finalNightAt">
        </div>
        <div class="form-group">
          <label>Game Ends</label>
          <input type="datetime-local" id="gameEndsAt">
        </div>
      </div>
      <div class="grid grid-2">
        <button class="btn" onclick="initializeGame()">Initialize New Game</button>
        <button class="btn btn-secondary" onclick="loadExistingGame()">Load Existing Session</button>
      </div>
      <div id="gmHelp" class="small muted" style="margin-top:8px">
        Tip: Share links will look like <em>?session=ABC123&player=agent_xxx</em>. Final-night gating updates automatically.
      </div>
    </div>

    <!-- Player Onboarding -->
    <div id="onboarding" class="hidden">
      <div class="section">
        <div class="section-title">üîê Agent Recruitment</div>
        <div style="background:#ff4757;color:#000;padding:12px;margin:14px 0;text-align:center;font-weight:bold;transform:rotate(-1deg);">
          ‚ö†Ô∏è CLASSIFIED OPERATION - AUTHORIZED PERSONNEL ONLY ‚ö†Ô∏è
        </div>
        <div class="form-group">
          <label>Agent Name</label>
          <input type="text" id="playerName" placeholder="Enter your real name" required>
        </div>
        <div class="form-group">
          <label>Profile Photo</label>
          <input type="file" id="selfieUpload" accept="image/*" capture="user">
          <div id="selfiePreview" style="margin-top:10px;text-align:center;"></div>
        </div>
        <div class="form-group">
          <label>Session Code</label>
          <input type="text" id="joinSessionId" placeholder="Enter session ID from Game Master">
        </div>
        <button class="btn full" onclick="registerPlayer()">Deploy Agent</button>
      </div>
    </div>

    <!-- Player Profile -->
    <div id="playerProfile" class="hidden">
      <div class="dossier">
        <div class="codename" id="playerCodename">LOADING...</div>
        <div class="dossier-field"><span class="field-label">Agent Name:</span><span class="field-value" id="realName">-</span></div>
        <div class="dossier-field"><span class="field-label">Cover Identity:</span><span class="field-value" id="coverIdentity">-</span></div>
        <div class="dossier-field"><span class="field-label">Background:</span><span class="field-value" id="background">-</span></div>
        <div class="dossier-field"><span class="field-label">Discharge:</span><span class="field-value" id="discharge">-</span></div>

        <div class="secret-section">
          <div class="field-label">Mission Objective:</div>
          <div class="field-value" id="secret">-</div>
        </div>

        <div class="dossier-field"><span class="field-label">Behavioral Quirk:</span><span class="field-value" id="oddity">-</span></div>

        <div class="dossier-field"><span class="field-label">Perks:</span><span class="field-value" id="perkList">-</span></div>
        <div class="dossier-field"><span class="field-label">Con:</span><span class="field-value" id="conText">-</span></div>

        <div class="dossier-field"><span class="field-label">Your Agent ID:</span>
          <span class="field-value">
            <span id="playerIdText">-</span>
            <button class="btn btn-secondary" style="padding:6px 10px;font-size:.85em" onclick="copyPlayerId()">Copy</button>
          </span>
        </div>
      </div>

      <!-- Role Assignment -->
      <div class="intel-panel" id="rolePanel">
        <h4>üéØ OPERATIONAL ROLE</h4>
        <div id="roleDescription">Classified pending mission briefing...</div>
        <div id="roleObjective"></div>
      </div>

      <!-- Murderer Secret -->
      <div id="murdererPanel" class="intel-panel hidden">
        <h4>‚ò†Ô∏è SECRET DIRECTIVE (Murderer)</h4>
        <div id="murdererDirective"></div>
      </div>

      <!-- Abilities & Quirks -->
      <div class="perk-box" id="abilityBox">
        <h4>‚ö° SPECIAL ABILITY</h4>
        <div id="abilityDescription" class="perk-hidden" onclick="revealPerk('ability')">Click to reveal your tactical advantage...</div>
        <span id="abilityStatus" class="status-badge status-ready">READY</span>
        <div class="grid grid-3" style="margin-top:10px">
          <div>
            <label class="small">Target (optional)</label>
            <select id="abilityTargetSelect"></select>
          </div>
          <div>
            <label class="small">Or paste QR payload</label>
            <input type="text" id="abilityTargetQr" placeholder='{"id":"agent_xxx","session":"..."}'>
          </div>
          <div style="align-self:end">
            <button class="btn" onclick="useAbility()">Use Ability</button>
          </div>
        </div>
      </div>

      <!-- QR Code -->
      <div class="qr-section">
        <h4>üì± AGENT IDENTIFICATION</h4>
        <p>Others can scan this code or use your ID.</p>
        <div id="playerQR" class="qr-code"></div>
        <div class="flex" style="justify-content:center;margin-top:6px">
          <button class="btn btn-secondary" onclick="refreshQR()">Refresh QR</button>
          <button class="btn btn-secondary" onclick="copyQrPayload()">Copy QR Payload</button>
        </div>
        <div id="shareLink" style="margin-top:10px;word-break:break-all;font-size:.9em;color:#5f27cd;"></div>
      </div>

      <!-- Roster (public bios + perks/quirks/cons) -->
      <div class="intel-panel">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h4>üóÇÔ∏è Public Roster (Basic Bios + Rules)</h4>
          <button class="btn btn-secondary" onclick="renderRoster()">Refresh</button>
        </div>
        <div id="rosterList"></div>
      </div>

      <!-- Action Submission -->
      <div class="intel-panel">
        <h4>üìù Submit Action / Penalty / Task</h4>
        <div class="grid grid-3">
          <div>
            <label>Action Type</label>
            <select id="actionType">
              <option value="penalty">Report Penalty</option>
              <option value="task_complete">Complete Task</option>
              <option value="murderer_act">Report Murderer Act</option>
              <option value="use_ability">Use Ability (also above)</option>
            </select>
          </div>
          <div>
            <label>Target Player</label>
            <select id="actionTarget"></select>
          </div>
          <div>
            <label>Details</label>
            <input type="text" id="actionDetails" placeholder="What happened / instructions"/>
          </div>
        </div>
        <div class="grid" style="margin-top:10px">
          <button class="btn" onclick="submitAction()">Submit</button>
        </div>
      </div>

      <!-- Challenge System -->
      <div class="challenge-card" id="currentChallenge">
        <div class="challenge-header">üìã ACTIVE MISSION</div>
        <div id="challengeText">No active mission. Request new assignment below.</div>
        <div class="progress-bar"><div class="progress-fill" id="challengeProgress" style="width: 0%"></div></div>
        <div id="challengeReward" class="intel-panel hidden"><strong>Mission Reward:</strong> <span id="rewardText"></span></div>
        <div class="grid grid-2" style="margin-top:10px">
          <button class="btn btn-secondary" onclick="drawChallenge()">Request Mission</button>
          <button class="btn" id="completeBtn" onclick="completeChallenge()" disabled>Complete Mission</button>
        </div>
      </div>

      <!-- Scanner (Final Night Only) -->
      <div class="scanner-section" id="scannerBlock">
        <h4>üîç OPERATIVE SCANNER (Unlocks Final Night)</h4>
        <div id="scanGateNotice" class="small muted"></div>
        <div class="grid grid-3" style="margin-top:8px">
          <div>
            <label>Target (select)</label>
            <select id="scanSelect"></select>
          </div>
          <div>
            <label>Or paste QR payload</label>
            <input type="text" id="scanInput" placeholder='{"id":"agent_xxx","session":"..."}'>
          </div>
          <div style="align-self:end" class="grid">
            <button class="btn btn-secondary" onclick="scanAgent()">Scan Target</button>
            <button class="btn btn-danger" onclick="accuseAgent()">Make Accusation</button>
          </div>
        </div>
      </div>

      <!-- Final Vote -->
      <div class="vote-section" id="finalVote" style="display:none;">
        <h3>üó≥Ô∏è FINAL JUDGMENT</h3>
        <p>The moment of truth has arrived. Who is the traitor among us?</p>
        <select id="suspectSelect"><option value="">Select your suspect...</option></select>
        <div class="grid" style="margin-top:10px"><button class="btn btn-danger" onclick="castFinalVote()">Cast Vote</button></div>
      </div>

      <!-- Inbox for targeted actions -->
      <div class="intel-panel">
        <h4>üì® Your Inbox</h4>
        <div id="inboxList" class="small"></div>
      </div>

      <!-- Game Log -->
      <div class="game-log" id="gameLog">
        <strong>üì° OPERATION LOG</strong>
        <div class="log-entry">Agent deployment initiated. Secure channels established.</div>
      </div>

      <!-- Timers -->
      <div class="intel-panel">
        <div id="timers" class="small"></div>
      </div>
    </div>
  </div>

<script>
// ===================== DATA =====================
// (Keep your themed characters ‚Äì you can expand to 12+; this demo shows 6)
const characterDatabase = [
  { id:"lacehunter", codename:"LACEHUNTER", cover:"Luxury Skiwear Designer",
    background:"Former French AF comms tech ‚Üí NATO PSYOPS 'tactical glam technician'",
    discharge:"Non-disciplinary separation after morale incident involving glitter & thermals",
    secret:"Hunting a ghoster from a classified Alpine affair‚Äîsuspects it's one of you",
    oddity:"Wears silk cravat under everything; lip balm mid-sentence; calls everyone 'Lieutenant Thirsttrap'",
    perks:[
      "Honorific Lock: must be addressed as ‚ÄúMonsieur Val‚Äù (slip = penalty).",
      "Style Verdict: on ‚ÄúRunway check,‚Äù target holds a 10-sec pose."
    ],
    con:"If he sees a reflection within ~5m he must stop & preen for 3s; interrupted ‚Üí restarts whispering ‚Äúcouture.‚Äù",
    ability:{ id:"fashion_emergency", name:"Fashion Emergency", desc:"Force any two players to swap one visible clothing item immediately.", uses:1 }
  },
  { id:"snowblind", codename:"SNOWBLIND", cover:"Extreme Sports Photographer",
    background:"RFMF Recon tracker (Fiji) who can find rumour and happy hour with equal precision",
    discharge:"Honourable; refused to track an innocent defector (who was his brother)",
