<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dishonourable Discharge</title>
  <style>
    :root{
      --bg:#0a0a0a; --bg2:#1a1a2e; --bg3:#16213e;
      --red:#ff4757; --vio:#5f27cd; --vio2:#7c3aed; --ora:#ffa500; --blue:#3498db; --green:#27ae60;
      --fg:#e0e0e0; --muted:#9bbcff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Courier New',monospace;color:var(--fg);min-height:100vh;
      background:linear-gradient(135deg,var(--bg),var(--bg2),var(--bg3));padding:18px}
    .wrap{max-width:1000px;margin:0 auto;background:rgba(0,0,0,.9);border:2px solid var(--red);
      border-radius:16px;padding:22px;box-shadow:0 0 40px rgba(255,71,87,.25);position:relative}
    .stamp{position:absolute;top:20px;right:20px;background:var(--red);color:#000;
      padding:7px 14px;border:3px solid #000;transform:rotate(10deg);font-weight:bold}
    h1{margin:0 0 6px;color:var(--red);text-shadow:0 0 18px rgba(255,71,87,.7);letter-spacing:3px;text-align:center}
    .sub{color:var(--vio);text-align:center;margin-bottom:20px}
    .section{background:rgba(255,255,255,.03);border-left:4px solid var(--vio);border-radius:10px;padding:18px;margin:14px 0}
    .title{color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:760px){.g2,.g3{grid-template-columns:1fr}}
    label{display:block;margin-bottom:6px;color:var(--vio);font-weight:bold;font-size:.88em;letter-spacing:.5px}
    input,select{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid var(--vio);border-radius:8px;color:var(--fg)}
    .btn{background:linear-gradient(45deg,var(--red),#ff6b7a);color:#000;border:none;padding:12px 16px;border-radius:8px;
      font-weight:bold;cursor:pointer;transition:.15s;text-transform:uppercase;letter-spacing:1px}
    .btn.sec{background:linear-gradient(45deg,var(--vio),var(--vio2));color:#fff}
    .btn.alt{background:linear-gradient(45deg,var(--blue),#78a9ff);color:#000}
    .btn.out{background:transparent;border:2px dashed var(--vio);color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{font-size:.85em;color:var(--muted)}
    .card{border:1px dashed var(--vio);border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stamp">TOP SECRET</div>
    <h1>DISHONOURABLE DISCHARGE</h1>
    <div class="sub">Operation: Alpine Debrief</div>

    <!-- GM PANEL -->
    <div id="gmPanel" class="section">
      <div class="title">üéÆ Game Master Control</div>
      <div class="grid g3">
        <div>
          <label>Game Key</label>
          <input id="sessionId" placeholder="e.g. QT1"/>
        </div>
        <div>
          <label>Player Limit</label>
          <select id="playerCount">
            <option>3</option><option>4</option><option>5</option>
            <option selected>6</option><option>8</option><option>12</option>
          </select>
        </div>
        <div>
          <label>Final Night (unlocks scans/accusations)</label>
          <input type="datetime-local" id="finalNightAt"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="createGame()">Create Game</button>
        <button class="btn sec" onclick="refreshState()">Refresh State</button>
        <button class="btn out" onclick="copyJoinLink()">Copy Join Link</button>
      </div>
      <div id="gmMsg" class="small" style="margin-top:8px"></div>
      <div id="seatList" class="grid g3" style="margin-top:10px"></div>
    </div>

    <!-- PLAYER LOGIN -->
    <div id="loginPanel" class="section">
      <div class="title">üîê Player Login</div>
      <div class="grid g3">
        <div>
          <label>Your Name</label>
          <input id="playerName" placeholder="e.g. Kaleb"/>
        </div>
        <div>
          <label>Game Key</label>
          <input id="gameKeyLogin" placeholder="e.g. QT1"/>
        </div>
        <div>
          <label>Seat Key</label>
          <input id="seatKey" placeholder="e.g. ABCD-1234"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="joinGame()">Join Game</button>
        <button class="btn sec" onclick="refreshState()">Refresh State</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px"></div>
    </div>
  </div>

<script>
/* ================= helpers ================= */
const $ = id => document.getElementById(id);
function uiMsg(id, t){ const el=$(id); if(el) el.textContent=t||''; }
function copyText(t){ navigator.clipboard?.writeText(t).catch(()=>{}); }

async function api(op, body = {}) {
  const url = op === 'get' ? `/api/game?id=${encodeURIComponent(body.id||'')}` : '/api/game';
  const opts = op === 'get' ? {} : { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({op, ...body}) };
  const res = await fetch(url, opts);
  let data; try{ data = await res.json(); }catch{ data = { ok:false, error:`HTTP ${res.status}` }; }
  return data;
}

/* ================= GM actions ================= */
async function createGame(){
  const sessionId = ($('sessionId').value||'').toUpperCase().trim();
  const playerLimit = Number($('playerCount').value||6);
  const finalNightAt = $('finalNightAt').value ? new Date($('finalNightAt').value).getTime() : null;

  const r = await api('create', { sessionId, playerLimit, finalNightAt });
  if(!r.ok){ uiMsg('gmMsg', '‚ùå ' + (r.error||'Create failed')); return; }

  localStorage.setItem('gm_session', r.session.id);
  $('gameKeyLogin').value = r.session.id;
  uiMsg('gmMsg', `‚úÖ Game ${r.session.id} created (limit ${r.session.playerLimit})`);
  renderSeats(r.seats||[]);
  await refreshState();
}

function renderSeats(seats){
  $('seatList').innerHTML = (seats||[]).map(s => `
    <div class="card">
      <div><strong>${s.token}</strong></div>
      <div class="small">${s.playerId ? 'Claimed' : 'Open'}</div>
      <div class="row" style="margin-top:6px">
        <button class="btn sec" style="padding:6px 10px" onclick="copyText('${s.token}')">Copy</button>
      </div>
    </div>
  `).join('');
}

function copyJoinLink(){
  const id = ($('sessionId').value||localStorage.getItem('gm_session')||'').toUpperCase();
  if(!id){ uiMsg('gmMsg','No game key yet.'); return; }
  const link = `${location.origin}/?session=${encodeURIComponent(id)}`;
  copyText(link);
  uiMsg('gmMsg','Join link copied.');
}

/* ================= Player ================= */
async function joinGame(){
  const sessionId = ($('gameKeyLogin').value||'').toUpperCase().trim();
  const seatToken = ($('seatKey').value||'').toUpperCase().trim();
  const playerName = ($('playerName').value||'').trim();
  if(!sessionId || !seatToken){ uiMsg('loginMsg','Enter game key and seat key'); return; }

  // Minimal deterministic character pack derived from seat (client-side)
  const char = pickCharacter(seatToken);
  char.adoptedName = char.alias;
  const abilityState = { usesLeft: (char.ability?.usesPerDay ?? 1), lastResetDay: dayKey() };

  const r = await api('join', { sessionId, seatToken, playerName, character:char, abilityState });
  if(!r.ok){ uiMsg('loginMsg','‚ùå ' + (r.error||'Join failed')); return; }

  // Persist seat and player identity, then go to the agent page
  localStorage.setItem('session', r.session.id);
  localStorage.setItem('seatToken', seatToken);
  localStorage.setItem('playerId', r.player.id);

  location.href = '/agent.html?session=' + encodeURIComponent(r.session.id);
}

async function refreshState(){
  const id = (localStorage.getItem('gm_session') || ($('sessionId').value||'') || ($('gameKeyLogin').value||'')).toUpperCase().trim();
  if(!id) return;
  const r = await api('get', { id });
  if(!r.ok){ return; }
  if(r.session?.seats) renderSeats(r.session.seats);
}

/* ================= small utils for character ================= */
function dayKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function pickCharacter(seatKey){
  // same 12-pack as agent page expects (shortened summary OK; server stores the pack we send)
  const CHARACTERS = [
    { alias:"Val√©rie ‚ÄúVal‚Äù Marchand", codename:"LACEHUNTER", cover:"Luxury Skiwear Designer",
      publicBio:"French AF comms ‚Üí NATO PSYOPS ‚Äòtactical glam‚Äô.", background:"Former French AF comms.",
      discharge:"Non-disciplinary separation.", secretMission:"Collect 3 clues from a ghoster.",
      perks:["Honorific Lock","Style Verdict"], quirk:"Silk cravat; lip balm mid-sentence.",
      con:"Must preen at reflections.", ability:{ name:"Fashion Emergency", desc:"Swap two clothing items.", usesPerDay:1 }, role:"wildcard" },
    { alias:"Kaimana ‚ÄúKai‚Äù Savai'i", codename:"SNOWBLIND", cover:"Extreme Sports Photographer",
      publicBio:"RFMF recon tracker; GPS for happy hour.", background:"Recon & humanitarian liaison.",
      discharge:"Honourable.", secretMission:"Collect 3 hometown slang items.",
      perks:["Breadcrumb Command","Switchback"], quirk:"Whispers intel, ends with 'copy?'.",
      con:"'Family/ohana' ‚Üí give a lesson.", ability:{ name:"Hire a Tail", desc:"Recruit a shadow 10‚Äì30 min.", usesPerDay:1 }, role:"innocent" },
    { alias:"Bartosz ‚ÄúBas‚Äù Nowak", codename:"FROSTBITE", cover:"Adventure Safety Coordinator",
      publicBio:"Polish GROM cold-weather specialist.", background:"SERE instructor.",
      discharge:"Honourable.", secretMission:"Gloves silhouette pose.",
      perks:["Interrogator‚Äôs Pause","Cold Protocol"], quirk:"Over-enunciates; NATO phonetics.",
      con:"If asked 'plan?' ‚Üí checklist or salute.", ability:{ name:"Coerce an Asset", desc:"Designate an Asset 15 min.", usesPerDay:1 }, role:"handler" },
    { alias:"Ira ‚ÄúIris‚Äù Khatri", codename:"BLACKRUN", cover:"Avalanche Risk Specialist",
      publicBio:"SF mountain warfare; predicts disasters.", background:"Demo team; SAR.",
      discharge:"Medical.", secretMission:"Run a safety briefing with props.",
      perks:["Beacon Check","Disaster Brief"], quirk:"Adds 'allegedly' if alcohol present.",
      con:"Estimates angles aloud.", ability:{ name:"Avalanche Protocol", desc:"30s evac drill + swap seats.", usesPerDay:1 }, role:"wildcard" },
    { alias:"Pilar ‚ÄúPili‚Äù Casta√±o", codename:"POWDER KEG", cover:"Lodge Event Coordinator",
      publicBio:"Spanish social engineer; chaos diplomat.", background:"Embassy events fixer.",
      discharge:"Dishonourable.", secretMission:"Be announced as Ambassador of Apr√®s.",
      perks:["VIP Gate","Guest List"], quirk:"Assigns callsigns, not names.",
      con:"Rumours ‚Üí 'exclusive source' wink.", ability:{ name:"Task the Mark", desc:"Nominate player to obtain item.", usesPerDay:1 }, role:"wildcard" },
    { alias:"Dmitri ‚ÄúDima‚Äù Volkov", codename:"ICEPICK", cover:"Spirits Consultant",
      publicBio:"Ex-Spetsnaz? Measures every drink.", background:"Urban recon.",
      discharge:"Special transfer.", secretMission:"Learn + perform a new toast.",
      perks:["Cold Stare","Vodka Toast Override"], quirk:"Ends sentences with 'over'.",
      con:"On new arrival: pocket pat ritual.", ability:{ name:"Charm Offensive", desc:"Get 3 vodka drinks bought for you.", usesPerDay:1 }, role:"innocent" },
    { alias:"Rowan ‚ÄúRo‚Äù Hart", codename:"WOLFTRAP", cover:"Night Security Analyst",
      publicBio:"Perimeter whisperer; hears bouncers first.", background:"Crowd control.",
      discharge:"Honourable.", secretMission:"Get a staffer to radio-check you.",
      perks:["Line Cutter","Bouncer‚Äôs Choice"], quirk:"Counts exits when entering.",
      con:"Music change ‚Üí freeze 3s.", ability:{ name:"Angle Check", desc:"Command 10-sec pose.", usesPerDay:1 }, role:"innocent" },
    { alias:"Asher ‚ÄúAsh‚Äù Del Mar", codename:"SEALEVEL", cover:"Hydro Logistics Planner",
      publicBio:"Boat guy; altitude-sick at menus.", background:"Riverine logistics.",
      discharge:"Honourable.", secretMission:"Collect 3 venue coasters map.",
      perks:["High-Water Mark","Docking Fee"], quirk:"Constant boat metaphors.",
      con:"If 'wave' heard ‚Üí lifeguard salute.", ability:{ name:"Harbour Master", desc:"Declare table 'Port'.", usesPerDay:1 }, role:"wildcard" },
    { alias:"Noah ‚ÄúKnox‚Äù Keegan", codename:"SWITCHBACK", cover:"MTB Guide",
      publicBio:"Downhill brain, uphill charm.", background:"Bike courier.",
      discharge:"Honourable.", secretMission:"Borrow & wear a helmet 2 min.",
      perks:["Gear Check","Trail Marshal"], quirk:"Claps once when standing.",
      con:"If 'brake' heard ‚Üí freeze 2s.", ability:{ name:"Trail Tax", desc:"Swap two seats; route apology.", usesPerDay:1 }, role:"innocent" },
    { alias:"Jamie ‚ÄúHarrow‚Äù Quinn", codename:"BONESAW", cover:"Field Medic (Former)",
      publicBio:"Great stitches, terrible boundaries.", background:"Triage medic.",
      discharge:"Honourable.", secretMission:"Bandage a non-player; get rating.",
      perks:["Triage","Sterile Field"], quirk:"Calls snacks 'oral meds'.",
      con:"If 'owie' heard ‚Üí produce bandage.", ability:{ name:"Scrub In", desc:"Emergency consult whisper.", usesPerDay:1 }, role:"wildcard" },
    { alias:"Elliot ‚ÄúLedger‚Äù Vance", codename:"COUNTERSIGN", cover:"Casino Surveillance",
      publicBio:"Counts cards and people.", background:"Pattern analysis.",
      discharge:"Honourable.", secretMission:"Speak only in numbers for 30s.",
      perks:["Tell Read","Double Down"], quirk:"Murmurs odds.",
      con:"Numbers >10 ‚Üí whisper random number.", ability:{ name:"Background Count", desc:"GM statistical hint.", usesPerDay:1 }, role:"handler" },
    { alias:"Rafe ‚ÄúStatic‚Äù Moretti", codename:"JAMMER", cover:"RF Tech",
      publicBio:"More antennas than personality.", background:"Signals/EW.",
      discharge:"Honourable.", secretMission:"Make a stranger say 'Say again?' twice.",
      perks:["Signal Check","Dead Zone"], quirk:"Says 'Copy' to compliments.",
      con:"If 'loud' heard ‚Üí turn imaginary knob.", ability:{ name:"Static Burst", desc:"30-sec whisper-only outage.", usesPerDay:1 }, role:"innocent" },
  ];
  let h=0; for(const c of seatKey) h = (h*31 + c.charCodeAt(0)) >>> 0;
  return JSON.parse(JSON.stringify(CHARACTERS[h % CHARACTERS.length]));
}

/* ================= boot ================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  const qs = new URLSearchParams(location.search);
  const urlSession = (qs.get('session')||'').toUpperCase();
  if(urlSession){
    $('sessionId').value = urlSession;
    $('gameKeyLogin').value = urlSession;
    localStorage.setItem('gm_session', urlSession);
    await refreshState();
  }else{
    const gm = localStorage.getItem('gm_session');
    if(gm){ $('sessionId').value = gm; $('gameKeyLogin').value = gm; await refreshState(); }
  }
});
</script>
</body>
</html>
