<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dishonourable Discharge</title>
  <style>
    :root { --pink:#ff4757; --violet:#5f27cd; }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Courier New',monospace;background:linear-gradient(135deg,#0a0a0a,#1a1a2e,#16213e);color:#e0e0e0;min-height:100vh;padding:10px}
    .container{max-width:900px;margin:0 auto;background:rgba(0,0,0,.9);border:2px solid var(--pink);border-radius:15px;padding:24px;box-shadow:0 0 40px rgba(255,71,87,.3);position:relative}
    .classified{position:absolute;top:20px;right:20px;background:var(--pink);color:#000;padding:6px 12px;border:3px solid #000;transform:rotate(12deg);font-weight:700}
    .header{text-align:center;margin-bottom:20px;border-bottom:3px solid var(--pink);padding-bottom:16px}
    .header h1{color:var(--pink);letter-spacing:3px;text-shadow:0 0 20px rgba(255,71,87,.7);font-size:2rem}
    .subtitle{color:var(--violet);font-style:italic;text-transform:uppercase;margin-top:4px}
    .section{margin-top:18px;padding:16px;border-left:4px solid var(--violet);background:rgba(255,255,255,.03);border-radius:10px}
    .section h3{color:var(--pink);text-transform:uppercase;font-size:1rem;margin-bottom:8px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .btn{background:linear-gradient(45deg,#ff4757,#ff6b7a);color:#000;border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:linear-gradient(45deg,#5f27cd,#7c3aed);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    label{display:block;color:#9bbcff;margin:6px 0 4px;font-size:.85rem;text-transform:uppercase}
    input,select{width:100%;padding:10px;border:2px solid var(--violet);border-radius:8px;background:rgba(0,0,0,.7);color:#e0e0e0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .muted{opacity:.7}
    .ok{color:#9bffaf}
    .err{color:#ff9b9b}
    .hidden{display:none}
    .copy-btn{margin-left:8px;padding:6px 10px;font-size:.85rem}
    .divider{height:1px;background:rgba(255,255,255,.1);margin:14px 0}
    /* optional debug log hidden by default */
    #debugWrap{display:none}
    #debugWrap.show{display:block}
    .log{margin-top:8px;padding:8px;border:1px dashed var(--violet);border-radius:10px;max-height:220px;overflow:auto}
    .log div{padding:6px;border-left:3px solid var(--violet);background:rgba(95,39,205,.12);border-radius:6px;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="classified">TOP SECRET</div>
    <div class="header">
      <h1>DISHONOURABLE DISCHARGE</h1>
      <div class="subtitle">Operation: Alpine Debrief</div>
    </div>

    <!-- GAME MASTER -->
    <div id="gmPanel" class="section">
      <h3>üéÆ Game Master</h3>

      <div class="grid grid-2">
        <div>
          <label>Game Key (edit or regenerate)</label>
          <div class="row">
            <input id="sessionId" placeholder="e.g. FJ6Q8Z" />
            <button id="btnGenKey" class="btn secondary" title="Regenerate Game Key">Regenerate</button>
          </div>
          <div class="muted" style="margin-top:4px">Share this key with players. They‚Äôll use it to join.</div>
        </div>
        <div>
          <label>Final Night (unlocks scans & accusations)</label>
          <input id="finalNightAt" type="datetime-local">
        </div>
      </div>

      <div class="grid grid-2" style="margin-top:10px">
        <div>
          <label>Player Limit</label>
          <select id="playerLimit">
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6" selected>6</option>
            <option value="8">8</option>
            <option value="12">12</option>
          </select>
        </div>
        <div class="row" style="align-items:end">
          <button id="btnCreate" class="btn">Create Game</button>
          <button id="btnLoad" class="btn secondary">Load Existing</button>
        </div>
      </div>

      <div id="gmStatus" class="muted" style="margin-top:8px"></div>

      <div class="divider"></div>

      <div id="shareBlock" class="hidden">
        <div class="ok">‚úÖ Game ready.</div>
        <div style="margin-top:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <strong>Game Key: <span id="sessionOut" style="color:#fff"></span></strong>
          <button id="btnCopyKey" class="btn secondary copy-btn">Copy</button>
        </div>
        <div class="muted" style="margin-top:4px">Players join with their name + this key.</div>
      </div>
    </div>

    <!-- PLAYER JOIN -->
    <div id="joinPanel" class="section">
      <h3>ü™™ Player Join</h3>
      <div class="grid grid-2">
        <div>
          <label>Your Name</label>
          <input id="joinName" placeholder="e.g. Kaleb">
        </div>
        <div>
          <label>Game Key</label>
          <input id="joinSession" placeholder="e.g. FJ6Q8Z">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnJoin" class="btn">Join Game</button>
      </div>
      <div id="joinStatus" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- PLAYER PROFILE (summary) -->
    <div id="profilePanel" class="section hidden">
      <h3>üßæ Player Profile</h3>
      <div><strong>Codename:</strong> <span id="codename">‚Äî</span></div>
      <div><strong>Agent ID:</strong> <span id="playerId">‚Äî</span></div>
      <div><strong>Role:</strong> <span id="role">‚Äî</span></div>
      <div class="divider"></div>
      <div><strong>Cover:</strong> <span id="cover">‚Äî</span></div>
      <div><strong>Background:</strong> <span id="background">‚Äî</span></div>
      <div><strong>Discharge:</strong> <span id="discharge">‚Äî</span></div>
      <div class="divider"></div>
      <div><strong>Quirk:</strong> <span id="quirk">‚Äî</span></div>
      <div><strong>Perks:</strong> <span id="perks">‚Äî</span></div>
      <div><strong>Con:</strong> <span id="con">‚Äî</span></div>
      <div class="divider"></div>
      <div><strong>Ability:</strong> <span id="ability">‚Äî</span></div>
      <div class="divider"></div>
      <div class="row">
        <button id="btnRefresh" class="btn secondary">Refresh Roster</button>
        <button id="btnLeave" class="btn">Leave (local)</button>
      </div>
    </div>

    <!-- ROSTER -->
    <div id="rosterPanel" class="section hidden">
      <h3>üóÇÔ∏è Public Roster</h3>
      <div id="roster" class="muted">No players yet.</div>
    </div>

    <!-- (Optional) Debug toggle -->
    <div class="section" style="text-align:center">
      <a href="#" id="toggleDebug" class="muted">Show debug</a>
      <div id="debugWrap">
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

<script>
/* ========= helpers ========= */
const $ = id => document.getElementById(id);
const setHTML = (id, html) => { const el=$(id); if(el) el.innerHTML=html; };
const setText = (id, txt) => { const el=$(id); if(el) el.textContent=txt; };
const show = (id, on=true)=>{ const el=$(id); if(!el) return; el.classList[on?'remove':'add']('hidden'); };
const log = (t,cls='') => {
  const wrap = $('debugWrap'); if(!wrap || !wrap.classList.contains('show')) return;
  const d = document.createElement('div'); if (cls) d.className=cls;
  d.textContent = `[${new Date().toLocaleTimeString()}] ${t}`;
  $('log')?.prepend(d);
};
function randKey(len=6){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // no 0/O/I/1
  let s=''; for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

/* ========= local persistence ========= */
const LS = { session: 'dd_session', player: 'dd_player' };
const saveSession = id => localStorage.setItem(LS.session, id||'');
const savePlayer  = id => localStorage.setItem(LS.player, id||'');
const getSession  = () => localStorage.getItem(LS.session) || '';
const getPlayer   = () => localStorage.getItem(LS.player) || '';

/* ========= API =========
  Expected server routes:
  - POST /api/game { sessionId, playerLimit:number, finalNightAt?:number } -> { ok, sessionId }
  - GET  /api/session?id=SESSION_ID                                      -> { ok, session }
  - POST /api/join { sessionId, name }                                    -> { ok, player, session }
*/
async function apiCreateGame(sessionId, playerLimit, finalNightAt) {
  const body = { sessionId: String(sessionId), playerLimit: Number(playerLimit) };
  const ts = Date.parse(finalNightAt || '');
  if (!Number.isNaN(ts)) body.finalNightAt = ts;

  const res = await fetch('/api/game', {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
  if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}
async function apiLoadSession(sessionId) {
  const res = await fetch(`/api/session?id=${encodeURIComponent(sessionId)}`, { cache:'no-store' });
  const data = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
  if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}
async function apiJoin(sessionId, name) {
  const res = await fetch('/api/join', {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ sessionId, name })
  });
  const data = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
  if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

/* ========= renderers ========= */
function renderRoster(session){
  if (!session || !Array.isArray(session.players) || !session.players.length){
    setHTML('roster','<span class="muted">No players yet.</span>');
    return;
  }
  const html = session.players.map(p=>{
    const perks = (p.perks && p.perks.length) ? `<ul>${p.perks.map(x=>`<li>${x}</li>`).join('')}</ul>` : '‚Äî';
    const bio = p.publicBio || '‚Äî';
    return `
      <div style="border:1px dashed #5f27cd;border-radius:8px;padding:8px;margin:6px 0">
        <div><strong>${p.codename || '‚Äî'}</strong> ‚Äî ${p.realName || 'Unknown'}</div>
        <div class="muted">${p.cover || ''}</div>
        <div style="margin-top:6px"><strong>Bio:</strong> ${bio}</div>
        <div style="margin-top:6px;display:grid;gap:8px;grid-template-columns:repeat(3,minmax(0,1fr))">
          <div><strong>Quirk:</strong><br>${p.oddity || p.quirk || '‚Äî'}</div>
          <div><strong>Con:</strong><br>${p.con || '‚Äî'}</div>
          <div><strong>Perks:</strong><br>${perks}</div>
        </div>
      </div>
    `;
  }).join('');
  setHTML('roster', html);
}
function renderProfile(player){
  if (!player) return;
  setText('codename', player.codename || '‚Äî');
  setText('playerId', player.id || '‚Äî');
  setText('role', player.role || '‚Äî');
  setText('cover', player.cover || '‚Äî');
  setText('background', player.background || '‚Äî');
  setText('discharge', player.discharge || '‚Äî');
  setText('quirk', player.oddity || player.quirk || '‚Äî');
  setHTML('perks', (player.perks && player.perks.length) ? `<ul>${player.perks.map(x=>`<li>${x}</li>`).join('')}</ul>` : '‚Äî');
  setText('con', player.con || '‚Äî');
  setText('ability', player.ability ? `${player.ability.name}: ${player.ability.desc}` : '‚Äî');
}

/* ========= handlers ========= */
async function onCreate(){
  $('btnCreate').disabled = true;
  setText('gmStatus','Creating‚Ä¶');

  try{
    let sid = $('sessionId').value.trim();
    if(!sid){ sid = randKey(); $('sessionId').value = sid; }
    const limit = $('playerLimit').value;
    const when  = $('finalNightAt').value; // optional
    const out = await apiCreateGame(sid, limit, when);
    const sessionId = out.sessionId || sid;
    saveSession(sessionId);
    savePlayer('');
    setText('gmStatus','');
    setText('sessionOut', sessionId);
    show('shareBlock', true);
    log(`Game created: ${sessionId}`, 'ok');
  }catch(e){
    setText('gmStatus','');
    alert(`Create Game failed: ${e.message}`);
    log(`Create failed: ${e.message}`, 'err');
  }finally{
    $('btnCreate').disabled = false;
  }
}
async function onLoad(){
  const s = prompt('Enter existing Game Key:') || '';
  if(!s.trim()) return;
  try{
    const out = await apiLoadSession(s.trim());
    saveSession(s.trim());
    savePlayer('');
    setText('sessionOut', s.trim());
    show('shareBlock', true);
    renderRoster(out.session);
    show('rosterPanel', true);
    log(`Loaded session ${s}`, 'ok');
  }catch(e){
    alert(`Load failed: ${e.message}`);
    log(`Load failed: ${e.message}`, 'err');
  }
}
async function onJoin(){
  $('btnJoin').disabled = true;
  setText('joinStatus','Joining‚Ä¶');
  try{
    const name = $('joinName').value.trim();
    const sess = $('joinSession').value.trim() || $('sessionId').value.trim() || getSession();
    if(!name || !sess){
      setText('joinStatus','');
      $('btnJoin').disabled = false;
      return alert('Enter your name and the game key.');
    }
    const out = await apiJoin(sess, name);
    saveSession(sess);
    savePlayer(out.player.id);
    renderProfile(out.player);
    renderRoster(out.session);
    show('profilePanel', true);
    show('rosterPanel', true);
    setText('joinStatus','');
    log(`Joined ${sess} as ${out.player.codename || name}`, 'ok');
  }catch(e){
    setText('joinStatus','');
    alert(`Join failed: ${e.message}`);
    log(`Join failed: ${e.message}`, 'err');
  }finally{
    $('btnJoin').disabled = false;
  }
}
async function onRefreshRoster(){
  const s = getSession() || $('joinSession').value.trim() || $('sessionId').value.trim();
  if(!s){ return alert('No session to refresh.'); }
  try{
    const out = await apiLoadSession(s);
    renderRoster(out.session);
    show('rosterPanel', true);
    log('Roster refreshed', 'ok');
  }catch(e){
    log(`Refresh failed: ${e.message}`, 'err');
  }
}
function onLeaveLocal(){
  savePlayer('');
  alert('Local data cleared. You can join again with your Name + Game Key.');
  log('Left locally','ok');
}
function onGenKey(){
  $('sessionId').value = randKey();
  show('shareBlock', false);
}
function onCopyKey(){
  const s = $('sessionOut').textContent.trim() || $('sessionId').value.trim();
  if(!s) return;
  navigator.clipboard.writeText(s).then(()=>{}).catch(()=>{});
}

/* ========= boot ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  // buttons
  $('btnGenKey').addEventListener('click', onGenKey);
  $('btnCopyKey').addEventListener('click', onCopyKey);
  $('btnCreate').addEventListener('click', onCreate);
  $('btnLoad').addEventListener('click', onLoad);
  $('btnJoin').addEventListener('click', onJoin);
  $('btnRefresh').addEventListener('click', onRefreshRoster);
  $('btnLeave').addEventListener('click', onLeaveLocal);

  // optional debug toggle
  $('toggleDebug').addEventListener('click', (e)=>{ e.preventDefault(); $('debugWrap').classList.toggle('show'); });

  // prefill a key
  if(!$('sessionId').value) $('sessionId').value = randKey();

  // try resume
  const s = getSession();
  if (s){
    apiLoadSession(s).then(out=>{
      setText('sessionOut', s);
      show('shareBlock', true);
      renderRoster(out.session);
      show('rosterPanel', true);
      log(`Session ${s} loaded (resume)`, 'ok');
    }).catch(()=>{ /* ignore */ });
  }
});
</script>
</body>
</html>
