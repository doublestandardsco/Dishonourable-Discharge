<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dishonourable Discharge</title>
  <style>
    :root{
      --bg:#0a0a0a; --bg2:#1a1a2e; --bg3:#16213e;
      --red:#ff4757; --vio:#5f27cd; --vio2:#7c3aed; --ora:#ffa500; --blue:#3498db; --green:#27ae60;
      --fg:#e0e0e0; --muted:#9bbcff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Courier New',monospace;color:var(--fg);min-height:100vh;
      background:linear-gradient(135deg,var(--bg),var(--bg2),var(--bg3));padding:18px}
    .wrap{max-width:1000px;margin:0 auto;background:rgba(0,0,0,.9);border:2px solid var(--red);
      border-radius:16px;padding:22px;box-shadow:0 0 40px rgba(255,71,87,.25);position:relative}
    .stamp{position:absolute;top:20px;right:20px;background:var(--red);color:#000;
      padding:7px 14px;border:3px solid #000;transform:rotate(10deg);font-weight:bold}
    h1{margin:0 0 6px;color:var(--red);text-shadow:0 0 18px rgba(255,71,87,.7);letter-spacing:3px;text-align:center}
    .sub{color:var(--vio);text-align:center;margin-bottom:20px}
    .section{background:rgba(255,255,255,.03);border-left:4px solid var(--vio);border-radius:10px;padding:18px;margin:14px 0}
    .title{color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:760px){.g2,.g3{grid-template-columns:1fr}}
    label{display:block;margin-bottom:6px;color:var(--vio);font-weight:bold;font-size:.88em;letter-spacing:.5px}
    input,select,textarea{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid var(--vio);border-radius:8px;color:var(--fg)}
    textarea{min-height:80px}
    .btn{background:linear-gradient(45deg,var(--red),#ff6b7a);color:#000;border:none;padding:12px 16px;border-radius:8px;
      font-weight:bold;cursor:pointer;transition:.15s;text-transform:uppercase;letter-spacing:1px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(255,71,87,.45)}
    .btn.sec{background:linear-gradient(45deg,var(--vio),var(--vio2));color:#fff}
    .btn.alt{background:linear-gradient(45deg,var(--blue),#78a9ff);color:#000}
    .btn.out{background:transparent;border:2px dashed var(--vio);color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{font-size:.85em;color:var(--muted)}
    .muted{opacity:.75}
    .good{color:#8ef08e}.bad{color:#ff9aa2}
    .card{border:1px dashed var(--vio);border-radius:10px;padding:10px}
    .dossier{border:2px solid var(--red);border-radius:12px;background:linear-gradient(135deg,rgba(255,71,87,.1),rgba(95,39,205,.1));padding:16px;margin:12px 0;position:relative}
    .dossier:before{content:"CLASSIFIED";position:absolute;top:-10px;left:18px;background:var(--red);color:#000;padding:3px 10px;font-size:.72em;font-weight:bold}
    .code{color:var(--red);font-weight:bold}
    .log{max-height:260px;overflow:auto;background:rgba(0,0,0,.45);border:2px solid var(--vio);border-radius:10px;padding:12px}
    .line{border-left:3px solid var(--vio);padding-left:10px;margin:8px 0;background:rgba(95,39,205,.12);border-radius:4px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--vio),transparent);margin:12px 0}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78em;font-weight:bold}
    .b-ready{background:var(--green);color:#fff}.b-used{background:#e74c3c;color:#fff}
    .b-lock{background:#f39c12;color:#000}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stamp">TOP SECRET</div>
    <h1>DISHONOURABLE DISCHARGE</h1>
    <div class="sub">Operation: Alpine Debrief</div>

    <!-- GM PANEL -->
    <div id="gmPanel" class="section">
      <div class="title">üéÆ Game Master Control</div>
      <div class="grid g3">
        <div>
          <label>Game Key</label>
          <input id="sessionId" placeholder="e.g. QT1" />
        </div>
        <div>
          <label>Player Limit</label>
          <select id="playerCount">
            <option>3</option><option>4</option><option>5</option>
            <option selected>6</option><option>8</option><option>12</option>
          </select>
        </div>
        <div>
          <label>Final Night (unlocks scans/accusations)</label>
          <input type="datetime-local" id="finalNightAt"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="createGame()">Create Game</button>
        <button class="btn sec" onclick="refreshState()">Refresh State</button>
        <button class="btn out" onclick="copyGameLink()">Copy Join Link (Key Only)</button>
      </div>
      <div id="gmMsg" class="small" style="margin-top:8px"></div>
      <div id="seatList" class="grid g3" style="margin-top:10px"></div>
    </div>

    <!-- LOGIN PANEL -->
    <div id="loginPanel" class="section">
      <div class="title">üîê Player Login</div>
      <div class="grid g3">
        <div>
          <label>Your Name</label>
          <input id="playerName" placeholder="e.g. Kaleb"/>
        </div>
        <div>
          <label>Game Key</label>
          <input id="gameKeyLogin" placeholder="e.g. QT1"/>
        </div>
        <div>
          <label>Seat Key</label>
          <input id="seatKey" placeholder="e.g. AB1C-9XYZ"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="joinGame()">Join Game</button>
        <button class="btn sec" onclick="refreshState()">Refresh State</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashPanel" class="section hidden">
      <div class="title">üßæ Agent Dashboard</div>

      <div class="dossier">
        <div class="row" style="justify-content:space-between">
          <div><span class="code" id="codenameText">‚Äî</span> <span class="small muted">(Agent ID <span id="agentIdText">‚Äî</span>)</span></div>
          <div class="small">Game: <span id="gameKeyText">‚Äî</span> ¬∑ Final Night: <span id="finalNightText">‚Äî</span></div>
        </div>
        <div class="hr"></div>

        <div class="grid g3">
          <div class="card">
            <div class="small muted">Your Name</div>
            <div id="realNameText">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Adopted Character Name</div>
            <div id="aliasText">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Cover Identity</div>
            <div id="coverText">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Operational Role</div>
            <div id="roleText">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Role Objective</div>
            <div id="roleObjective">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Win Condition</div>
            <div id="roleWin">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Secret Mission (you only)</div>
            <div id="secretMissionText">‚Äî</div>
          </div>
        </div>

        <div class="grid g2" style="margin-top:10px">
          <div class="card">
            <div class="small muted">Background</div>
            <div id="backgroundText">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Discharge</div>
            <div id="dischargeText">‚Äî</div>
          </div>
        </div>

        <div class="grid g3" style="margin-top:10px">
          <div class="card">
            <div class="small muted">Perks (table games everyone must respect)</div>
            <ul id="perkList" style="margin:6px 0 0 18px"></ul>
          </div>
          <div class="card">
            <div class="small muted">Behavioral Quirk (always on)</div>
            <div id="quirkText">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Con (your personal embarrassment)</div>
            <div id="conText">‚Äî</div>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="small muted">Special Ability</div>
              <div id="abilityName"><strong>‚Äî</strong></div>
              <div class="small" id="abilityDesc">‚Äî</div>
            </div>
            <div>
              <span id="abilityBadge" class="badge b-ready">READY</span>
              <div class="small">Uses Left Today: <span id="abilityUsesLeft">1</span></div>
            </div>
          </div>
          <div class="grid g3" style="margin-top:10px">
            <div>
              <label class="small">Target (optional)</label>
              <select id="abilityTargetSelect"></select>
            </div>
            <div>
              <label class="small">‚Ä¶or type Agent ID</label>
              <input id="abilityTargetId" placeholder="agent_xxx"/>
            </div>
            <div style="align-self:end">
              <button class="btn alt" onclick="useAbility()">Use Ability</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Missions -->
      <div class="section" style="border-left-color:var(--ora)">
        <div class="title">üìã Missions</div>
        <div id="activeMission" class="card">
          <div class="small muted">Active Mission</div>
          <div id="missionText">None. Request one below.</div>
          <div class="row" style="margin-top:8px">
            <button class="btn sec" onclick="requestMission()">Request Mission</button>
            <button class="btn" onclick="completeMission()">Complete Mission</button>
            <button class="btn out" onclick="failMission()">Fail & Redraw</button>
          </div>
          <div class="small" style="margin-top:6px">Completed: <span id="missionCount">0</span></div>
        </div>
      </div>

      <!-- Actions -->
      <div class="section" style="border-left-color:var(--blue)">
        <div class="title">üìù Submit Action / Penalty / Task</div>
        <div class="grid g3">
          <div>
            <label>Action Type</label>
            <select id="actionType">
              <option value="penalty">Report Penalty</option>
              <option value="task_complete">Task Complete</option>
              <option value="murderer_act">Report Murderer Act</option>
              <option value="ability">Use Ability (also above)</option>
            </select>
          </div>
          <div>
            <label>Target Player</label>
            <select id="actionTarget"></select>
          </div>
          <div>
            <label>Details</label>
            <input id="actionDetails" placeholder="What happened / instructions"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn alt" onclick="submitAction()">Submit</button>
        </div>
      </div>

      <!-- Public Roster -->
      <div class="section">
        <div class="title">üóÇÔ∏è Public Roster (bios + perks/quirks/cons)</div>
        <div id="rosterList"></div>
      </div>

      <!-- Log -->
      <div class="section" style="border-left-color:var(--vio2)">
        <div class="title">üì° Operation Log</div>
        <div id="logView" class="log"></div>
      </div>

      <div class="row">
        <button class="btn sec" onclick="refreshState()">Refresh</button>
        <button class="btn out" onclick="leaveSeat()">Leave Seat (Clear Local)</button>
      </div>
    </div>
  </div>

<script>
/* ========== helpers ========== */
const $ = id => document.getElementById(id);
const now = () => Date.now();
const fmt = ts => new Date(ts).toLocaleString();
const pick = a => a[Math.floor(Math.random()*a.length)];
function uiMsg(id, text){ const el=$(id); if(el) el.textContent = text||''; }
function copyText(t){ navigator.clipboard.writeText(t); }

/* ========== roles ========== */
const ROLES = {
  flipped_agent:{ name:"The Flipped Agent", obj:"Stay hidden while sowing chaos. Frame others or recruit allies.", win:"Survive final vote OR flip another player." },
  handler:{ name:"The Handler", obj:"Identify the traitor through investigation and deduction.", win:"Correctly identify the Flipped Agent in the final vote." },
  wildcard:{ name:"The Wildcard", obj:"Survive and adapt; can align with either side.", win:"Align with the winning side OR complete your solo objectives." },
  innocent:{ name:"Innocent Operative", obj:"Identify the traitor and survive the final vote.", win:"Vote out the Flipped Agent OR survive to the end." }
};

/* ========== missions / acts ========== */
const MISSIONS = [
  "Wear ski goggles to dinner; never explain why.",
  "Ask 3 strangers where the CIA safehouse is.",
  "Challenge someone to a snowball duel; loser does a shoey.",
  "Bring a random item to the bar and convince someone it's priceless.",
  "Gain legit access to another player's room for 15 minutes.",
  "Speak only in a fake Russian accent for 3 hours.",
  "Critique outfits using military terminology.",
  "Take a candid photo of every player undetected.",
  "Get someone to break a minor rule for you.",
  "Teach a stranger a codeword and use it later."
];

const MURDERER_ACTS = [
  "Leave one coaster upside-down at a table you visit.",
  "Say the word 'almond' twice in different conversations.",
  "Touch the back of a chair before sitting, every time.",
  "Hum two short notes before speaking, at least three times.",
  "Place a napkin folded into a triangle at a random spot.",
  "Tap the table twice with your index finger before drinking."
];

/* ========== characters (12) ========== */
const CHARACTERS = [
  { alias:"Val√©rie "Val" Marchand", codename:"LACEHUNTER", cover:"Luxury Skiwear Designer",
    publicBio:"French AF comms ‚Üí NATO PSYOPS 'tactical glam'. Gives unsolicited runway checks.",
    privateBio:"Trans man. Busted tailoring a general's thermals. Can't pass a mirror without preening.",
    background:"Former French Air Force comms; reassigned to NATO PSYOPS for 'morale optimization'.",
    discharge:"Non-disciplinary separation after a glitter-related morale incident.",
    secretMission:"Track down the mystery ghoster from a classified Alpine affair and collect 3 clues.",
    perks:["Honorific Lock: others must call you "Monsieur Val".",
           "Style Verdict: on 'Runway check', target holds an awkward 10-sec pose."],
    quirk:"Silk cravat; lip balm mid-sentence; says "Lieutenant Thirsttrap".",
    con:"If he catches his reflection he must stop & preen for 3s.",
    ability:{ name:"Fashion Emergency", desc:"Force any two players to swap one visible clothing item immediately.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Kaimana "Kai" Savai'i", codename:"SNOWBLIND", cover:"Extreme Sports Photographer",
    publicBio:"RFMF (Fiji) recon tracker; can find happy hour with GPS accuracy.",
    privateBio:"Refused to hunt an innocent defector (his brother). Collects slang like shell casings.",
    background:"Reconnaissance & tracking specialist; humanitarian ops liaison.",
    discharge:"Honourable discharge after family conflict.",
    secretMission:"Collect 3 strangers' hometown slang and compile a 'tracking lexicon'.",
    perks:["Breadcrumb Command: choose a trigger word; speakers owe a clue or take penalty for 10 min.",
           "Switchback: say 'First tracks' ‚Üí everyone rotates seats; last seated owes you a favour."],
    quirk:"Whispers intel and ends with 'copy?'.",
    con:"If someone says 'family'/'ohana', must deliver a 1-sentence heartfelt lesson.",
    ability:{ name:"Hire a Tail", desc:"Recruit one player to shadow you 10‚Äì30 min; deliver intel every 5 min or take penalties.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Bartosz "Bas" Nowak", codename:"FROSTBITE", cover:"Adventure Safety Coordinator",
    publicBio:"Polish GROM cold-weather specialist. Loves lists & laminated check cards.",
    privateBio:"Interrogation 'cultural differences'. Considers silence a confession.",
    background:"SERE instructor, polar training cadre.",
    discharge:"Honourable; opted out after 'communication' feedback.",
    secretMission:"Convince a stranger to wear your gloves and pose like a crime-scene silhouette.",
    perks:["Interrogator's Pause: on 'Answer the question', target must reply in ‚â§5 words.",
           "Cold Protocol: greetings become fist-bump only until cleared."],
    quirk:"Over-enunciates like radio checks; NATO phonetic for numbers.",
    con:"When asked 'what's the plan?' must show a checklist or salute 'I am improvising.'",
    ability:{ name:"Coerce an Asset", desc:"Designate a player your Asset for 15 min; complete 2 simple tasks or take penalties.", usesPerDay:1 },
    role:"handler"
  },
  { alias:"Ira "Iris" Khatri", codename:"BLACKRUN", cover:"Avalanche Risk Specialist",
    publicBio:"Para (SF) mountain warfare; predicts disasters in people as easily as in snow.",
    privateBio:"Trans man. The avalanche that saved lives also hid sins; won't say whose.",
    background:"High-altitude demo team; SAR & explosives.",
    discharge:"Medical after surviving a unit-ending avalanche.",
    secretMission:"Run a spontaneous 'safety briefing' with strangers and redistribute props they must wear.",
    perks:["Beacon Check: phones face-down 5 min; touching = penalty.",
           "Disaster Brief: two table taps resets topic & assigns next speaker."],
    quirk:"Adds 'allegedly' to claims if alcohol is present.",
    con:"On triangles/angles must estimate degrees aloud; off by >10¬∞ ‚Üí draw a napkin protractor.",
    ability:{ name:"Avalanche Protocol", desc:"Clap twice: 30-sec evac drill. Everyone swaps seats & surrenders a small item; you redistribute.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Pilar "Pili" Casta√±o", codename:"POWDER KEG", cover:"Luxury Lodge Event Coordinator",
    publicBio:"Spanish social engineer; diplomacy with a splash of chaos.",
    privateBio:"Trans man. Ran weapons through receptions. Still RSVP's 'maybe' to Interpol.",
    background:"Human terrain ops; embassy events fixer.",
    discharge:"Dishonourable (creative import/export).",
    secretMission:"Get a stranger to announce you as 'His Excellency the Ambassador of Apr√®s'.",
    perks:["VIP Gate: others must introduce you with a flamboyant invented title.",
           "Guest List: 'You're on the list' ‚Üí 2-min private chat to assign a micro-task."],
    quirk:"Refuses real names; assigns callsigns.",
    con:"On any rumour he must add 'exclusive source' + wink; if asked later 'source?' must admit 'It was me.'",
    ability:{ name:"Task the Mark", desc:"Nominate any player to get a phone #, key/card, or selfie with anyone within 20 min. Failure = penalty.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Dmitri "Dima" Volkov", codename:"ICEPICK", cover:"Artisanal Spirits Consultant",
    publicBio:"Ex-Spetsnaz (allegedly). Measures every drink. Speaks in Celsius.",
    privateBio:"Defected‚Äîor didn't. Awaits a signal only he'd recognize.",
    background:"Urban recon & counter-human intel.",
    discharge:"'Special transfer' during the Sochi Olympics.",
    secretMission:"Learn a new vodka toast and perform it with the group.",
    perks:["Cold Stare: on eye contact the other must break first or penalty.",
           "Vodka Toast Override: on 'Na zdorovye', all must toast; 30s to find alcohol or penalty."],
    quirk:"Answers 'roger' instead of 'yes' and ends sentences with 'over.'",
    con:"When a new person arrives, he must pat pockets: 'ID, keys, exit‚Äîroger'; if caught skipping ‚Üí 10-sec bug sweep.",
    ability:{ name:"Charm Offensive (vodka-only)", desc:"Before midnight compel 3 people to buy you vodka drinks. Refusal/wrong drink = penalty.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Rowan "Ro" Hart", codename:"WOLFTRAP", cover:"Night Security Analyst",
    publicBio:"Ex-infantry turned nightclub perimeter whisperer. Hears bouncers before the bass.",
    privateBio:"Trans man. Thinks velvet ropes are guidelines. Once dated a smoke machine.",
    background:"Perimeter defense & crowd control.",
    discharge:"Honourable.",
    secretMission:"Convince a venue staffer to radio-check you using a callsign you invent.",
    perks:["Line Cutter: may insert yourself into any group; someone must introduce you within 20s.",
           "Bouncer's Choice: point to the door; one person must accompany you for a 60s perimeter check."],
    quirk:"Counts exits (quietly) when entering a room.",
    con:"If music changes, must freeze for 3s like a motion sensor.",
    ability:{ name:"Angle Check (10-sec hold)", desc:"Command a target to strike a dramatic pose facing a 'camera' for 10 seconds. Everyone must try not to laugh.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Asher "Ash" Del Mar", codename:"SEALEVEL", cover:"Hydro Logistics Planner",
    publicBio:"Special forces boat guy who gets altitude sickness looking at menus.",
    privateBio:"Smuggled a jet-ski into a hotel fountain. Twice.",
    background:"Riverine logistics & insertions.",
    discharge:"Honourable (but wet).",
    secretMission:"Collect three coasters from different venues and arrange a 'map' on the table.",
    perks:["High-Water Mark: pick a 'shoreline' on the table; items crossing it owe you a sip.",
           "Docking Fee: anyone returning to the group pays you a one-word status update."],
    quirk:"Adds boat metaphors to everything.",
    con:"If someone says 'wave', must salute like a lifeguard.",
    ability:{ name:"Harbour Master", desc:"Declare the current table 'Port'. Anyone joining owes you a status report + cheers.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Noah "Knox" Keegan", codename:"SWITCHBACK", cover:"Mountain Bike Guide",
    publicBio:"Downhill brain, uphill charm. Always plotting the next corner.",
    privateBio:"Claims a scar for each Greek letter he remembers. Many letters; suspicious count.",
    background:"Bike-mounted patrol & courier.",
    discharge:"Honourable.",
    secretMission:"Borrow a helmet from someone not in your group and wear it for 2 minutes.",
    perks:["Gear Check: on 'Drop a gear', everyone lowers voice one notch for 2 min.",
           "Trail Marshal: you decide who speaks next for 60s."],
    quirk:"Claps once when he stands up.",
    con:"If someone says 'brake', must freeze mid-gesture for 2s.",
    ability:{ name:"Trail Tax (chaos)", desc:"Pick two people to swap seats & share a 'route apology'.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Jamie "Harrow" Quinn", codename:"BONESAW", cover:"Field Medic (Former)",
    publicBio:"Good with stitches; terrible with boundaries. Brings tape to conversations.",
    privateBio:"Kept a toe tag as a bookmark. It fell out at a funeral.",
    background:"Combat medic; mass-casualty triage.",
    discharge:"Honourable; 'bedside manner incompatible with brass'.",
    secretMission:"Bandage (real or improvised) a non-player and get them to rate your care /10.",
    perks:["Triage: you may interrupt any chat to ask 'Vitals?'‚Äîanswer must be a number.",
           "Sterile Field: designate a 30 cm zone around your drink; violators owe an apology shot."],
    quirk:"Calls snacks 'oral medication'.",
    con:"If someone says 'owie', must produce a bandage (real or improvised).",
    ability:{ name:"Scrub In", desc:"Declare an emergency consult; target must whisper their last snack & biggest fear.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Elliot "Ledger" Vance", codename:"COUNTERSIGN", cover:"Casino Surveillance",
    publicBio:"Counts cards, people, and regrets. Mostly people.",
    privateBio:"Wears mirrored sunglasses at night because 'math is bright'.",
    background:"Surveillance, pattern analysis.",
    discharge:"Honourable; immediately banned from three casinos.",
    secretMission:"Convince someone to speak only in numbers with you for 30 seconds.",
    perks:["Tell Read: you may ask someone to repeat a sentence slower.",
           "Double Down: once, force a yes/no commitment from the table."],
    quirk:"Murmurs odds to himself.",
    con:"If anyone says a number >10, must whisper a different random number.",
    ability:{ name:"Background Count", desc:"Ask the GM for a one-line statistical hint about any player.", usesPerDay:1 },
    role:"handler"
  },
  { alias:"Rafe "Static" Moretti", codename:"JAMMER", cover:"RF Tech",
    publicBio:"Carries more antennas than personality. Still‚Ä¶ weirdly charming.",
    privateBio:"Blocked a wedding livestream so the bride's ex couldn't watch. She thanked him.",
    background:"Signals intelligence & EW.",
    discharge:"Honourable; requested more batteries than the army owned.",
    secretMission:"Get a stranger to say 'Say again?' twice in one conversation.",
    perks:["Signal Check: say 'Bars?' ‚Üí everyone must show phone lock screen for 3s.",
           "Dead Zone: pick a corner where nobody may use phones for 5 min."],
    quirk:"Says 'Copy' to compliments.",
    con:"If someone says 'loud', must turn an imaginary knob.",
    ability:{ name:"Static Burst", desc:"Declare a 30-sec 'comms outage': everyone speaks in whispers only.", usesPerDay:1 },
    role:"innocent"
  }
];

/* ========== derived character from seat ========== */
function pickCharacterForSeat(seatKey){
  let h = 0; for(const c of seatKey) h = (h*31 + c.charCodeAt(0)) >>> 0;
  const base = CHARACTERS[h % CHARACTERS.length];
  return JSON.parse(JSON.stringify(base));
}

/* ========== role assignment ========== */
function assignRoles(players) {
  const roles = ['flipped_agent']; // Ensure one murderer
  const otherRoles = ['handler', 'wildcard', 'innocent'];
  
  // Fill remaining slots
  while (roles.length < players.length) {
    roles.push(pick(otherRoles));
  }
  
  // Shuffle roles
  for (let i = roles.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [roles[i], roles[j]] = [roles[j], roles[i]];
  }
  
  return roles;
}

/* ========== state ========== */
let gameState = {};
let currentPlayer = null;

/* ========== Mock API for testing ========== */
// This is a simple in-memory storage for testing purposes
// Replace this with your actual backend API calls
let mockGameData = {};

async function api(op, body={}){
  // Simulate network delay
  await new Promise(resolve => setTimeout(resolve, 100));
  
  if(op === 'get'){
    const game = mockGameData[body.id];
    if(!game) return { ok: false, error: 'Game not found' };
    return { ok: true, session: game };
  }
  
  if(op === 'create'){
    const { sessionId, playerLimit, finalNightAt } = body;
    if(!sessionId) return { ok: false, error: 'Session ID required' };
    
    // Generate seats
    const seats = [];
    for(let i = 0; i < playerLimit; i++){
      seats.push({
        token: generateSeatToken(),
        claimed: false
      });
    }
    
    const game = {
      id: sessionId,
      playerLimit,
      finalNightAt,
      players: [],
      gameLog: [{ ts: Date.now(), msg: `Game ${sessionId} created with ${playerLimit} seats.` }],
      seats
    };
    
    mockGameData[sessionId] = game;
    return { ok: true, session: game, seats };
  }
  
  if(op === 'join'){
    const { sessionId, seatToken, playerName, character } = body;
    const game = mockGameData[sessionId];
    if(!game) return { ok: false, error: 'Game not found' };
    
    // Check if seat exists and is available
    const seat = game.seats?.find(s => s.token === seatToken);
    if(!seat) return { ok: false, error: 'Invalid seat token' };
    if(seat.claimed) return { ok: false, error: 'Seat already taken' };
    
    // Check if game is full
    if(game.players.length >= game.playerLimit) {
      return { ok: false, error: 'Game is full' };
    }
    
    // Create player
    const player = {
      id: `agent_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
      realName: playerName || 'Anonymous Agent',
      seatToken,
      ...character,
      missions: { active: null, count: 0 },
      abilityState: { usesLeft: character.ability?.usesPerDay ?? 1, lastResetDay: dayKey() }
    };
    
    // Assign roles if this is the last player
    if(game.players.length === game.playerLimit - 1) {
      const allPlayers = [...game.players, player];
      const roles = assignRoles(allPlayers);
      allPlayers.forEach((p, i) => p.role = roles[i]);
    }
    
    game.players.push(player);
    seat.claimed = true;
    
    game.gameLog.push({ 
      ts: Date.now(), 
      msg: `üé≠ ${player.codename} (${player.realName}) joined the operation.` 
    });
    
    return { ok: true, session: game, player };
  }
  
  if(op === 'event'){
    const { sessionId, msg } = body;
    const game = mockGameData[sessionId];
    if(!game) return { ok: false, error: 'Game not found' };
    
    game.gameLog.push({ ts: Date.now(), msg });
    return { ok: true };
  }
  
  if(op === 'update_player'){
    const { sessionId, playerId, patch } = body;
    const game = mockGameData[sessionId];
    if(!game) return { ok: false, error: 'Game not found' };
    
    const player = game.players.find(p => p.id === playerId);
    if(!player) return { ok: false, error: 'Player not found' };
    
    Object.assign(player, patch);
    return { ok: true, player };
  }
  
  return { ok: false, error: 'Unknown operation' };
}

function generateSeatToken() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let token = '';
  for(let i = 0; i < 4; i++) {
    token += chars[Math.floor(Math.random() * chars.length)];
  }
  token += '-';
  for(let i = 0; i < 4; i++) {
    token += chars[Math.floor(Math.random() * chars.length)];
  }
  return token;
}

async function postEvent(msg){
  const id = gameState.id || localStorage.getItem('session');
  if(!id) return;
  try{ 
    await api('event', { sessionId: id, msg }); 
    await refreshState(); // Refresh to show the new event
  } catch(e) {
    console.error('Failed to post event:', e);
  }
}

async function updateMe(patch){
  const sessionId = gameState.id || localStorage.getItem('session');
  const playerId = currentPlayer?.id || localStorage.getItem('playerId');
  if(!sessionId || !playerId) return;
  try{
    const res = await api('update_player', { sessionId, playerId, patch });
    if(res?.ok && res.player){ 
      currentPlayer = res.player; 
      renderDossier(); // Update UI immediately
    }
  } catch(e) {
    console.error('Failed to update player:', e);
  }
}

/* ========== GM actions ========== */
async function createGame(){
  const sessionId = ($('sessionId').value||'').toUpperCase().trim();
  const playerLimit = Number($('playerCount').value||6);
  const finalNightAt = $('finalNightAt').value ? new Date($('finalNightAt').value).getTime() : null;

  if(!sessionId) {
    uiMsg('gmMsg', '‚ùå Please enter a game key');
    return;
  }

  const res = await api('create', { sessionId, playerLimit, finalNightAt });
  if(!res.ok){ 
    uiMsg('gmMsg','‚ùå '+(res.error||'Create failed')); 
    return; 
  }

  localStorage.setItem('gm_session', res.session.id);
  uiMsg('gmMsg', `‚úÖ Game ${res.session.id} created with ${res.session.playerLimit} seats`);
  $('gameKeyLogin').value = res.session.id;
  renderSeats(res.seats||[]);
  await refreshState();
}

function renderSeats(seats){
  if(!seats || seats.length === 0) return;
  $('seatList').innerHTML = seats.map(s=>`
    <div class="card">
      <div><strong>${s.token}</strong></div>
      <div class="small muted">${s.claimed ? 'Claimed' : 'Open'}</div>
      <div class="row" style="margin-top:6px">
        <button class="btn sec" style="padding:6px 10px" onclick="copyText('${s.token}')">Copy</button>
      </div>
    </div>
  `).join('');
}

function copyGameLink(){
  const id = $('sessionId').value || localStorage.getItem('gm_session') || '';
  if(!id){ 
    uiMsg('gmMsg','No game key yet.'); 
    return; 
  }
  const url = `${location.origin}${location.pathname}?session=${encodeURIComponent(id)}`;
  copyText(url);
  uiMsg('gmMsg','Copied join link (key only).');
}

/* ========== Player actions ========== */
async function joinGame(){
  const sessionId = ($('gameKeyLogin').value||'').toUpperCase().trim();
  const seatToken = ($('seatKey').value||'').toUpperCase().trim();
  const playerName = ($('playerName').value||'').trim();
  
  if(!sessionId || !seatToken){ 
    uiMsg('loginMsg','Enter game key and seat key'); 
    return; 
  }

  const char = pickCharacterForSeat(seatToken);
  char.adoptedName = char.alias;

  const res = await api('join', { sessionId, seatToken, playerName, character: char });
  if(!res.ok){ 
    uiMsg('loginMsg','‚ùå '+(res.error||'Join failed')); 
    return; 
  }

  localStorage.setItem('session', res.session.id);
  localStorage.setItem('seatToken', seatToken);
  localStorage.setItem('playerId', res.player.id);

  currentPlayer = res.player;
  gameState = res.session;
  await refreshState();
  showDashboard();
  uiMsg('loginMsg', '‚úÖ Successfully joined the operation!');
}

async function refreshState(){
  const id = localStorage.getItem('session') || localStorage.getItem('gm_session') || ($('sessionId').value||'').toUpperCase();
  if(!id) return;
  
  const res = await api('get', { id });
  if(!res.ok) {
    console.error('Failed to refresh state:', res.error);
    return;
  }
  
  gameState = res.session || {};

  const myId = localStorage.getItem('playerId');
  if(myId) {
    currentPlayer = (gameState.players||[]).find(p=>p.id===myId) || currentPlayer;
  }

  renderRoster();
  renderLog();
  if(currentPlayer) renderDossier();
  populateTargets();
  if(res.seats) renderSeats(res.seats);
}

function showDashboard(){
  $('gmPanel').classList.add('hidden');
  $('loginPanel').classList.add('hidden');
  $('dashPanel').classList.remove('hidden');
  $('gameKeyText').textContent = gameState.id || localStorage.getItem('session') || '‚Äî';
  $('finalNightText').textContent = gameState.finalNightAt ? new Date(gameState.finalNightAt).toLocaleString() : '‚Äî';
}

function leaveSeat(){
  localStorage.removeItem('session');
  localStorage.removeItem('seatToken');
  localStorage.removeItem('playerId');
  currentPlayer = null;
  gameState = {};
  location.reload();
}

/* ========== Renderers ========== */
function renderDossier(){
  if(!currentPlayer) return;
  const p = currentPlayer;
  $('codenameText').textContent = p.codename || 'OPERATIVE';
  $('agentIdText').textContent = p.id || '‚Äî';
  $('realNameText').textContent = p.realName || '‚Äî';
  $('aliasText').textContent = p.adoptedName || p.alias || '‚Äî';
  $('coverText').textContent = p.cover || '‚Äî';
  $('backgroundText').textContent = p.background || '‚Äî';
  $('dischargeText').textContent = p.discharge || '‚Äî';
  $('secretMissionText').textContent = p.secretMission || '‚Äî';
  $('quirkText').textContent = p.quirk || '‚Äî';
  $('conText').textContent = p.con || '‚Äî';

  const role = ROLES[p.role] || {name:p.role||'‚Äî', obj:'‚Äî', win:'‚Äî'};
  $('roleText').textContent = role.name;
  $('roleObjective').textContent = role.obj;
  $('roleWin').textContent = role.win;

  const perks = (p.perks||[]).map(x=>`<li>${x}</li>`).join('') || '<li>‚Äî</li>';
  $('perkList').innerHTML = perks;

  $('abilityName').innerHTML = `<strong>${p.ability?.name||'‚Äî'}</strong>`;
  $('abilityDesc').textContent = p.ability?.desc || '‚Äî';

  const usesLeft = abilityUsesLeft();
  $('abilityUsesLeft').textContent = usesLeft;
  const b = $('abilityBadge');
  b.className = 'badge ' + (usesLeft>0 ? 'b-ready':'b-used');
  b.textContent = usesLeft>0 ? 'READY':'USED';

  // Update mission display
  const missions = p.missions || { active: null, count: 0 };
  $('missionText').textContent = missions.active || 'None. Request one below.';
  $('missionCount').textContent = missions.count || 0;
}

function renderRoster(){
  const list = gameState.players || [];
  $('rosterList').innerHTML = list.length ? list.map(p=>{
    const perks = (p.perks||[]).map(x=>`<li>${x}</li>`).join('') || '<li>‚Äî</li>';
    const me = (currentPlayer && p.id===currentPlayer.id) ? ' (you)' : '';
    return `
      <div class="card" style="margin:8px 0">
        <div class="row" style="justify-content:space-between">
          <div><strong class="code">${p.codename}</strong> ‚Äî ${p.realName}${me}</div>
          <div class="small muted">${p.id}</div>
        </div>
        <div class="small">${p.cover||''}</div>
        <div class="grid g3" style="margin-top:8px">
          <div><div class="small muted">Public Bio</div>${p.publicBio||'‚Äî'}</div>
          <div><div class="small muted">Quirk</div>${p.quirk||'‚Äî'}</div>
          <div><div class="small muted">Con</div>${p.con||'‚Äî'}</div>
        </div>
        <div style="margin-top:6px"><div class="small muted">Perks</div><ul style="margin:6px 0 0 18px">${perks}</ul></div>
      </div>
    `;
  }).join('') : '<div class="muted">No agents yet.</div>';
}

function renderLog(){
  const log = gameState.gameLog || [];
  const recent = log.slice(-50); // Show last 50 events
  $('logView').innerHTML = recent.length ? recent.map(l=>
    `<div class="line"><strong>[${new Date(l.ts).toLocaleTimeString()}]</strong> ${l.msg}</div>`
  ).join('') : '<div class="muted">No events yet.</div>';
  
  // Auto-scroll to bottom
  const el = $('logView'); 
  if(el) el.scrollTop = el.scrollHeight;
}

function populateTargets(){
  const others = (gameState.players||[]).filter(p=>!currentPlayer || p.id!==currentPlayer.id);
  const fill = (id)=>{ 
    const sel=$(id); 
    if(!sel) return;
    sel.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
    others.forEach(p=>{
      const o=document.createElement('option'); 
      o.value=p.id; 
      o.textContent=`${p.codename} (${p.realName})`; 
      sel.appendChild(o); 
    });
  };
  fill('abilityTargetSelect'); 
  fill('actionTarget');
}

/* ========== Ability logic ========== */
function dayKey(){ 
  const d=new Date(); 
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; 
}

function abilityUsesLeft(){
  if(!currentPlayer) return 0;
  const st = currentPlayer.abilityState || {
    usesLeft: (currentPlayer.ability?.usesPerDay ?? 1), 
    lastResetDay: dayKey()
  };
  
  if(st.lastResetDay !== dayKey()){
    st.lastResetDay = dayKey();
    st.usesLeft = currentPlayer.ability?.usesPerDay ?? 1;
    currentPlayer.abilityState = st;
    updateMe({abilityState: st});
  }
  return st.usesLeft ?? 0;
}

async function useAbility(){
  if(!currentPlayer?.ability) return;
  const left = abilityUsesLeft();
  if(left <= 0){ 
    await postEvent(`‚ö†Ô∏è ${currentPlayer.codename} tried to use ability but has no uses left.`); 
    return; 
  }

  const selId = $('abilityTargetSelect').value || '';
  const typed = ($('abilityTargetId').value||'').trim();
  const target = (gameState.players||[]).find(p=> p.id === (selId||typed));
  const tLabel = target ? `${target.codename} (${target.realName})` : '‚Äî';

  const st = currentPlayer.abilityState || {usesLeft:1,lastResetDay:dayKey()};
  st.usesLeft = Math.max(0, (st.usesLeft??1)-1);
  currentPlayer.abilityState = st;
  
  await updateMe({abilityState:st});
  await postEvent(`‚ö° ${currentPlayer.codename} used "${currentPlayer.ability.name}" on ${tLabel}.`);
  
  $('abilityTargetId').value='';
  $('abilityTargetSelect').value='';
}

/* ========== Missions ========== */
function ensureMissionState(){
  if(!currentPlayer.missions) {
    currentPlayer.missions = {active:null, count:0};
  }
  return currentPlayer.missions;
}

async function requestMission(){
  const ms = ensureMissionState();
  if(ms.active){ 
    await postEvent(`${currentPlayer.codename} requested new mission without completing previous ‚Üí group consensus penalty?`); 
  }
  ms.active = pick(MISSIONS);
  await updateMe({missions:ms});
  await postEvent(`üìã ${currentPlayer.codename} drew a mission: "${ms.active}"`);
}

async function completeMission(){
  const ms = ensureMissionState();
  if(!ms.active){ 
    await postEvent(`${currentPlayer.codename} tried to complete a mission but has none active.`);
    return; 
  }
  await postEvent(`‚úÖ ${currentPlayer.codename} completed mission: "${ms.active}"`);
  ms.active = null; 
  ms.count = (ms.count||0)+1;
  await updateMe({missions:ms});
}

async function failMission(){
  const ms = ensureMissionState();
  if(!ms.active){ 
    await requestMission(); 
    return; 
  }
  await postEvent(`‚ùå ${currentPlayer.codename} failed mission: "${ms.active}" ‚Äî new mission requested.`);
  ms.active = pick(MISSIONS);
  await updateMe({missions:ms});
}

/* ========== Actions ========== */
function labelFor(id){ 
  const p=(gameState.players||[]).find(x=>x.id===id); 
  return p ? `${p.codename} (${p.realName})` : (id||'‚Äî'); 
}

async function submitAction(){
  if(!currentPlayer) return;
  
  const type = $('actionType').value;
  const target = $('actionTarget').value;
  const details = ($('actionDetails').value||'(no details)').trim();
  let text = '';
  
  if(type==='penalty') {
    text = `üîç Penalty on ${labelFor(target)} ‚Äî ${details}`;
  } else if(type==='task_complete') {
    text = `üîç Task complete by ${currentPlayer.codename} ‚Äî ${details}`;
  } else if(type==='murderer_act') {
    text = `üîç Murderer act report by ${currentPlayer.codename} ‚Äî ${details}`;
  } else {
    text = `üîç Ability use by ${currentPlayer.codename} on ${labelFor(target)} ‚Äî ${details}`;
  }
  
  await postEvent(text);
  $('actionDetails').value=''; 
  $('actionTarget').value='';
}

/* ========== boot / auto-rejoin ========== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const qs = new URLSearchParams(location.search);
  const urlSession = (qs.get('session')||'').toUpperCase();
  if(urlSession){
    $('sessionId').value = urlSession;
    $('gameKeyLogin').value = urlSession;
    localStorage.setItem('gm_session', urlSession);
  }

  const session = localStorage.getItem('session');
  const seatToken = localStorage.getItem('seatToken');
  const playerId = localStorage.getItem('playerId');
  
  if(session && seatToken && playerId){
    try{
      await refreshState();
      if(gameState.players?.find(p => p.id === playerId)) {
        showDashboard();
      }
    } catch(e) { 
      console.error('Auto-rejoin failed:', e);
    }
  } else {
    const gm = localStorage.getItem('gm_session');
    if(gm){ 
      $('sessionId').value = gm; 
      $('gameKeyLogin').value = gm; 
      await refreshState(); 
    }
  }
});
</script>
</body>
</html>
