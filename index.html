<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dishonourable Discharge</title>
  <style>
    :root{
      --bg:#0a0a0a; --bg2:#1a1a2e; --bg3:#16213e;
      --red:#ff4757; --vio:#5f27cd; --vio2:#7c3aed; --ora:#ffa500; --blue:#3498db; --green:#27ae60;
      --fg:#e0e0e0; --muted:#9bbcff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Courier New',monospace;color:var(--fg);min-height:100vh;
      background:linear-gradient(135deg,var(--bg),var(--bg2),var(--bg3));padding:18px}
    .wrap{max-width:1000px;margin:0 auto;background:rgba(0,0,0,.9);border:2px solid var(--red);
      border-radius:16px;padding:22px;box-shadow:0 0 40px rgba(255,71,87,.25);position:relative}
    .stamp{position:absolute;top:20px;right:20px;background:var(--red);color:#000;
      padding:7px 14px;border:3px solid #000;transform:rotate(10deg);font-weight:bold}
    h1{margin:0 0 6px;color:var(--red);text-shadow:0 0 18px rgba(255,71,87,.7);letter-spacing:3px;text-align:center}
    .sub{color:var(--vio);text-align:center;margin-bottom:20px}
    .section{background:rgba(255,255,255,.03);border-left:4px solid var(--vio);border-radius:10px;padding:18px;margin:14px 0}
    .title{color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:760px){.g2,.g3{grid-template-columns:1fr}}
    label{display:block;margin-bottom:6px;color:var(--vio);font-weight:bold;font-size:.88em;letter-spacing:.5px}
    input,select{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid var(--vio);border-radius:8px;color:var(--fg)}
    .btn{background:linear-gradient(45deg,var(--red),#ff6b7a);color:#000;border:none;padding:12px 16px;border-radius:8px;
      font-weight:bold;cursor:pointer;transition:.15s;text-transform:uppercase;letter-spacing:1px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(255,71,87,.45)}
    .btn.sec{background:linear-gradient(45deg,var(--vio),var(--vio2));color:#fff}
    .btn.out{background:transparent;border:2px dashed var(--vio);color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{font-size:.85em;color:var(--muted)}
    .card{border:1px dashed var(--vio);border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stamp">TOP SECRET</div>
    <h1>DISHONOURABLE DISCHARGE</h1>
    <div class="sub">Operation: Alpine Debrief</div>

    <!-- GM PANEL -->
    <div id="gmPanel" class="section">
      <div class="title">üéÆ Game Master Control</div>
      <div class="grid g3">
        <div>
          <label>Game Key</label>
          <input id="sessionId" placeholder="e.g. QT1" />
        </div>
        <div>
          <label>Player Limit</label>
          <select id="playerCount">
            <option>3</option><option>4</option><option>5</option>
            <option selected>6</option><option>8</option><option>12</option>
          </select>
        </div>
        <div>
          <label>Final Night (unlocks scans/accusations)</label>
          <input type="datetime-local" id="finalNightAt"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="createGame()">Create Game</button>
        <button class="btn sec" onclick="refreshState()">Refresh State</button>
        <button class="btn out" onclick="copyGameLink()">Copy Join Link (Key Only)</button>
      </div>
      <div id="gmMsg" class="small" style="margin-top:8px"></div>
      <div id="seatList" class="grid g3" style="margin-top:10px"></div>
    </div>

    <!-- LOGIN PANEL -->
    <div id="loginPanel" class="section">
      <div class="title">üîê Player Login</div>
      <div class="grid g3">
        <div>
          <label>Your Name</label>
          <input id="playerName" placeholder="e.g. Kaleb"/>
        </div>
        <div>
          <label>Game Key</label>
          <input id="gameKeyLogin" placeholder="e.g. QT1"/>
        </div>
        <div>
          <label>Seat Key</label>
          <input id="seatKey" placeholder="e.g. AB1C-9XYZ"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="joinGame()">Join Game</button>
        <button class="btn sec" onclick="refreshState()">Refresh State</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px"></div>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
function uiMsg(id, text){ const el=$(id); if(el) el.textContent = text||''; }
function copyText(t){ navigator.clipboard.writeText(t); }

/* ---------- API ---------- */
async function api(op, body={}){
  if(op==='get'){
    const r = await fetch(`/api/game?id=${encodeURIComponent(body.id)}`, { cache:'no-store' });
    try { return await r.json(); } catch { return { ok:false, error:'Bad JSON' }; }
  }
  const r = await fetch('/api/game', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({op, ...body})
  });
  try { return await r.json(); } catch { return { ok:false, error:'Bad JSON' }; }
}

/* ---------- GM ---------- */
async function createGame(){
  const sessionId = ($('sessionId').value||'').toUpperCase().trim();
  const playerLimit = Number($('playerCount').value||6);
  const finalNightAt = $('finalNightAt').value ? new Date($('finalNightAt').value).getTime() : null;
  const res = await api('create', { sessionId, playerLimit, finalNightAt });
  if(!res.ok){ uiMsg('gmMsg','‚ùå '+(res.error||'Create failed')); return; }
  localStorage.setItem('gm_session', res.session.id);
  $('gameKeyLogin').value = res.session.id;
  uiMsg('gmMsg', `‚úÖ Game ${res.session.id} created (limit ${res.session.playerLimit})`);
  renderSeats(res.seats||[]);
}
function renderSeats(seats){
  $('seatList').innerHTML = seats.map(s=>`
    <div class="card">
      <div><strong>${s.token}</strong></div>
      <div class="small">${s.claimed ? 'Claimed' : 'Open'}</div>
      <div style="margin-top:6px">
        <button class="btn sec" style="padding:6px 10px" onclick="copyText('${s.token}')">Copy</button>
      </div>
    </div>`).join('');
}
function copyGameLink(){
  const id = $('sessionId').value || localStorage.getItem('gm_session') || '';
  if(!id){ uiMsg('gmMsg','No game key yet.'); return; }
  const url = `${location.origin}${location.pathname}?session=${encodeURIComponent(id)}`;
  copyText(url);
  uiMsg('gmMsg','Copied join link (key only).');
}
async function refreshState(){
  const id = localStorage.getItem('gm_session') || ($('sessionId').value||'').toUpperCase();
  if(!id) return;
  const res = await api('get', { id });
  if(!res.ok) return;
  if(res.seats) renderSeats(res.seats);
}

/* ---------- Player Join ---------- */
async function joinGame(){
  const sessionId = ($('gameKeyLogin').value||'').toUpperCase().trim();
  const seatToken = ($('seatKey').value||'').toUpperCase().trim();
  const playerName = ($('playerName').value||'').trim();
  if(!sessionId || !seatToken){ uiMsg('loginMsg','Enter game key and seat key'); return; }

  // minimal character stub here; full character picked on agent page from seat (kept backwards compatible)
  const res = await api('join', { sessionId, seatToken, playerName });
  if(!res.ok){ uiMsg('loginMsg','‚ùå '+(res.error||'Join failed')); return; }

  // persist & go to dashboard page
  localStorage.setItem('session', res.session.id);
  localStorage.setItem('seatToken', seatToken);
  localStorage.setItem('playerId', res.player.id);
  window.location.href = 'agent.html?session=' + encodeURIComponent(res.session.id);
}

/* ---------- boot ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  const qs = new URLSearchParams(location.search);
  const urlSession = (qs.get('session')||'').toUpperCase();
  if(urlSession){
    $('sessionId').value = urlSession;
    $('gameKeyLogin').value = urlSession;
    localStorage.setItem('gm_session', urlSession);
    await refreshState();
  }
});
</script>
</body>
</html>
