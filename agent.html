<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agent Dashboard ¬∑ Dishonourable Discharge</title>
  <style>
    :root{
      --bg:#0a0a0a; --bg2:#1a1a2e; --bg3:#16213e;
      --red:#ff4757; --vio:#5f27cd; --vio2:#7c3aed; --ora:#ffa500; --blue:#3498db; --green:#27ae60;
      --fg:#e0e0e0; --muted:#9bbcff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Courier New',monospace;color:var(--fg);min-height:100vh;
      background:linear-gradient(135deg,var(--bg),var(--bg2),var(--bg3));padding:18px}
    .wrap{max-width:1100px;margin:0 auto;background:rgba(0,0,0,.92);border:2px solid var(--red);
      border-radius:16px;padding:22px;box-shadow:0 0 40px rgba(255,71,87,.25);position:relative}
    .stamp{position:absolute;top:20px;right:20px;background:var(--red);color:#000;
      padding:7px 14px;border:3px solid #000;transform:rotate(10deg);font-weight:bold}
    h1{margin:0 0 6px;color:var(--red);text-shadow:0 0 18px rgba(255,71,87,.7);letter-spacing:3px}
    .small{color:var(--muted);font-size:.88em}
    .section{background:rgba(255,255,255,.03);border-left:4px solid var(--vio);border-radius:10px;padding:18px;margin:14px 0}
    .title{color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:920px){.g4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:760px){.g2,.g3{grid-template-columns:1fr}}
    .card{border:1px dashed var(--vio);border-radius:10px;padding:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .code{color:var(--red);font-weight:bold}
    .btn{background:linear-gradient(45deg,var(--blue),#78a9ff);color:#000;border:none;padding:10px 14px;border-radius:8px;
      font-weight:bold;cursor:pointer}
    .btn.alt{background:linear-gradient(45deg,var(--vio),var(--vio2));color:#fff}
    .btn.warn{background:linear-gradient(45deg,var(--red),#ff6b7a);color:#000}
    .btn.ghost{background:transparent;border:2px dashed var(--vio);color:var(--muted)}
    select,input{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid var(--vio);border-radius:8px;color:var(--fg)}
    .log{max-height:280px;overflow:auto;background:rgba(0,0,0,.45);border:2px solid var(--vio);border-radius:10px;padding:12px}
    .line{border-left:3px solid var(--vio);padding-left:10px;margin:8px 0;background:rgba(95,39,205,.12);border-radius:4px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78em;font-weight:bold}
    .b-ready{background:#27ae60;color:#fff}.b-used{background:#e74c3c;color:#fff}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="stamp">CLASSIFIED</div>
  <h1>AGENT DASHBOARD</h1>
  <div class="small">Game: <span id="gameId">‚Äî</span> ¬∑ Final Night: <span id="finalNight">‚Äî</span> ¬∑ You: <span id="agentId">‚Äî</span></div>

  <div class="controls">
    <button class="btn" id="btnRefresh">Refresh</button>
    <button class="btn ghost" id="btnBack">Back to Login</button>
    <button class="btn warn" id="btnLeave">Leave Seat</button>
  </div>

  <div class="section">
    <div class="title">Dossier</div>
    <div class="grid g3">
      <div class="card">
        <div class="small">Your Name</div><div id="realName">‚Äî</div>
        <div class="small" style="margin-top:6px">Adopted Character Name</div><div id="adopted">‚Äî</div>
        <div class="small" style="margin-top:6px">Cover Identity</div><div id="cover">‚Äî</div>
      </div>
      <div class="card">
        <div class="small">Operative Codename</div><div class="code" id="codename">‚Äî</div>
        <div class="small" style="margin-top:6px">Operational Role</div><div id="role">‚Äî</div>
        <div class="small" style="margin-top:6px">Role Objective</div><div id="roleObj">‚Äî</div>
        <div class="small" style="margin-top:6px">Win Condition</div><div id="roleWin">‚Äî</div>
      </div>
      <div class="card">
        <div class="small">Secret Mission (you only)</div><div id="secret">‚Äî</div>
      </div>
    </div>

    <div class="grid g2" style="margin-top:10px">
      <div class="card"><div class="small">Background</div><div id="background">‚Äî</div></div>
      <div class="card"><div class="small">Discharge</div><div id="discharge">‚Äî</div></div>
    </div>

    <div class="grid g3" style="margin-top:10px">
      <div class="card"><div class="small">Perks</div><ul id="perks" style="margin:6px 0 0 18px"></ul></div>
      <div class="card"><div class="small">Behavioral Quirk</div><div id="quirk">‚Äî</div></div>
      <div class="card"><div class="small">Con</div><div id="con">‚Äî</div></div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small">Special Ability</div>
          <div id="abilityName"><strong>‚Äî</strong></div>
          <div class="small" id="abilityDesc">‚Äî</div>
        </div>
        <div>
          <span id="abilityBadge" class="badge b-ready">READY</span>
          <div class="small">Uses Left Today: <span id="usesLeft">1</span></div>
        </div>
      </div>
      <div class="grid g3" style="margin-top:10px">
        <div>
          <div class="small">Target (optional)</div>
          <select id="abilityTarget"></select>
        </div>
        <div>
          <div class="small">‚Ä¶or type Agent ID</div>
          <input id="abilityTargetId" placeholder="agent_xxx"/>
        </div>
        <div style="align-self:end">
          <button class="btn alt" id="useAbilityBtn">Use Ability</button>
        </div>
      </div>
    </div>
  </div>

  <div class="section" style="border-left-color:var(--ora)">
    <div class="title">Missions</div>
    <div class="card">
      <div class="small">Active Mission</div>
      <div id="missionText">None. Request one below.</div>
      <div class="row" style="margin-top:8px">
        <button class="btn alt" id="reqMission">Request Mission</button>
        <button class="btn" id="completeMission">Complete Mission</button>
        <button class="btn warn" id="failMission">Fail & Redraw</button>
      </div>
      <div class="small" style="margin-top:6px">Completed: <span id="missionCount">0</span></div>
    </div>
  </div>

  <div class="section">
    <div class="title">üóÇÔ∏è Public Roster (bios + perks/quirks/cons)</div>
    <div id="roster" class="grid g2"></div>
  </div>

  <div class="section" style="border-left-color:var(--blue)">
    <div class="title">Submit Action / Penalty / Task</div>
    <div class="grid g3">
      <div>
        <div class="small">Action Type</div>
        <select id="actionType">
          <option value="penalty">Report Penalty</option>
          <option value="task_complete">Task Complete</option>
          <option value="murderer_act">Report Murderer Act</option>
          <option value="ability">Use Ability (also above)</option>
        </select>
      </div>
      <div>
        <div class="small">Target Player</div>
        <select id="actionTarget"></select>
      </div>
      <div>
        <div class="small">Details</div>
        <input id="actionDetails" placeholder="What happened / instructions"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="submitAction">Submit</button>
    </div>
  </div>

  <div class="section" style="border-left-color:var(--vio2)">
    <div class="title">üì° Operation Log</div>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ===== core session plumbing ===== */
const $ = id => document.getElementById(id);
const qs = new URLSearchParams(location.search);
const sessionId = (qs.get('session') || localStorage.getItem('session') || '').toUpperCase();
if(sessionId) localStorage.setItem('session', sessionId);
const playerId = localStorage.getItem('playerId') || '';
const seatToken = (localStorage.getItem('seatToken') || qs.get('seat') || '').toUpperCase();

async function apiGet(id){
  const r = await fetch(`/api/game?id=${encodeURIComponent(id)}`);
  try{ return await r.json(); }catch{ return { ok:false }; }
}
async function postEventToServer(msg){
  // Optional op; if backend lacks 'event', this silently no-ops.
  try{
    const r = await fetch('/api/game', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ op:'event', sessionId, msg })
    });
    // ignore response; best-effort
  }catch(e){}
}

/* ===== roles ===== */
const ROLES = {
  flipped_agent:{ name:"The Flipped Agent", obj:"Stay hidden while sowing chaos. Frame others or recruit allies.", win:"Survive final vote OR flip another player." },
  handler:{ name:"The Handler", obj:"Identify the traitor through investigation and deduction.", win:"Correctly identify the Flipped Agent in the final vote." },
  wildcard:{ name:"The Wildcard", obj:"Survive and adapt; can align with either side.", win:"Align with the winning side OR complete your solo objectives." },
  innocent:{ name:"Innocent Operative", obj:"Identify the traitor and survive the final vote.", win:"Vote out the Flipped Agent OR survive to the end." }
};

/* ===== missions ===== */
const MISSIONS = [
  "Wear ski goggles to dinner; never explain why.",
  "Ask 3 strangers where the CIA safehouse is.",
  "Challenge someone to a snowball duel; loser does a shoey.",
  "Bring a random item to the bar and convince someone it‚Äôs priceless.",
  "Gain legit access to another player‚Äôs room for 15 minutes.",
  "Speak only in a fake Russian accent for 3 hours.",
  "Critique outfits using military terminology.",
  "Take a candid photo of every player undetected.",
  "Get someone to break a minor rule for you.",
  "Teach a stranger a codeword and use it later."
];

/* ===== local ability+mission state (until server adds update op) ===== */
function dayKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
function getAbilityState(defUses){
  let st = JSON.parse(localStorage.getItem('abilityState')||'null');
  if(!st){ st = { usesLeft:defUses, lastResetDay:dayKey() }; }
  if(st.lastResetDay !== dayKey()){
    st.lastResetDay = dayKey();
    st.usesLeft = defUses;
    localStorage.setItem('abilityState', JSON.stringify(st));
  }
  return st;
}
function setAbilityState(st){ localStorage.setItem('abilityState', JSON.stringify(st)); }

function getMissionState(){
  return JSON.parse(localStorage.getItem('missions')||'{"active":null,"count":0}');
}
function setMissionState(ms){ localStorage.setItem('missions', JSON.stringify(ms)); }

/* ===== renderers ===== */
let gameState=null, me=null, lastLogLen=0;

function renderTop(){
  $('gameId').textContent = gameState?.id || '‚Äî';
  $('finalNight').textContent = gameState?.finalNightAt ? new Date(gameState.finalNightAt).toLocaleString() : '‚Äî';
  $('agentId').textContent = me?.id || '‚Äî';
}

function renderDossier(){
  if(!me) return;
  $('realName').textContent = me.realName || '‚Äî';
  $('adopted').textContent = me.adoptedName || me.alias || '‚Äî';
  $('cover').textContent = me.cover || '‚Äî';
  $('codename').textContent = me.codename || 'OPERATIVE';

  const role = ROLES[me.role] || {name: me.role||'‚Äî', obj:'‚Äî', win:'‚Äî'};
  $('role').textContent = role.name; $('roleObj').textContent = role.obj; $('roleWin').textContent = role.win;

  $('secret').textContent = me.secretMission || '‚Äî';
  $('background').textContent = me.background || '‚Äî';
  $('discharge').textContent = me.discharge || '‚Äî';

  $('quirk').textContent = me.quirk || '‚Äî';
  $('con').textContent = me.con || '‚Äî';
  $('perks').innerHTML = (me.perks||[]).map(x=>`<li>${x}</li>`).join('') || '<li>‚Äî</li>';

  $('abilityName').innerHTML = `<strong>${me.ability?.name || '‚Äî'}</strong>`;
  $('abilityDesc').textContent = me.ability?.desc || '‚Äî';

  const defUses = me.ability?.usesPerDay ?? 1;
  const st = getAbilityState(defUses);
  $('usesLeft').textContent = st.usesLeft ?? 0;
  const b = $('abilityBadge');
  b.className = 'badge ' + ((st.usesLeft??0)>0 ? 'b-ready' : 'b-used');
  b.textContent = (st.usesLeft??0)>0 ? 'READY' : 'USED';
}

function renderRoster(){
  const others = (gameState?.players||[]).filter(p=>!me || p.id!==me.id);
  if(!others.length){ $('roster').innerHTML = '<div class="small">No other agents yet.</div>'; return; }
  $('roster').innerHTML = others.map(p=>{
    const perks = (p.perks||[]).map(x=>`<li>${x}</li>`).join('') || '<li>‚Äî</li>';
    return `
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div><strong class="code">${p.codename||'OPERATIVE'}</strong> ‚Äî ${p.realName||'Agent'}</div>
          <div class="small">${p.id}</div>
        </div>
        <div class="small" style="margin-top:4px"><em>${p.cover||''}</em></div>
        <div class="grid g2" style="margin-top:8px">
          <div><div class="small">Public Bio</div>${p.publicBio||'‚Äî'}</div>
          <div><div class="small">Behavioral Quirk</div>${p.quirk||'‚Äî'}</div>
        </div>
        <div class="grid g2" style="margin-top:8px">
          <div><div class="small">Con</div>${p.con||'‚Äî'}</div>
          <div>
            <div class="small">Perks</div>
            <ul style="margin:6px 0 0 18px">${perks}</ul>
          </div>
        </div>
      </div>
    `;
  }).join('');

  // target selectors
  const fillSel = (id)=>{
    const sel=$(id); if(!sel) return;
    sel.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
    others.forEach(p=>{
      const o=document.createElement('option');
      o.value=p.id; o.textContent=`${p.codename||'OPERATIVE'} (${p.realName||'Agent'})`;
      sel.appendChild(o);
    });
  };
  fillSel('abilityTarget'); fillSel('actionTarget');
}

function renderLog(){
  const rows = (gameState?.gameLog||[]).map(l=>`<div class="line"><strong>[${new Date(l.ts).toLocaleTimeString()}]</strong> ${l.msg}</div>`);
  $('log').innerHTML = rows.join('') || '<div class="small">No events yet.</div>';
  if((gameState?.gameLog||[]).length !== lastLogLen){
    $('log').scrollTop = $('log').scrollHeight;
    lastLogLen = (gameState?.gameLog||[]).length;
  }
}

/* ===== actions (client + optional server log) ===== */
function useAbility(){
  if(!me?.ability) return;
  const defUses = me.ability?.usesPerDay ?? 1;
  const st = getAbilityState(defUses);
  if((st.usesLeft??0)<=0){
    postEventToServer(`‚ö†Ô∏è ${me.codename} tried to use ability but has no uses left.`);
    return;
  }
  const targetId = $('abilityTarget').value || ($('abilityTargetId').value||'').trim();
  const target = (gameState?.players||[]).find(p=>p.id===targetId);
  const tLabel = target? `${target.codename||'OPERATIVE'} (${target.realName||'Agent'})` : '‚Äî';

  st.usesLeft = Math.max(0,(st.usesLeft??1)-1); setAbilityState(st);
  $('abilityTargetId').value=''; renderDossier();

  postEventToServer(`‚ö° ${me.codename} used "${me.ability.name}" on ${tLabel}.`);
}

function requestMission(){
  const ms = getMissionState();
  if(ms.active){
    postEventToServer(`${me.codename} requested a new mission without completing previous ‚Üí group consensus penalty?`);
  }
  ms.active = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
  setMissionState(ms);
  $('missionText').textContent = ms.active;
  postEventToServer(`üìã ${me.codename} drew a mission: "${ms.active}"`);
}
function completeMission(){
  const ms = getMissionState(); if(!ms.active) return;
  postEventToServer(`‚úÖ ${me.codename} completed mission: "${ms.active}"`);
  ms.active=null; ms.count=(ms.count||0)+1; setMissionState(ms);
  $('missionText').textContent = 'None. Request one below.'; $('missionCount').textContent = ms.count;
}
function failMission(){
  const ms = getMissionState();
  if(ms.active){ postEventToServer(`‚ùå ${me.codename} failed mission: "${ms.active}" ‚Äî new mission requested.`); }
  ms.active = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
  setMissionState(ms);
  $('missionText').textContent = ms.active;
}
function submitAction(){
  const type = $('actionType').value;
  const target = $('actionTarget').value;
  const details = ($('actionDetails').value || '(no details)').trim();
  const p = (gameState?.players||[]).find(x=>x.id===target);
  const label = p? `${p.codename||'OPERATIVE'} (${p.realName||'Agent'})` : (target||'‚Äî');
  let text = '';
  if(type==='penalty') text = `üìù Penalty on ${label} ‚Äî ${details}`;
  else if(type==='task_complete') text = `üìù Task complete by ${me.codename} ‚Äî ${details}`;
  else if(type==='murderer_act') text = `üìù Murderer act report by ${me.codename} ‚Äî ${details}`;
  else text = `üìù Ability use by ${me.codename} on ${label} ‚Äî ${details}`;
  $('actionDetails').value=''; $('actionTarget').value='';
  postEventToServer(text);
}

/* ===== boot & polling ===== */
async function refresh(){
  if(!sessionId){ $('log').innerHTML = '<div class="small">Open via the join flow ‚Äî no session id.</div>'; return; }
  const r = await apiGet(sessionId);
  if(!r?.ok){ $('log').innerHTML = '<div class="small">Session not found.</div>'; return; }
  gameState = r.session;

  // who am I?
  me = (gameState.players||[]).find(p=>p.id===playerId) || null;
  if(!me && seatToken){
    const seat = (gameState.seats||[]).find(s=>(s.token||'').toUpperCase()===seatToken);
    if(seat?.playerId) me = (gameState.players||[]).find(p=>p.id===seat.playerId) || null;
  }
  if(!me){ $('log').innerHTML = '<div class="small">Player not found in this session.</div>'; return; }

  renderTop();
  renderDossier();
  renderRoster();
  renderLog();

  // load mission local state to UI
  const ms = getMissionState();
  $('missionText').textContent = ms.active || 'None. Request one below.';
  $('missionCount').textContent = ms.count || 0;
}

document.addEventListener('DOMContentLoaded', ()=>{
  $('useAbilityBtn').onclick = useAbility;
  $('reqMission').onclick = requestMission;
  $('completeMission').onclick = completeMission;
  $('failMission').onclick = failMission;
  $('submitAction').onclick = submitAction;

  $('btnRefresh').onclick = refresh;
  $('btnBack').onclick = ()=>{ location.href = `index.html?session=${encodeURIComponent(sessionId)}`; };
  $('btnLeave').onclick = ()=>{
    localStorage.removeItem('playerId');
    localStorage.removeItem('seatToken');
    location.href = `index.html?session=${encodeURIComponent(sessionId)}`;
  };

  refresh();
  setInterval(refresh, 4000);
});
</script>
</body>
</html>
