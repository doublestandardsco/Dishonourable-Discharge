<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dishonourable Discharge ‚Äî Agent</title>
  <style>
    :root{
      --bg:#0a0a0a; --bg2:#1a1a2e; --bg3:#16213e;
      --red:#ff4757; --vio:#5f27cd; --vio2:#7c3aed; --ora:#ffa500; --blue:#3498db; --green:#27ae60;
      --fg:#e0e0e0; --muted:#9bbcff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Courier New',monospace;color:var(--fg);min-height:100vh;
      background:linear-gradient(135deg,var(--bg),var(--bg2),var(--bg3));padding:18px}
    .wrap{max-width:1000px;margin:0 auto;background:rgba(0,0,0,.9);border:2px solid var(--red);
      border-radius:16px;padding:22px;box-shadow:0 0 40px rgba(255,71,87,.25);position:relative}
    .stamp{position:absolute;top:20px;right:20px;background:var(--red);color:#000;
      padding:7px 14px;border:3px solid #000;transform:rotate(10deg);font-weight:bold}
    h1{margin:0 0 6px;color:var(--red);text-shadow:0 0 18px rgba(255,71,87,.7);letter-spacing:3px;text-align:center}
    .sub{color:var(--vio);text-align:center;margin-bottom:20px}
    .section{background:rgba(255,255,255,.03);border-left:4px solid var(--vio);border-radius:10px;padding:18px;margin:14px 0}
    .title{color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:760px){.g2,.g3{grid-template-columns:1fr}}
    label{display:block;margin-bottom:6px;color:var(--vio);font-weight:bold;font-size:.88em;letter-spacing:.5px}
    input,select,textarea{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid var(--vio);border-radius:8px;color:var(--fg)}
    textarea{min-height:80px}
    .btn{background:linear-gradient(45deg,var(--red),#ff6b7a);color:#000;border:none;padding:12px 16px;border-radius:8px;
      font-weight:bold;cursor:pointer;transition:.15s;text-transform:uppercase;letter-spacing:1px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(255,71,87,.45)}
    .btn.sec{background:linear-gradient(45deg,var(--vio),var(--vio2));color:#fff}
    .btn.alt{background:linear-gradient(45deg,var(--blue),#78a9ff);color:#000}
    .btn.out{background:transparent;border:2px dashed var(--vio);color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{font-size:.85em;color:var(--muted)}
    .muted{opacity:.75}
    .card{border:1px dashed var(--vio);border-radius:10px;padding:10px}
    .dossier{border:2px solid var(--red);border-radius:12px;background:linear-gradient(135deg,rgba(255,71,87,.1),rgba(95,39,205,.1));padding:16px;margin:12px 0;position:relative}
    .dossier:before{content:"CLASSIFIED";position:absolute;top:-10px;left:18px;background:var(--red);color:#000;padding:3px 10px;font-size:.72em;font-weight:bold}
    .code{color:var(--red);font-weight:bold}
    .log{max-height:260px;overflow:auto;background:rgba(0,0,0,.45);border:2px solid var(--vio);border-radius:10px;padding:12px}
    .line{border-left:3px solid var(--vio);padding-left:10px;margin:8px 0;background:rgba(95,39,205,.12);border-radius:4px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--vio),transparent);margin:12px 0}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78em;font-weight:bold}
    .b-ready{background:var(--green);color:#fff}.b-used{background:#e74c3c;color:#fff}
    .b-lock{background:#f39c12;color:#000}
    .hidden{display:none}
    .murder{border-left-color:#e74c3c}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stamp">TOP SECRET</div>
    <h1>DISHONOURABLE DISCHARGE</h1>
    <div class="sub">Operation: Alpine Debrief</div>

    <!-- AGENT DASHBOARD -->
    <div id="dashPanel" class="section">
      <div class="title">üßæ Agent Dashboard</div>

      <div class="dossier">
        <div class="row" style="justify-content:space-between">
          <div><span class="code" id="codenameText">‚Äî</span>
            <span class="small muted">(Agent ID <span id="agentIdText">‚Äî</span>)</span></div>
          <div class="small">Game: <span id="gameKeyText">‚Äî</span> ¬∑ Final Night: <span id="finalNightText">‚Äî</span></div>
        </div>
        <div class="hr"></div>

        <div class="grid g3">
          <div class="card">
            <div class="small muted">Your Name</div>
            <div id="realNameText">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Adopted Character Name</div>
            <div id="aliasText">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Cover Identity</div>
            <div id="coverText">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Operational Role</div>
            <div id="roleText">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Role Objective</div>
            <div id="roleObjective">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Win Condition</div>
            <div id="roleWin">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Secret Mission (you only)</div>
            <div id="secretMissionText">‚Äî</div>
          </div>
        </div>

        <div class="grid g2" style="margin-top:10px">
          <div class="card">
            <div class="small muted">Background</div>
            <div id="backgroundText">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Discharge</div>
            <div id="dischargeText">‚Äî</div>
          </div>
        </div>

        <div class="grid g3" style="margin-top:10px">
          <div class="card">
            <div class="small muted">Perks</div>
            <ul id="perkList" style="margin:6px 0 0 18px"></ul>
          </div>
          <div class="card">
            <div class="small muted">Behavioral Quirk</div>
            <div id="quirkText">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">Con</div>
            <div id="conText">‚Äî</div>
          </div>
        </div>

        <div id="murdererPanel" class="section murder hidden">
          <div class="title">‚ò†Ô∏è SECRET DIRECTIVE ‚Äî MURDERER</div>
          <div id="murdererDirective" class="small"></div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="small muted">Special Ability</div>
              <div id="abilityName"><strong>‚Äî</strong></div>
              <div class="small" id="abilityDesc">‚Äî</div>
            </div>
            <div>
              <span id="abilityBadge" class="badge b-ready">READY</span>
              <div class="small">Uses Left Today: <span id="abilityUsesLeft">1</span></div>
            </div>
          </div>
          <div class="grid g3" style="margin-top:10px">
            <div>
              <label class="small">Target (optional)</label>
              <select id="abilityTargetSelect"></select>
            </div>
            <div>
              <label class="small">‚Ä¶or type Agent ID</label>
              <input id="abilityTargetId" placeholder="agent_xxx"/>
            </div>
            <div style="align-self:end">
              <button class="btn alt" id="btnUseAbility">Use Ability</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Missions -->
      <div class="section" style="border-left-color:var(--ora)">
        <div class="title">üìã Missions</div>
        <div id="activeMission" class="card">
          <div class="small muted">Active Mission</div>
          <div id="missionText">None. Request one below.</div>
          <div class="row" style="margin-top:8px">
            <button class="btn sec" id="btnReqMission">Request Mission</button>
            <button class="btn" id="btnCompleteMission">Complete Mission</button>
            <button class="btn out" id="btnFailMission">Fail & Redraw</button>
          </div>
          <div class="small" style="margin-top:6px">Completed: <span id="missionCount">0</span></div>
        </div>
      </div>

      <!-- Actions -->
      <div class="section" style="border-left-color:var(--blue)">
        <div class="title">üìù Submit Action / Penalty / Task</div>
        <div class="grid g3">
          <div>
            <label>Action Type</label>
            <select id="actionType">
              <option value="penalty">Report Penalty</option>
              <option value="task_complete">Task Complete</option>
              <option value="murderer_act">Report Murderer Act</option>
              <option value="ability">Use Ability (also above)</option>
            </select>
          </div>
          <div>
            <label>Target Player</label>
            <select id="actionTarget"></select>
          </div>
          <div>
            <label>Details</label>
            <input id="actionDetails" placeholder="What happened / instructions"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn alt" id="btnSubmitAction">Submit</button>
        </div>
      </div>

      <!-- Public Roster -->
      <div class="section">
        <div class="title">üóÇÔ∏è Public Roster (bios + perks/quirks/cons)</div>
        <div id="rosterList"></div>
      </div>

      <!-- Log -->
      <div class="section" style="border-left-color:var(--vio2)">
        <div class="title">üì° Operation Log</div>
        <div id="logView" class="log"></div>
      </div>

      <div class="row">
        <button class="btn sec" id="btnRefresh">Refresh</button>
        <button class="btn out" id="btnLeave">Leave Seat (Back to Login)</button>
      </div>
    </div>
  </div>

<script>
/* ===== utils ===== */
const $ = id => document.getElementById(id);
const pick = a => a[Math.floor(Math.random()*a.length)];
const dayKey = () => { const d = new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; };
function text(id, val){ const el=$(id); if(el) el.textContent = val ?? '‚Äî'; }
function html(id, val){ const el=$(id); if(el) el.innerHTML = val ?? ''; }

/* ===== roles ===== */
const ROLES = {
  flipped_agent:{ name:"The Flipped Agent", obj:"Stay hidden while sowing chaos. Frame others or recruit allies.", win:"Survive final vote OR flip another player." },
  handler:{ name:"The Handler", obj:"Identify the traitor through investigation and deduction.", win:"Correctly identify the Flipped Agent in the final vote." },
  wildcard:{ name:"The Wildcard", obj:"Survive and adapt; can align with either side.", win:"Align with the winning side OR complete your solo objectives." },
  innocent:{ name:"Innocent Operative", obj:"Identify the traitor and survive the final vote.", win:"Vote out the Flipped Agent OR survive to the end." }
};

/* ===== missions ===== */
const MISSIONS = [
  "Wear ski goggles to dinner; never explain why.",
  "Ask 3 strangers where the CIA safehouse is.",
  "Challenge someone to a snowball duel; loser does a shoey.",
  "Bring a random item to the bar and convince someone it‚Äôs priceless.",
  "Gain legit access to another player‚Äôs room for 15 minutes.",
  "Speak only in a fake Russian accent for 3 hours.",
  "Critique outfits using military terminology.",
  "Take a candid photo of every player undetected.",
  "Get someone to break a minor rule for you.",
  "Teach a stranger a codeword and use it later."
];

/* ===== state ===== */
let sessionId = null;
let playerId  = null;
let gameState = null;
let me        = null;
let pollHandle = null;

/* ===== api ===== */
async function api(op, body={}) {
  if(op==='get'){
    const r = await fetch(`/api/game?id=${encodeURIComponent(body.id)}`);
    return r.json();
  }
  const r = await fetch('/api/game', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ op, ...body })
  });
  return r.json();
}
async function postEvent(msg){
  try{ await api('event', { sessionId, msg }); }catch(e){}
}
async function patchMe(patch){
  try{
    const res = await api('update_player', { sessionId, playerId, patch });
    if(res?.ok && res.player){ me = res.player; }
  }catch(e){}
}

/* ===== ui render ===== */
function renderAll(){
  if(!gameState || !me) return;
  text('gameKeyText', gameState.id);
  text('finalNightText', gameState.finalNightAt ? new Date(gameState.finalNightAt).toLocaleString() : '‚Äî');

  text('codenameText', me.codename || 'OPERATIVE');
  text('agentIdText', me.id);
  text('realNameText', me.realName);
  text('aliasText', me.adoptedName || me.alias || '');
  text('coverText', me.cover || '');

  text('backgroundText', me.background || '');
  text('dischargeText', me.discharge || '');
  text('secretMissionText', me.secretMission || '');
  text('quirkText', me.quirk || '');
  text('conText', me.con || '');

  const role = ROLES[me.role] || {name:me.role||'‚Äî', obj:'‚Äî', win:'‚Äî'};
  text('roleText', role.name);
  text('roleObjective', role.obj);
  text('roleWin', role.win);

  $('perkList').innerHTML = (me.perks||[]).map(p=>`<li>${p}</li>`).join('') || '<li>‚Äî</li>';

  // ability status
  const st = me.abilityState || { usesLeft: (me.ability?.usesPerDay ?? 1), lastResetDay: dayKey() };
  if(st.lastResetDay !== dayKey()){ st.lastResetDay = dayKey(); st.usesLeft = me.ability?.usesPerDay ?? 1; }
  me.abilityState = st;
  text('abilityUsesLeft', st.usesLeft ?? 0);
  const b = $('abilityBadge'); b.className = 'badge ' + ((st.usesLeft??0) > 0 ? 'b-ready':'b-used');
  b.textContent = (st.usesLeft??0) > 0 ? 'READY' : 'USED';
  html('abilityName', `<strong>${me.ability?.name || '‚Äî'}</strong>`);
  text('abilityDesc', me.ability?.desc || '‚Äî');

  // murderer panel (private)
  const mp = $('murdererPanel');
  if(gameState.murderer && gameState.murderer.id === me.id){
    mp.classList.remove('hidden');
    text('murdererDirective', `Perform without being caught: ${gameState.murderer.act}`);
  }else{
    mp.classList.add('hidden');
  }

  renderRoster();
  renderLog();
  populateTargets();

  // mission
  const ms = me.missions || {active:null, count:0};
  me.missions = ms;
  text('missionText', ms.active || 'None. Request one below.');
  text('missionCount', ms.count || 0);
}

function renderRoster(){
  const list = gameState.players || [];
  $('rosterList').innerHTML = list.length ? list.map(p=>{
    const perks = (p.perks||[]).map(x=>`<li>${x}</li>`).join('') || '<li>‚Äî</li>';
    const meTag = (me && p.id===me.id) ? ' (you)' : '';
    return `
      <div class="card" style="margin:8px 0">
        <div class="row" style="justify-content:space-between">
          <div><strong class="code">${p.codename}</strong> ‚Äî ${p.realName}${meTag}</div>
          <div class="small muted">${p.id}</div>
        </div>
        <div class="small">${p.cover||''}</div>
        <div class="grid g3" style="margin-top:8px">
          <div><div class="small muted">Public Bio</div>${p.publicBio||'‚Äî'}</div>
          <div><div class="small muted">Quirk</div>${p.quirk||'‚Äî'}</div>
          <div><div class="small muted">Con</div>${p.con||'‚Äî'}</div>
        </div>
        <div style="margin-top:6px"><div class="small muted">Perks</div><ul style="margin:6px 0 0 18px">${perks}</ul></div>
      </div>
    `;
  }).join('') : '<div class="muted">No agents yet.</div>';
}

function renderLog(){
  const log = gameState.gameLog || [];
  $('logView').innerHTML = log.slice(-300).map(l=>`<div class="line"><strong>[${new Date(l.ts).toLocaleTimeString()}]</strong> ${l.msg}</div>`).join('') || '<div class="muted">No events yet.</div>';
  $('logView').scrollTop = $('logView').scrollHeight;
}

function populateTargets(){
  const others = (gameState.players||[]).filter(p => !me || p.id !== me.id);
  const fill = id => {
    const sel = $(id);
    if(!sel) return;
    sel.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
    others.forEach(p=>{
      const o = document.createElement('option');
      o.value = p.id;
      o.textContent = `${p.codename} (${p.realName})`;
      sel.appendChild(o);
    });
  };
  fill('abilityTargetSelect');
  fill('actionTarget');
}

/* ===== actions ===== */
function abilityUsesLeft(){
  const st = me.abilityState || { usesLeft:(me.ability?.usesPerDay ?? 1), lastResetDay: dayKey() };
  if(st.lastResetDay !== dayKey()){
    st.lastResetDay = dayKey();
    st.usesLeft = me.ability?.usesPerDay ?? 1;
    me.abilityState = st;
    patchMe({ abilityState: st });
  }
  return st.usesLeft ?? 0;
}

async function useAbility(){
  if(!me?.ability) return;
  const left = abilityUsesLeft();
  if(left <= 0){ await postEvent(`‚ö†Ô∏è ${me.codename} tried to use ability but has no uses left.`); return; }

  const selId = $('abilityTargetSelect').value || '';
  const typed = ($('abilityTargetId').value||'').trim();
  const target = (gameState.players||[]).find(p=> p.id === (selId || typed));
  const tLabel = target ? `${target.codename} (${target.realName})` : '‚Äî';

  const st = me.abilityState || { usesLeft:1, lastResetDay:dayKey() };
  st.usesLeft = Math.max(0, (st.usesLeft ?? 1)-1);
  me.abilityState = st;
  await patchMe({ abilityState: st });
  renderAll();

  await postEvent(`‚ö° ${me.codename} used "${me.ability.name}" on ${tLabel}.`);
  $('abilityTargetId').value='';
}

function ensureMissionState(){
  me.missions = me.missions || { active:null, count:0 };
  return me.missions;
}
async function requestMission(){
  const ms = ensureMissionState();
  if(ms.active){ await postEvent(`${me.codename} requested new mission without completing previous ‚Üí group consensus penalty?`); }
  ms.active = pick(MISSIONS);
  await patchMe({ missions: ms });
  await postEvent(`üìã ${me.codename} drew a mission: "${ms.active}"`);
  renderAll();
}
async function completeMission(){
  const ms = ensureMissionState();
  if(!ms.active) return;
  await postEvent(`‚úÖ ${me.codename} completed mission: "${ms.active}"`);
  ms.active = null; ms.count = (ms.count||0)+1;
  await patchMe({ missions: ms });
  renderAll();
}
async function failMission(){
  const ms = ensureMissionState();
  if(!ms.active){ await requestMission(); return; }
  await postEvent(`‚ùå ${me.codename} failed mission: "${ms.active}" ‚Äî new mission requested.`);
  ms.active = pick(MISSIONS);
  await patchMe({ missions: ms });
  renderAll();
}

function labelFor(id){
  const p=(gameState.players||[]).find(x=>x.id===id);
  return p? `${p.codename} (${p.realName})` : (id||'‚Äî');
}
async function submitAction(){
  const type = $('actionType').value;
  const target = $('actionTarget').value;
  const details = ($('actionDetails').value||'(no details)').trim();
  let textMsg = '';
  if(type==='penalty') textMsg = `üìù Penalty on ${labelFor(target)} ‚Äî ${details}`;
  else if(type==='task_complete') textMsg = `üìù Task complete by ${me.codename} ‚Äî ${details}`;
  else if(type==='murderer_act') textMsg = `üìù Murderer act report by ${me.codename} ‚Äî ${details}`;
  else textMsg = `üìù Ability use by ${me.codename} on ${labelFor(target)} ‚Äî ${details}`;
  await postEvent(textMsg);
  $('actionDetails').value='';
  $('actionTarget').value='';
}

/* ===== refresh / boot ===== */
async function refresh(){
  if(!sessionId) return;
  const res = await api('get', { id: sessionId });
  if(!res?.ok){ return; }
  gameState = res.session;
  me = (gameState.players||[]).find(p=>p.id===playerId) || me;
  renderAll();
}

function leaveSeat(){
  localStorage.removeItem('session');
  localStorage.removeItem('seatToken');
  localStorage.removeItem('playerId');
  location.href = './index.html';
}

/* ===== wire up ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  sessionId = localStorage.getItem('session');
  playerId  = localStorage.getItem('playerId');
  if(!sessionId || !playerId){
    // no seat stored ‚Üí go back to login
    location.href = './index.html';
    return;
  }

  // wire buttons
  $('btnUseAbility').onclick = useAbility;
  $('btnReqMission').onclick = requestMission;
  $('btnCompleteMission').onclick = completeMission;
  $('btnFailMission').onclick = failMission;
  $('btnSubmitAction').onclick = submitAction;
  $('btnRefresh').onclick = refresh;
  $('btnLeave').onclick = leaveSeat;

  await refresh();
  if(pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(refresh, 4000);
});
</script>
</body>
</html>
