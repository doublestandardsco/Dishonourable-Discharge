<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agent Dashboard Â· Dishonourable Discharge</title>
  <style>
    :root{
      --bg:#0a0a0a; --bg2:#1a1a2e; --bg3:#16213e;
      --red:#ff4757; --vio:#5f27cd; --vio2:#7c3aed; --ora:#ffa500; --blue:#3498db; --green:#27ae60;
      --fg:#e0e0e0; --muted:#9bbcff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Courier New',monospace;color:var(--fg);min-height:100vh;
      background:linear-gradient(135deg,var(--bg),var(--bg2),var(--bg3));padding:18px}
    .wrap{max-width:1000px;margin:0 auto;background:rgba(0,0,0,.92);border:2px solid var(--red);
      border-radius:16px;padding:22px;box-shadow:0 0 40px rgba(255,71,87,.25);position:relative}
    .stamp{position:absolute;top:20px;right:20px;background:var(--red);color:#000;
      padding:7px 14px;border:3px solid #000;transform:rotate(10deg);font-weight:bold}
    h1{margin:0 0 6px;color:var(--red);text-shadow:0 0 18px rgba(255,71,87,.7);letter-spacing:3px}
    .small{color:var(--muted);font-size:.88em}
    .section{background:rgba(255,255,255,.03);border-left:4px solid var(--vio);border-radius:10px;padding:18px;margin:14px 0}
    .title{color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:760px){.g2,.g3{grid-template-columns:1fr}}
    .card{border:1px dashed var(--vio);border-radius:10px;padding:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .code{color:var(--red);font-weight:bold}
    .btn{background:linear-gradient(45deg,var(--blue),#78a9ff);color:#000;border:none;padding:10px 14px;border-radius:8px;
      font-weight:bold;cursor:pointer}
    .btn.alt{background:linear-gradient(45deg,var(--vio),var(--vio2));color:#fff}
    .btn.warn{background:linear-gradient(45deg,var(--red),#ff6b7a);color:#000}
    select,input{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid var(--vio);border-radius:8px;color:var(--fg)}
    .log{max-height:260px;overflow:auto;background:rgba(0,0,0,.45);border:2px solid var(--vio);border-radius:10px;padding:12px}
    .line{border-left:3px solid var(--vio);padding-left:10px;margin:8px 0;background:rgba(95,39,205,.12);border-radius:4px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78em;font-weight:bold}
    .b-ready{background:#27ae60;color:#fff}.b-used{background:#e74c3c;color:#fff}
  </style>
</head>
<body>
<div class="wrap">
  <div class="stamp">CLASSIFIED</div>
  <h1>AGENT DASHBOARD</h1>
  <div class="small">Game: <span id="gameId">â€”</span> Â· Final Night: <span id="finalNight">â€”</span> Â· You: <span id="agentId">â€”</span></div>

  <div class="section">
    <div class="title">Dossier</div>
    <div class="grid g3">
      <div class="card">
        <div class="small">Your Name</div><div id="realName">â€”</div>
        <div class="small" style="margin-top:6px">Adopted Character Name</div><div id="adopted">â€”</div>
        <div class="small" style="margin-top:6px">Cover Identity</div><div id="cover">â€”</div>
      </div>
      <div class="card">
        <div class="small">Operative Codename</div><div class="code" id="codename">â€”</div>
        <div class="small" style="margin-top:6px">Operational Role</div><div id="role">â€”</div>
        <div class="small" style="margin-top:6px">Role Objective</div><div id="roleObj">â€”</div>
        <div class="small" style="margin-top:6px">Win Condition</div><div id="roleWin">â€”</div>
      </div>
      <div class="card">
        <div class="small">Secret Mission (you only)</div><div id="secret">â€”</div>
      </div>
    </div>

    <div class="grid g2" style="margin-top:10px">
      <div class="card"><div class="small">Background</div><div id="background">â€”</div></div>
      <div class="card"><div class="small">Discharge</div><div id="discharge">â€”</div></div>
    </div>

    <div class="grid g3" style="margin-top:10px">
      <div class="card"><div class="small">Perks</div><ul id="perks" style="margin:6px 0 0 18px"></ul></div>
      <div class="card"><div class="small">Behavioral Quirk</div><div id="quirk">â€”</div></div>
      <div class="card"><div class="small">Con</div><div id="con">â€”</div></div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small">Special Ability</div>
          <div id="abilityName"><strong>â€”</strong></div>
          <div class="small" id="abilityDesc">â€”</div>
        </div>
        <div>
          <span id="abilityBadge" class="badge b-ready">READY</span>
          <div class="small">Uses Left Today: <span id="usesLeft">1</span></div>
        </div>
      </div>
      <div class="grid g3" style="margin-top:10px">
        <div>
          <div class="small">Target (optional)</div>
          <select id="abilityTarget"></select>
        </div>
        <div>
          <div class="small">â€¦or type Agent ID</div>
          <input id="abilityTargetId" placeholder="agent_xxx"/>
        </div>
        <div style="align-self:end">
          <button class="btn alt" id="useAbilityBtn">Use Ability</button>
        </div>
      </div>
    </div>
  </div>

  <div class="section" style="border-left-color:var(--ora)">
    <div class="title">Missions</div>
    <div class="card">
      <div class="small">Active Mission</div>
      <div id="missionText">None. Request one below.</div>
      <div class="row" style="margin-top:8px">
        <button class="btn alt" id="reqMission">Request Mission</button>
        <button class="btn" id="completeMission">Complete Mission</button>
        <button class="btn warn" id="failMission">Fail & Redraw</button>
      </div>
      <div class="small" style="margin-top:6px">Completed: <span id="missionCount">0</span></div>
    </div>
  </div>

  <div class="section" style="border-left-color:var(--blue)">
    <div class="title">Submit Action / Penalty / Task</div>
    <div class="grid g3">
      <div>
        <div class="small">Action Type</div>
        <select id="actionType">
          <option value="penalty">Report Penalty</option>
          <option value="task_complete">Task Complete</option>
          <option value="murderer_act">Report Murderer Act</option>
          <option value="ability">Use Ability (also above)</option>
        </select>
      </div>
      <div>
        <div class="small">Target Player</div>
        <select id="actionTarget"></select>
      </div>
      <div>
        <div class="small">Details</div>
        <input id="actionDetails" placeholder="What happened / instructions"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="submitAction">Submit</button>
    </div>
  </div>

  <div class="section" style="border-left-color:var(--vio2)">
    <div class="title">Operation Log</div>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ========= helpers ========= */
const $ = (id)=>document.getElementById(id);
const qs = new URLSearchParams(location.search);
const sessionId = (qs.get('session') || localStorage.getItem('session') || '').toUpperCase();
if(sessionId) localStorage.setItem('session', sessionId);
let gameState = null, me = null;
const playerId = localStorage.getItem('playerId') || '';
const seatToken = (localStorage.getItem('seatToken') || qs.get('seat') || '').toUpperCase();

/* ========= api ========= */
async function api(op, body={}) {
  if(op==='get'){
    const r = await fetch(`/api/game?id=${encodeURIComponent(body.id)}`);
    return r.json();
  }
  const r = await fetch('/api/game', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ op, ...body })
  });
  return r.json();
}
async function patchMe(patch){
  if(!sessionId || !me?.id) return;
  const res = await api('update_player', { sessionId, playerId: me.id, patch });
  if(res?.ok && res.player) me = res.player;
}
async function postEvent(msg){
  try{ await api('event', { sessionId, msg }); }catch(e){}
}

/* ========= roles ========= */
const ROLES = {
  flipped_agent:{ name:"The Flipped Agent", obj:"Stay hidden while sowing chaos. Frame others or recruit allies.", win:"Survive final vote OR flip another player." },
  handler:{ name:"The Handler", obj:"Identify the traitor through investigation and deduction.", win:"Correctly identify the Flipped Agent in the final vote." },
  wildcard:{ name:"The Wildcard", obj:"Survive and adapt; can align with either side.", win:"Align with the winning side OR complete your solo objectives." },
  innocent:{ name:"Innocent Operative", obj:"Identify the traitor and survive the final vote.", win:"Vote out the Flipped Agent OR survive to the end." }
};

/* ========= missions / acts ========= */
const MISSIONS = [
  "Wear ski goggles to dinner; never explain why.",
  "Ask 3 strangers where the CIA safehouse is.",
  "Challenge someone to a snowball duel; loser does a shoey.",
  "Bring a random item to the bar and convince someone itâ€™s priceless.",
  "Gain legit access to another playerâ€™s room for 15 minutes.",
  "Speak only in a fake Russian accent for 3 hours.",
  "Critique outfits using military terminology.",
  "Take a candid photo of every player undetected.",
  "Get someone to break a minor rule for you.",
  "Teach a stranger a codeword and use it later."
];

/* ========= characters (12) + picker ========= */
const CHARACTERS = [
  { alias:"ValÃ©rie â€œValâ€ Marchand", codename:"LACEHUNTER", cover:"Luxury Skiwear Designer",
    publicBio:"French AF comms â†’ NATO PSYOPS â€˜tactical glamâ€™. Gives unsolicited runway checks.",
    privateBio:"Trans man. Busted tailoring a generalâ€™s thermals. Canâ€™t pass a mirror without preening.",
    background:"Former French Air Force comms; reassigned to NATO PSYOPS for â€˜morale optimizationâ€™.",
    discharge:"Non-disciplinary separation after a glitter-related morale incident.",
    secretMission:"Track down the mystery ghoster from a classified Alpine affair and collect 3 clues.",
    perks:["Honorific Lock: others must call you â€œMonsieur Valâ€.","Style Verdict: on 'Runway check', target holds an awkward 10-sec pose."],
    quirk:"Silk cravat; lip balm mid-sentence; says â€œLieutenant Thirsttrapâ€.",
    con:"If he catches his reflection he must stop & preen for 3s.",
    ability:{ name:"Fashion Emergency", desc:"Force any two players to swap one visible clothing item immediately.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Kaimana â€œKaiâ€ Savai'i", codename:"SNOWBLIND", cover:"Extreme Sports Photographer",
    publicBio:"RFMF (Fiji) recon tracker; can find happy hour with GPS accuracy.",
    privateBio:"Refused to hunt an innocent defector (his brother). Collects slang like shell casings.",
    background:"Reconnaissance & tracking specialist; humanitarian ops liaison.",
    discharge:"Honourable discharge after family conflict.",
    secretMission:"Collect 3 strangersâ€™ hometown slang and compile a 'tracking lexicon'.",
    perks:["Breadcrumb Command: choose a trigger word; speakers owe a clue or take penalty for 10 min.","Switchback: say 'First tracks' â†’ everyone rotates seats; last seated owes you a favour."],
    quirk:"Whispers intel and ends with 'copy?'.",
    con:"If someone says 'family'/'ohana', must deliver a 1-sentence heartfelt lesson.",
    ability:{ name:"Hire a Tail", desc:"Recruit one player to shadow you 10â€“30 min; deliver intel every 5 min or take penalties.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Bartosz â€œBasâ€ Nowak", codename:"FROSTBITE", cover:"Adventure Safety Coordinator",
    publicBio:"Polish GROM cold-weather specialist. Loves lists & laminated check cards.",
    privateBio:"Interrogation â€˜cultural differencesâ€™. Considers silence a confession.",
    background:"SERE instructor, polar training cadre.",
    discharge:"Honourable; opted out after â€˜communicationâ€™ feedback.",
    secretMission:"Convince a stranger to wear your gloves and pose like a crime-scene silhouette.",
    perks:["Interrogatorâ€™s Pause: on 'Answer the question', target must reply in â‰¤5 words.","Cold Protocol: greetings become fist-bump only until cleared."],
    quirk:"Over-enunciates like radio checks; NATO phonetic for numbers.",
    con:"When asked 'whatâ€™s the plan?' must show a checklist or salute 'I am improvising.'",
    ability:{ name:"Coerce an Asset", desc:"Designate a player your Asset for 15 min; complete 2 simple tasks or take penalties.", usesPerDay:1 },
    role:"handler"
  },
  { alias:"Ira â€œIrisâ€ Khatri", codename:"BLACKRUN", cover:"Avalanche Risk Specialist",
    publicBio:"Para (SF) mountain warfare; predicts disasters in people as easily as in snow.",
    privateBio:"Trans man. The avalanche that saved lives also hid sins; wonâ€™t say whose.",
    background:"High-altitude demo team; SAR & explosives.",
    discharge:"Medical after surviving a unit-ending avalanche.",
    secretMission:"Run a spontaneous 'safety briefing' with strangers and redistribute props they must wear.",
    perks:["Beacon Check: phones face-down 5 min; touching = penalty.","Disaster Brief: two table taps resets topic & assigns next speaker."],
    quirk:"Adds 'allegedly' to claims if alcohol is present.",
    con:"On triangles/angles must estimate degrees aloud; off by >10Â° â†’ draw a napkin protractor.",
    ability:{ name:"Avalanche Protocol", desc:"Clap twice: 30-sec evac drill. Everyone swaps seats & surrenders a small item; you redistribute.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Pilar â€œPiliâ€ CastaÃ±o", codename:"POWDER KEG", cover:"Luxury Lodge Event Coordinator",
    publicBio:"Spanish social engineer; diplomacy with a splash of chaos.",
    privateBio:"Trans man. Ran weapons through receptions. Still RSVPâ€™s 'maybe' to Interpol.",
    background:"Human terrain ops; embassy events fixer.",
    discharge:"Dishonourable (creative import/export).",
    secretMission:"Get a stranger to announce you as 'His Excellency the Ambassador of AprÃ¨s'.",
    perks:["VIP Gate: others must introduce you with a flamboyant invented title.","Guest List: 'Youâ€™re on the list' â†’ 2-min private chat to assign a micro-task."],
    quirk:"Refuses real names; assigns callsigns.",
    con:"On any rumour he must add 'exclusive source' + wink; if asked later 'source?' must admit 'It was me.'",
    ability:{ name:"Task the Mark", desc:"Nominate any player to get a phone #, key/card, or selfie with anyone within 20 min. Failure = penalty.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Dmitri â€œDimaâ€ Volkov", codename:"ICEPICK", cover:"Artisanal Spirits Consultant",
    publicBio:"Ex-Spetsnaz (allegedly). Measures every drink. Speaks in Celsius.",
    privateBio:"Defectedâ€”or didnâ€™t. Awaits a signal only heâ€™d recognize.",
    background:"Urban recon & counter-human intel.",
    discharge:"â€˜Special transferâ€™ during the Sochi Olympics.",
    secretMission:"Learn a new vodka toast and perform it with the group.",
    perks:["Cold Stare: on eye contact the other must break first or penalty.","Vodka Toast Override: on 'Na zdorovye', all must toast; 30s to find alcohol or penalty."],
    quirk:"Answers 'roger' instead of 'yes' and ends sentences with 'over.'",
    con:"When a new person arrives, he must pat pockets: 'ID, keys, exitâ€”roger'; if caught skipping â†’ 10-sec bug sweep.",
    ability:{ name:"Charm Offensive (vodka-only)", desc:"Before midnight compel 3 people to buy you vodka drinks. Refusal/wrong drink = penalty.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Rowan â€œRoâ€ Hart", codename:"WOLFTRAP", cover:"Night Security Analyst",
    publicBio:"Ex-infantry turned nightclub perimeter whisperer. Hears bouncers before the bass.",
    privateBio:"Trans man. Thinks velvet ropes are guidelines. Once dated a smoke machine.",
    background:"Perimeter defense & crowd control.",
    discharge:"Honourable.",
    secretMission:"Convince a venue staffer to radio-check you using a callsign you invent.",
    perks:["Line Cutter: may insert yourself into any group; someone must introduce you within 20s.","Bouncerâ€™s Choice: point to the door; one person must accompany you for a 60s perimeter check."],
    quirk:"Counts exits (quietly) when entering a room.",
    con:"If music changes, must freeze for 3s like a motion sensor.",
    ability:{ name:"Angle Check (10-sec hold)", desc:"Command a target to strike a dramatic pose facing a 'camera' for 10 seconds. Everyone must try not to laugh.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Asher â€œAshâ€ Del Mar", codename:"SEALEVEL", cover:"Hydro Logistics Planner",
    publicBio:"Special forces boat guy who gets altitude sickness looking at menus.",
    privateBio:"Smuggled a jet-ski into a hotel fountain. Twice.",
    background:"Riverine logistics & insertions.",
    discharge:"Honourable (but wet).",
    secretMission:"Collect three coasters from different venues and arrange a 'map' on the table.",
    perks:["High-Water Mark: pick a 'shoreline' on the table; items crossing it owe you a sip.","Docking Fee: anyone returning to the group pays you a one-word status update."],
    quirk:"Adds boat metaphors to everything.",
    con:"If someone says 'wave', must salute like a lifeguard.",
    ability:{ name:"Harbour Master", desc:"Declare the current table 'Port'. Anyone joining owes you a status report + cheers.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Noah â€œKnoxâ€ Keegan", codename:"SWITCHBACK", cover:"Mountain Bike Guide",
    publicBio:"Downhill brain, uphill charm. Always plotting the next corner.",
    privateBio:"Claims a scar for each Greek letter he remembers. Many letters; suspicious count.",
    background:"Bike-mounted patrol & courier.",
    discharge:"Honourable.",
    secretMission:"Borrow a helmet from someone not in your group and wear it for 2 minutes.",
    perks:["Gear Check: on 'Drop a gear', everyone lowers voice one notch for 2 min.","Trail Marshal: you decide who speaks next for 60s."],
    quirk:"Claps once when he stands up.",
    con:"If someone says 'brake', must freeze mid-gesture for 2s.",
    ability:{ name:"Trail Tax (chaos)", desc:"Pick two people to swap seats & share a 'route apology'.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Jamie â€œHarrowâ€ Quinn", codename:"BONESAW", cover:"Field Medic (Former)",
    publicBio:"Good with stitches; terrible with boundaries. Brings tape to conversations.",
    privateBio:"Kept a toe tag as a bookmark. It fell out at a funeral.",
    background:"Combat medic; mass-casualty triage.",
    discharge:"Honourable; 'bedside manner incompatible with brass'.",
    secretMission:"Bandage (real or improvised) a non-player and get them to rate your care /10.",
    perks:["Triage: you may interrupt any chat to ask 'Vitals?'â€”answer must be a number.","Sterile Field: designate a 30 cm zone around your drink; violators owe an apology shot."],
    quirk:"Calls snacks 'oral medication'.",
    con:"If someone says 'owie', must produce a bandage (real or improvised).",
    ability:{ name:"Scrub In", desc:"Declare an emergency consult; target must whisper their last snack & biggest fear.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Elliot â€œLedgerâ€ Vance", codename:"COUNTERSIGN", cover:"Casino Surveillance",
    publicBio:"Counts cards, people, and regrets. Mostly people.",
    privateBio:"Wears mirrored sunglasses at night because 'math is bright'.",
    background:"Surveillance, pattern analysis.",
    discharge:"Honourable; immediately banned from three casinos.",
    secretMission:"Convince someone to speak only in numbers with you for 30 seconds.",
    perks:["Tell Read: you may ask someone to repeat a sentence slower.","Double Down: once, force a yes/no commitment from the table."],
    quirk:"Murmurs odds to himself.",
    con:"If anyone says a number >10, must whisper a different random number.",
    ability:{ name:"Background Count", desc:"Ask the GM for a one-line statistical hint about any player.", usesPerDay:1 },
    role:"handler"
  },
  { alias:"Rafe â€œStaticâ€ Moretti", codename:"JAMMER", cover:"RF Tech",
    publicBio:"Carries more antennas than personality. Stillâ€¦ weirdly charming.",
    privateBio:"Blocked a wedding livestream so the brideâ€™s ex couldnâ€™t watch. She thanked him.",
    background:"Signals intelligence & EW.",
    discharge:"Honourable; requested more batteries than the army owned.",
    secretMission:"Get a stranger to say 'Say again?' twice in one conversation.",
    perks:["Signal Check: say 'Bars?' â†’ everyone must show phone lock screen for 3s.","Dead Zone: pick a corner where nobody may use phones for 5 min."],
    quirk:"Says 'Copy' to compliments.",
    con:"If someone says 'loud', must turn an imaginary knob.",
    ability:{ name:"Static Burst", desc:"Declare a 30-sec 'comms outage': everyone speaks in whispers only.", usesPerDay:1 },
    role:"innocent"
  }
];
function pickCharacterForSeat(key){
  const src = key || 'DEFAULT';
  let h=0; for(const ch of src) h = (h*31 + ch.charCodeAt(0))>>>0;
  const base = CHARACTERS[h % CHARACTERS.length];
  return JSON.parse(JSON.stringify(base));
}

/* ========= ability/day state ========= */
function dayKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
function usesLeft(){
  const st = me?.abilityState || { usesLeft:(me?.ability?.usesPerDay??1), lastResetDay:dayKey() };
  if(st.lastResetDay !== dayKey()){
    st.lastResetDay = dayKey();
    st.usesLeft = me?.ability?.usesPerDay ?? 1;
    me.abilityState = st;
    patchMe({ abilityState: st });
  }
  return st.usesLeft ?? 0;
}

/* ========= backfill: ensure full character exists (agent-only fix) ========= */
async function backfillIfNeeded(){
  if(!me) return;
  const missing =
    !me.alias || !me.adoptedName || !me.cover || me.cover === 'Cover Identity' ||
    !me.background || !me.discharge || !me.secretMission ||
    !(me.perks && me.perks.length) || !me.ability || !me.codename || !me.role;

  if(!missing) return;

  // Build from seat token (best), otherwise hash agent id as fallback.
  const pack = pickCharacterForSeat(seatToken || me.id);
  const patch = {
    codename: me.codename || pack.codename,
    alias: me.alias || pack.alias,
    adoptedName: me.adoptedName || pack.alias,
    cover: me.cover && me.cover!=='Cover Identity' ? me.cover : pack.cover,
    publicBio: me.publicBio || pack.publicBio,
    privateBio: me.privateBio || pack.privateBio,
    background: me.background || pack.background,
    discharge: me.discharge || pack.discharge,
    secretMission: me.secretMission || pack.secretMission,
    perks: (me.perks && me.perks.length) ? me.perks : pack.perks,
    quirk: me.quirk || pack.quirk,
    con: me.con || pack.con,
    ability: me.ability || pack.ability,
    role: me.role || pack.role,
    abilityState: me.abilityState || { usesLeft: pack.ability?.usesPerDay ?? 1, lastResetDay: dayKey() }
  };
  // Persist patch so roster & others see it too
  await patchMe(patch);
}

/* ========= render ========= */
function fillRosterTargets(){
  const others = (gameState.players||[]).filter(p=>!me || p.id!==me.id);
  const ids = ['abilityTarget','actionTarget'];
  ids.forEach(id=>{
    const sel=$(id); if(!sel) return;
    sel.innerHTML = '<option value="">â€” Select â€”</option>';
    others.forEach(p=>{
      const o=document.createElement('option');
      o.value=p.id; o.textContent=`${p.codename||'OPERATIVE'} (${p.realName||'Agent'})`;
      sel.appendChild(o);
    });
  });
}
function renderLog(){
  const log = gameState.gameLog || [];
  $('log').innerHTML = log.slice(-300).map(l=>`<div class="line"><strong>[${new Date(l.ts).toLocaleTimeString()}]</strong> ${l.msg}</div>`).join('') || '<div class="small">No events yet.</div>';
  $('log').scrollTop = $('log').scrollHeight;
}
function renderDossier(){
  if(!me) return;
  $('gameId').textContent = gameState.id;
  $('finalNight').textContent = gameState.finalNightAt ? new Date(gameState.finalNightAt).toLocaleString() : 'â€”';
  $('agentId').textContent = me.id;

  $('realName').textContent = me.realName || 'â€”';
  $('adopted').textContent = me.adoptedName || me.alias || 'â€”';
  $('cover').textContent = me.cover || 'â€”';

  $('codename').textContent = me.codename || 'OPERATIVE';
  const role = ROLES[me.role] || {name: me.role||'â€”', obj:'â€”', win:'â€”'};
  $('role').textContent = role.name; $('roleObj').textContent = role.obj; $('roleWin').textContent = role.win;

  $('secret').textContent = me.secretMission || 'â€”';
  $('background').textContent = me.background || 'â€”';
  $('discharge').textContent = me.discharge || 'â€”';
  $('quirk').textContent = me.quirk || 'â€”';
  $('con').textContent = me.con || 'â€”';

  $('perks').innerHTML = (me.perks||[]).map(p=>`<li>${p}</li>`).join('') || '<li>â€”</li>';

  $('abilityName').innerHTML = `<strong>${me.ability?.name || 'â€”'}</strong>`;
  $('abilityDesc').textContent = me.ability?.desc || 'â€”';

  const left = usesLeft();
  $('usesLeft').textContent = left;
  const b = $('abilityBadge');
  b.className = 'badge ' + (left>0 ? 'b-ready' : 'b-used');
  b.textContent = left>0 ? 'READY' : 'USED';

  // missions
  const ms = me.missions || {active:null,count:0};
  $('missionText').textContent = ms.active || 'None. Request one below.';
  $('missionCount').textContent = ms.count || 0;
}

/* ========= actions ========= */
function labelFor(id){
  const p=(gameState.players||[]).find(x=>x.id===id);
  return p? `${p.codename||'OPERATIVE'} (${p.realName||'Agent'})` : (id||'â€”');
}
async function doUseAbility(){
  if(!me?.ability) return;
  const left = usesLeft(); if(left<=0){ await postEvent(`âš ï¸ ${me.codename} tried to use ability but has no uses left.`); return; }
  const targetId = $('abilityTarget').value || ($('abilityTargetId').value||'').trim();
  const tLabel = labelFor(targetId);
  const st = me.abilityState || { usesLeft:1, lastResetDay: dayKey() };
  st.usesLeft = Math.max(0, (st.usesLeft??1)-1);
  me.abilityState = st;
  await patchMe({ abilityState: st });
  renderDossier();
  await postEvent(`âš¡ ${me.codename} used "${me.ability.name}" on ${tLabel}.`);
  $('abilityTargetId').value='';
}
function ensureMissionState(){ me.missions = me.missions || {active:null,count:0}; return me.missions; }
async function reqMission(){
  const ms = ensureMissionState();
  if(ms.active) await postEvent(`${me.codename} requested a new mission without completing the previous one.`);
  ms.active = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
  await patchMe({ missions: ms });
  $('missionText').textContent = ms.active;
  await postEvent(`ðŸ“‹ ${me.codename} drew a mission: "${ms.active}"`);
}
async function completeMission(){
  const ms = ensureMissionState(); if(!ms.active) return;
  await postEvent(`âœ… ${me.codename} completed mission: "${ms.active}"`);
  ms.active = null; ms.count = (ms.count||0)+1;
  await patchMe({ missions: ms });
  $('missionText').textContent = 'None. Request one below.'; $('missionCount').textContent = ms.count;
}
async function failMission(){
  const ms = ensureMissionState();
  if(ms.active) await postEvent(`âŒ ${me.codename} failed mission: "${ms.active}" â€” drawing a new one.`);
  ms.active = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
  await patchMe({ missions: ms });
  $('missionText').textContent = ms.active;
}
async function submitAction(){
  const type = $('actionType').value;
  const target = $('actionTarget').value;
  const details = ($('actionDetails').value || '(no details)').trim();
  let text = '';
  if(type==='penalty') text = `ðŸ“ Penalty on ${labelFor(target)} â€” ${details}`;
  else if(type==='task_complete') text = `ðŸ“ Task complete by ${me.codename} â€” ${details}`;
  else if(type==='murderer_act') text = `ðŸ“ Murderer act report by ${me.codename} â€” ${details}`;
  else text = `ðŸ“ Ability use by ${me.codename} on ${labelFor(target)} â€” ${details}`;
  await postEvent(text);
  $('actionDetails').value=''; $('actionTarget').value='';
}

/* ========= boot / poll ========= */
async function refresh(){
  if(!sessionId){ $('log').innerHTML = '<div class="small">No session id. Open via the join flow.</div>'; return; }
  const r = await api('get', { id: sessionId });
  if(!r?.ok){ $('log').innerHTML = '<div class="small">Session not found.</div>'; return; }
  gameState = r.session;

  // resolve me
  me = (gameState.players||[]).find(p=>p.id===playerId) || me;
  if(!me && seatToken){
    // fallback: find seat -> bound player
    const seat = (gameState.seats||[]).find(s=>(s.token||'').toUpperCase()===seatToken);
    if(seat?.playerId){
      me = (gameState.players||[]).find(p=>p.id===seat.playerId) || null;
      if(me) localStorage.setItem('playerId', me.id);
    }
  }
  if(!me){ $('log').innerHTML = '<div class="small">Player not found in this session.</div>'; return; }

  await backfillIfNeeded();
  fillRosterTargets();
  renderDossier();
  renderLog();
}

document.addEventListener('DOMContentLoaded', ()=>{
  $('useAbilityBtn').onclick = doUseAbility;
  $('reqMission').onclick = reqMission;
  $('completeMission').onclick = completeMission;
  $('failMission').onclick = failMission;
  $('submitAction').onclick = submitAction;
  refresh();
  setInterval(refresh, 4000);
});
</script>
</body>
</html>
