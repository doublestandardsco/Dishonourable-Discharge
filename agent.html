<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent Console â€” Dishonourable Discharge</title>
  <style>
    :root{
      --bg:#0a0a0a; --bg2:#1a1a2e; --bg3:#16213e;
      --red:#ff4757; --vio:#5f27cd; --vio2:#7c3aed; --ora:#ffa500;
      --blue:#3498db; --green:#27ae60; --fg:#e9e9ef; --muted:#9bbcff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Courier New',monospace;color:var(--fg);
      background:linear-gradient(135deg,var(--bg),var(--bg2),var(--bg3));padding:18px}
    .wrap{max-width:1100px;margin:0 auto;background:rgba(0,0,0,.9);
      border:2px solid var(--red);border-radius:16px;padding:22px;box-shadow:0 0 40px rgba(255,71,87,.25)}
    .title{color:var(--red);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px}
    .section{background:rgba(255,255,255,.03);border-left:4px solid var(--vio);border-radius:10px;padding:18px;margin:14px 0}
    .section.orange{border-left-color:var(--ora)}
    .section.blue{border-left-color:var(--blue)}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:860px){.g2,.g3{grid-template-columns:1fr}}
    label.small{display:block;color:var(--muted);font-size:.86em;margin-bottom:4px}
    .box{border:1px dashed var(--vio);border-radius:10px;padding:10px;min-height:58px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--vio),transparent);margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:linear-gradient(45deg,var(--red),#ff6b7a);color:#000;border:none;padding:10px 14px;border-radius:8px;
      font-weight:bold;cursor:pointer;transition:.15s;text-transform:uppercase;letter-spacing:1px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(255,71,87,.45)}
    .btn.sec{background:linear-gradient(45deg,var(--vio),var(--vio2));color:#fff}
    .btn.alt{background:linear-gradient(45deg,var(--blue),#78a9ff);color:#000}
    .btn.ghost{background:transparent;border:2px dashed var(--vio);color:var(--muted)}
    input,select{width:100%;padding:10px;background:rgba(0,0,0,.7);border:2px solid var(--vio);border-radius:8px;color:var(--fg)}
    ul{margin:6px 0 0 18px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78em;font-weight:bold}
    .b-ready{background:var(--green);color:#fff}.b-used{background:#e74c3c;color:#fff}
    .code{color:var(--red);font-weight:bold}
    .log{max-height:280px;overflow:auto;background:rgba(0,0,0,.45);border:2px solid var(--vio);border-radius:10px;padding:12px}
    .line{border-left:3px solid var(--vio);padding-left:10px;margin:8px 0;background:rgba(95,39,205,.12);border-radius:4px}
    .muted{opacity:.75}
    .hidden{display:none}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Add just below <div class="wrap"> -->
<div id="quickJoin" class="section" style="display:none; border-left-color:#f39c12">
  <h3 class="title">Quick Join</h3>
  <div class="grid g3">
    <div>
      <label class="small">Game Key</label>
      <input id="qj_session" placeholder="e.g. QT1">
    </div>
    <div>
      <label class="small">Seat Key</label>
      <input id="qj_seat" placeholder="ABCD-1234">
    </div>
    <div>
      <label class="small">Your Name</label>
      <input id="qj_name" placeholder="Your name">
    </div>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn" id="qj_btn">Claim Seat</button>
  </div>
  <div class="muted" id="qj_msg" style="margin-top:6px"></div>
</div>

  <h2 class="title">ğŸ§¾ AGENT DASHBOARD</h2>

  <!-- dossier -->
  <div class="section">
    <div class="row" style="justify-content:space-between">
      <div><span class="code" id="codenameText">OPERATIVE</span> <span class="muted">(Agent ID <span id="agentIdText">â€”</span>)</span></div>
      <div class="muted">Game: <span id="gameKeyText">â€”</span> Â· Final Night: <span id="finalNightText">â€”</span></div>
    </div>
    <div class="hr"></div>

    <div class="grid g3">
      <div class="box">
        <label class="small">Your Name</label><div id="realNameText">â€”</div>
        <label class="small" style="margin-top:6px">Adopted Character Name</label><div id="aliasText">â€”</div>
        <label class="small" style="margin-top:6px">Cover Identity</label><div id="coverText">â€”</div>
      </div>
      <div class="box">
        <label class="small">Operational Role</label><div id="roleText">â€”</div>
        <label class="small" style="margin-top:6px">Role Objective</label><div id="roleObjective">â€”</div>
        <label class="small" style="margin-top:6px">Win Condition</label><div id="roleWin">â€”</div>
      </div>
      <div class="box">
        <label class="small">Secret Mission (you only)</label><div id="secretMissionText">â€”</div>
      </div>
    </div>

    <div class="grid g2" style="margin-top:10px">
      <div class="box"><label class="small">Background</label><div id="backgroundText">â€”</div></div>
      <div class="box"><label class="small">Discharge</label><div id="dischargeText">â€”</div></div>
    </div>

    <div class="grid g3" style="margin-top:10px">
      <div class="box"><label class="small">Perks (table rules)</label><ul id="perkList"><li>&mdash;</li></ul></div>
      <div class="box"><label class="small">Behavioral Quirk</label><div id="quirkText">â€”</div></div>
      <div class="box"><label class="small">Con</label><div id="conText">â€”</div></div>
    </div>

    <div class="box" style="margin-top:10px">
      <div class="row" style="justify-content:space-between">
        <div>
          <label class="small">Special Ability</label>
          <div id="abilityName"><strong>â€”</strong></div>
          <div class="small" id="abilityDesc">â€”</div>
        </div>
        <div>
          <span id="abilityBadge" class="badge b-ready">READY</span>
          <div class="small">Uses Left Today: <span id="abilityUsesLeft">1</span></div>
        </div>
      </div>
      <div class="grid g3" style="margin-top:10px">
        <div><label class="small">Target (optional)</label><select id="abilityTargetSelect"></select></div>
        <div><label class="small">â€¦or type Agent ID</label><input id="abilityTargetId" placeholder="agent_xxx"/></div>
        <div style="align-self:end"><button class="btn alt" id="btnUseAbility">Use Ability</button></div>
      </div>
    </div>
  </div>

  <!-- Missions -->
  <div class="section orange">
    <h3 class="title">ğŸ“‹ Missions</h3>
    <div class="box">
      <label class="small">Active Mission</label>
      <div id="missionText">None. Request one below.</div>
      <div class="row" style="margin-top:8px">
        <button class="btn sec" id="btnReqMission">Request Mission</button>
        <button class="btn" id="btnCompleteMission">Complete Mission</button>
        <button class="btn ghost" id="btnFailMission">Fail & Redraw</button>
      </div>
      <div class="small" style="margin-top:6px">Completed: <span id="missionCount">0</span></div>
    </div>
  </div>

  <!-- Actions -->
  <div class="section blue">
    <h3 class="title">ğŸ“ Submit Action / Penalty / Task</h3>
    <div class="grid g3">
      <div>
        <label class="small">Action Type</label>
        <select id="actionType">
          <option value="penalty">Report Penalty</option>
          <option value="task_complete">Task Complete</option>
          <option value="murderer_act">Report Murderer Act</option>
          <option value="ability">Use Ability (also above)</option>
        </select>
      </div>
      <div>
        <label class="small">Target Player</label>
        <select id="actionTarget"></select>
      </div>
      <div>
        <label class="small">Details</label>
        <input id="actionDetails" placeholder="What happened / instructions"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn alt" id="btnSubmitAction">Submit</button>
    </div>
  </div>

  <!-- Public roster -->
  <div class="section">
    <h3 class="title">ğŸ—‚ï¸ Public Roster (bios + perks/quirks/cons)</h3>
    <div id="rosterList" class="box">â€”</div>
  </div>

  <!-- Log -->
  <div class="section">
    <h3 class="title">ğŸ“¡ Operation Log</h3>
    <div id="logView" class="log">â€”</div>
  </div>

  <div class="row" style="justify-content:space-between">
    <div class="row">
      <button class="btn sec" id="btnRefresh">Refresh</button>
      <button class="btn ghost" id="btnLeave">Leave Seat</button>
    </div>
    <a class="btn" href="./index.html">Back to Login</a>
  </div>
</div>

<script>
/* ===== helpers ===== */
const $ = id => document.getElementById(id);
const pick = a => a[Math.floor(Math.random()*a.length)];
const dayKey = () => { const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; };
const ui = (id, html) => { const el=$(id); if(el) el.innerHTML = html; };
function option(v,t){const o=document.createElement('option');o.value=v;o.textContent=t;return o;}

/* ===== roles ===== */
const ROLES = {
  flipped_agent:{ name:"The Flipped Agent", obj:"Stay hidden while sowing chaos. Frame others or recruit allies.", win:"Survive final vote OR flip another player." },
  handler:{ name:"The Handler", obj:"Identify the traitor through investigation and deduction.", win:"Correctly identify the Flipped Agent in the final vote." },
  wildcard:{ name:"The Wildcard", obj:"Survive and adapt; can align with either side.", win:"Align with the winning side OR complete your solo objectives." },
  innocent:{ name:"Innocent Operative", obj:"Identify the traitor and survive the final vote.", win:"Vote out the Flipped Agent OR survive to the end." }
};

/* ===== missions ===== */
const MISSIONS = [
  "Wear ski goggles to dinner; never explain why.",
  "Ask 3 strangers where the CIA safehouse is.",
  "Challenge someone to a snowball duel; loser does a shoey.",
  "Bring a random item to the bar and convince someone itâ€™s priceless.",
  "Gain legit access to another playerâ€™s room for 15 minutes.",
  "Speak only in a fake Russian accent for 3 hours.",
  "Critique outfits using military terminology.",
  "Take a candid photo of every player undetected.",
  "Get someone to break a minor rule for you.",
  "Teach a stranger a codeword and use it later."
];

/* ===== characters (12) â€” same set used on index ===== */
const CHARACTERS = [
  { alias:"ValÃ©rie â€œValâ€ Marchand", codename:"LACEHUNTER", cover:"Luxury Skiwear Designer",
    publicBio:"French AF comms â†’ NATO PSYOPS â€˜tactical glamâ€™. Gives unsolicited runway checks.",
    privateBio:"Trans man. Busted tailoring a generalâ€™s thermals. Canâ€™t pass a mirror without preening.",
    background:"Former French Air Force comms; reassigned to NATO PSYOPS for â€˜morale optimizationâ€™.",
    discharge:"Non-disciplinary separation after a glitter-related morale incident.",
    secretMission:"Track down the mystery ghoster from a classified Alpine affair and collect 3 clues.",
    perks:["Honorific Lock: others must call you â€œMonsieur Valâ€.","Style Verdict: on 'Runway check', target holds an awkward 10-sec pose."],
    quirk:"Silk cravat; lip balm mid-sentence; says â€œLieutenant Thirsttrapâ€.",
    con:"If he catches his reflection he must stop & preen for 3s.",
    ability:{ name:"Fashion Emergency", desc:"Force any two players to swap one visible clothing item immediately.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Kaimana â€œKaiâ€ Savai'i", codename:"SNOWBLIND", cover:"Extreme Sports Photographer",
    publicBio:"RFMF (Fiji) recon tracker; can find happy hour with GPS accuracy.",
    privateBio:"Refused to hunt an innocent defector (his brother). Collects slang like shell casings.",
    background:"Reconnaissance & tracking specialist; humanitarian ops liaison.",
    discharge:"Honourable discharge after family conflict.",
    secretMission:"Collect 3 strangersâ€™ hometown slang and compile a 'tracking lexicon'.",
    perks:["Breadcrumb Command: choose a trigger word; speakers owe a clue or take penalty for 10 min.","Switchback: say 'First tracks' â†’ rotate seats; last seated owes you a favour."],
    quirk:"Whispers intel and ends with 'copy?'.",
    con:"If someone says 'family'/'ohana', must deliver a 1-sentence heartfelt lesson.",
    ability:{ name:"Hire a Tail", desc:"Recruit one player to shadow you 10â€“30 min; deliver intel every 5 min or take penalties.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Bartosz â€œBasâ€ Nowak", codename:"FROSTBITE", cover:"Adventure Safety Coordinator",
    publicBio:"Polish GROM cold-weather specialist. Loves lists & laminated check cards.",
    privateBio:"Interrogation â€˜cultural differencesâ€™. Considers silence a confession.",
    background:"SERE instructor, polar training cadre.",
    discharge:"Honourable; opted out after â€˜communicationâ€™ feedback.",
    secretMission:"Convince a stranger to wear your gloves and pose like a crime-scene silhouette.",
    perks:["Interrogatorâ€™s Pause: on 'Answer the question', reply in â‰¤5 words.","Cold Protocol: greetings become fist-bump only until cleared."],
    quirk:"Over-enunciates like radio checks; NATO phonetic for numbers.",
    con:"When asked 'whatâ€™s the plan?' must show a checklist or salute 'I am improvising.'",
    ability:{ name:"Coerce an Asset", desc:"Designate a player your Asset for 15 min; complete 2 simple tasks or take penalties.", usesPerDay:1 },
    role:"handler"
  },
  { alias:"Ira â€œIrisâ€ Khatri", codename:"BLACKRUN", cover:"Avalanche Risk Specialist",
    publicBio:"Para (SF) mountain warfare; predicts disasters in people as easily as in snow.",
    privateBio:"Trans man. The avalanche that saved lives also hid sins; wonâ€™t say whose.",
    background:"High-altitude demo team; SAR & explosives.",
    discharge:"Medical after surviving a unit-ending avalanche.",
    secretMission:"Run a spontaneous 'safety briefing' with strangers and redistribute props they must wear.",
    perks:["Beacon Check: phones face-down 5 min; touching = penalty.","Disaster Brief: two table taps resets topic & assigns next speaker."],
    quirk:"Adds 'allegedly' to claims if alcohol is present.",
    con:"On triangles/angles must estimate degrees aloud; off by >10Â° â†’ draw a napkin protractor.",
    ability:{ name:"Avalanche Protocol", desc:"Clap twice: 30-sec evac drill. Everyone swaps seats & surrenders a small item; you redistribute.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Pilar â€œPiliâ€ CastaÃ±o", codename:"POWDER KEG", cover:"Luxury Lodge Event Coordinator",
    publicBio:"Spanish social engineer; diplomacy with a splash of chaos.",
    privateBio:"Trans man. Ran weapons through receptions. Still RSVPâ€™s 'maybe' to Interpol.",
    background:"Human terrain ops; embassy events fixer.",
    discharge:"Dishonourable (creative import/export).",
    secretMission:"Get a stranger to announce you as 'His Excellency the Ambassador of AprÃ¨s'.",
    perks:["VIP Gate: others must introduce you with a flamboyant invented title.","Guest List: 'Youâ€™re on the list' â†’ 2-min private chat to assign a micro-task."],
    quirk:"Refuses real names; assigns callsigns.",
    con:"On any rumour he must add 'exclusive source' + wink; if asked later 'source?' must admit 'It was me.'",
    ability:{ name:"Task the Mark", desc:"Nominate any player to get a phone #, key/card, or selfie with anyone within 20 min. Failure = penalty.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Dmitri â€œDimaâ€ Volkov", codename:"ICEPICK", cover:"Artisanal Spirits Consultant",
    publicBio:"Ex-Spetsnaz (allegedly). Measures every drink. Speaks in Celsius.",
    privateBio:"Defectedâ€”or didnâ€™t. Awaits a signal only heâ€™d recognize.",
    background:"Urban recon & counter-human intel.",
    discharge:"â€˜Special transferâ€™ during the Sochi Olympics.",
    secretMission:"Learn a new vodka toast and perform it with the group.",
    perks:["Cold Stare: on eye contact the other must break first or penalty.","Vodka Toast Override: on 'Na zdorovye', all must toast within 30s or penalty."],
    quirk:"Answers 'roger' instead of 'yes' and ends sentences with 'over.'",
    con:"When a new person arrives, pat pockets: 'ID, keys, exitâ€”roger'; skipping â†’ 10-sec bug sweep.",
    ability:{ name:"Charm Offensive (vodka-only)", desc:"Before midnight compel 3 people to buy you vodka drinks. Refusal/wrong drink = penalty.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Rowan â€œRoâ€ Hart", codename:"WOLFTRAP", cover:"Night Security Analyst",
    publicBio:"Ex-infantry turned nightclub perimeter whisperer. Hears bouncers before the bass.",
    privateBio:"Trans man. Thinks velvet ropes are guidelines. Once dated a smoke machine.",
    background:"Perimeter defense & crowd control.",
    discharge:"Honourable.",
    secretMission:"Convince a venue staffer to radio-check you using a callsign you invent.",
    perks:["Line Cutter: insert into any group; someone must introduce you within 20s.","Bouncerâ€™s Choice: point to the door; one person must accompany you for a 60s perimeter check."],
    quirk:"Counts exits (quietly) when entering a room.",
    con:"If music changes, freeze for 3s like a motion sensor.",
    ability:{ name:"Angle Check (10-sec hold)", desc:"Command a target to hold a dramatic pose facing a 'camera' for 10s.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Asher â€œAshâ€ Del Mar", codename:"SEALEVEL", cover:"Hydro Logistics Planner",
    publicBio:"Special forces boat guy who gets altitude sickness looking at menus.",
    privateBio:"Smuggled a jet-ski into a hotel fountain. Twice.",
    background:"Riverine logistics & insertions.",
    discharge:"Honourable (but wet).",
    secretMission:"Collect three coasters from different venues and arrange a 'map' on the table.",
    perks:["High-Water Mark: pick a 'shoreline' on the table; items crossing it owe you a sip.","Docking Fee: anyone returning to the group pays a one-word status update."],
    quirk:"Adds boat metaphors to everything.",
    con:"If someone says 'wave', salute like a lifeguard.",
    ability:{ name:"Harbour Master", desc:"Declare the current table 'Port'. Anyone joining owes you a status report + cheers.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Noah â€œKnoxâ€ Keegan", codename:"SWITCHBACK", cover:"Mountain Bike Guide",
    publicBio:"Downhill brain, uphill charm. Always plotting the next corner.",
    privateBio:"Claims a scar for each Greek letter he remembers. Suspicious count.",
    background:"Bike-mounted patrol & courier.",
    discharge:"Honourable.",
    secretMission:"Borrow a helmet from someone not in your group and wear it for 2 minutes.",
    perks:["Gear Check: on 'Drop a gear', everyone lowers voice one notch for 2 min.","Trail Marshal: you decide who speaks next for 60s."],
    quirk:"Claps once when he stands up.",
    con:"If someone says 'brake', freeze mid-gesture for 2s.",
    ability:{ name:"Trail Tax (chaos)", desc:"Pick two people to swap seats & share a 'route apology'.", usesPerDay:1 },
    role:"innocent"
  },
  { alias:"Jamie â€œHarrowâ€ Quinn", codename:"BONESAW", cover:"Field Medic (Former)",
    publicBio:"Good with stitches; terrible with boundaries. Brings tape to conversations.",
    privateBio:"Kept a toe tag as a bookmark. It fell out at a funeral.",
    background:"Combat medic; mass-casualty triage.",
    discharge:"Honourable; 'bedside manner incompatible with brass'.",
    secretMission:"Bandage (real or improvised) a non-player and get them to rate your care /10.",
    perks:["Triage: you may interrupt any chat to ask 'Vitals?'â€”answer must be a number.","Sterile Field: designate a 30 cm zone around your drink; violators owe an apology shot."],
    quirk:"Calls snacks 'oral medication'.",
    con:"If someone says 'owie', produce a bandage.",
    ability:{ name:"Scrub In", desc:"Declare an emergency consult; target must whisper their last snack & biggest fear.", usesPerDay:1 },
    role:"wildcard"
  },
  { alias:"Elliot â€œLedgerâ€ Vance", codename:"COUNTERSIGN", cover:"Casino Surveillance",
    publicBio:"Counts cards, people, and regrets. Mostly people.",
    privateBio:"Wears mirrored sunglasses at night because 'math is bright'.",
    background:"Surveillance, pattern analysis.",
    discharge:"Honourable; banned from three casinos.",
    secretMission:"Convince someone to speak only in numbers with you for 30 seconds.",
    perks:["Tell Read: you may ask someone to repeat a sentence slower.","Double Down: once, force a yes/no commitment from the table."],
    quirk:"Murmurs odds to himself.",
    con:"If anyone says a number >10, whisper a different random number.",
    ability:{ name:"Background Count", desc:"Ask the GM for a one-line statistical hint about any player.", usesPerDay:1 },
    role:"handler"
  },
  { alias:"Rafe â€œStaticâ€ Moretti", codename:"JAMMER", cover:"RF Tech",
    publicBio:"Carries more antennas than personality. Stillâ€¦ weirdly charming.",
    privateBio:"Blocked a wedding livestream so the brideâ€™s ex couldnâ€™t watch. She thanked him.",
    background:"Signals intelligence & EW.",
    discharge:"Honourable; requested more batteries than the army owned.",
    secretMission:"Get a stranger to say 'Say again?' twice in one conversation.",
    perks:["Signal Check: say 'Bars?' â†’ everyone must show lock screen for 3s.","Dead Zone: pick a corner where nobody may use phones for 5 min."],
    quirk:"Says 'Copy' to compliments.",
    con:"If someone says 'loud', turn an imaginary knob.",
    ability:{ name:"Static Burst", desc:"Declare a 30-sec 'comms outage': everyone speaks in whispers only.", usesPerDay:1 },
    role:"innocent"
  }
];

/* ===== deterministic character from seat ===== */
function charFromSeat(seat){
  let h=0; for(const c of seat) h=(h*31 + c.charCodeAt(0))>>>0;
  return JSON.parse(JSON.stringify(CHARACTERS[h % CHARACTERS.length]));
}

/* ===== API ===== */
async function api(op, body={}){
  if(op==='get'){ const r=await fetch(`/api/game?id=${encodeURIComponent(body.id)}`); return r.json(); }
  const r = await fetch('/api/game', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({op, ...body})
  });
  return r.json();
}

/* ===== state ===== */
let gameState = {};
let me = null;
let pollHandle = null;

/* ===== small helpers that talk to server ===== */
async function postEvent(msg){
  const id = gameState.id || localStorage.getItem('session');
  if(!id) return;
  try{ await api('event', { sessionId:id, msg }); }catch(e){}
}
async function updateMe(patch){
  const sessionId = gameState.id || localStorage.getItem('session');
  const playerId = me?.id || localStorage.getItem('playerId');
  if(!sessionId || !playerId) return;
  const res = await api('update_player', { sessionId, playerId, patch });
  if(res?.ok && res.player){ me = res.player; }
}

/* ===== ability uses/day ===== */
function usesLeft(){
  const st = me?.abilityState || {usesLeft:(me?.ability?.usesPerDay??1), lastResetDay:dayKey()};
  if(st.lastResetDay!==dayKey()){
    st.lastResetDay=dayKey(); st.usesLeft = me?.ability?.usesPerDay ?? 1; me.abilityState=st;
    updateMe({abilityState:st});
  }
  return st.usesLeft ?? 0;
}

/* ===== ensure character data exists server-side ===== */
async function ensureCharacterPatched(){
  const seat = localStorage.getItem('seatToken') || '';
  if(!me || !seat) return;

  const need = () => (!me.codename || !me.cover || !me.background || !me.discharge ||
                      !me.secretMission || !me.quirk || !me.con ||
                      !me.perks || !me.perks.length || !me.ability || !me.ability.name);

  if(!need()) return;

  const ch = charFromSeat(seat);
  const patch = {};
  const setIfMissing = (k,v)=>{ if(me[k]==null || (Array.isArray(me[k]) && me[k].length===0) || me[k]===''){ patch[k]=v; } };
  setIfMissing('codename', ch.codename);
  setIfMissing('alias', ch.alias);
  setIfMissing('adoptedName', ch.alias);
  setIfMissing('cover', ch.cover);
  setIfMissing('publicBio', ch.publicBio);
  setIfMissing('privateBio', ch.privateBio);
  setIfMissing('background', ch.background);
  setIfMissing('discharge', ch.discharge);
  setIfMissing('secretMission', ch.secretMission);
  setIfMissing('perks', ch.perks);
  setIfMissing('quirk', ch.quirk);
  setIfMissing('con', ch.con);
  setIfMissing('ability', ch.ability);
  setIfMissing('role', ch.role || 'wildcard');
  // ability state boot
  if(!me.abilityState){ patch.abilityState = { usesLeft: ch.ability?.usesPerDay ?? 1, lastResetDay: dayKey() }; }

  if(Object.keys(patch).length){
    await updateMe(patch);
    await postEvent(`ğŸ†” ${patch.codename || me.codename || 'OPERATIVE'} character profile synced from seat.`);
    await refreshState(); // pull everyone fresh
  }
}

/* ===== renderers ===== */
function renderDossier(){
  if(!me) return;
  ui('codenameText', me.codename || 'OPERATIVE');
  ui('agentIdText', me.id || 'â€”');
  ui('realNameText', me.realName || 'â€”');
  ui('aliasText', me.adoptedName || me.alias || 'â€”');
  ui('coverText', me.cover || 'â€”');
  ui('backgroundText', me.background || 'â€”');
  ui('dischargeText', me.discharge || 'â€”');
  ui('secretMissionText', me.secretMission || 'â€”');

  const role = ROLES[me.role] || {name:me.role||'â€”', obj:'â€”', win:'â€”'};
  ui('roleText', role.name); ui('roleObjective', role.obj); ui('roleWin', role.win);

  const perks = (me.perks||[]).map(p=>`<li>${p}</li>`).join('') || '<li>&mdash;</li>';
  ui('perkList', perks);
  ui('quirkText', me.quirk || 'â€”');
  ui('conText', me.con || 'â€”');

  ui('abilityName', `<strong>${me.ability?.name||'â€”'}</strong>`);
  ui('abilityDesc', me.ability?.desc || 'â€”');

  const left = usesLeft();
  ui('abilityUsesLeft', left);
  const b = $('abilityBadge'); b.className = 'badge ' + (left>0?'b-ready':'b-used'); b.textContent = (left>0?'READY':'USED');
}

function populateTargets(){
  const others = (gameState.players||[]).filter(p=>!me || p.id!==me.id);
  const ids = ['abilityTargetSelect','actionTarget'];
  ids.forEach(id=>{
    const sel=$(id); if(!sel) return;
    sel.innerHTML=''; sel.appendChild(option('','â€” Select â€”'));
    others.forEach(p=> sel.appendChild(option(p.id, `${p.codename} (${p.realName})`)));
  });
}

function renderRoster(){
  const list = gameState.players||[];
  const html = list.length ? list.map(p=>{
    const perks = (p.perks||[]).map(x=>`<li>${x}</li>`).join('') || '<li>&mdash;</li>';
    const meTag = (me && p.id===me.id) ? ' (you)' : '';
    return `
      <div class="box" style="margin:10px 0">
        <div class="row" style="justify-content:space-between">
          <div><strong class="code">${p.codename||'OPERATIVE'}</strong> â€” ${p.realName||'Agent'}${meTag}</div>
          <div class="muted">${p.id}</div>
        </div>
        <div class="muted">${p.cover||''}</div>
        <div class="grid g3" style="margin-top:8px">
          <div><label class="small">Public Bio</label>${p.publicBio||'â€”'}</div>
          <div><label class="small">Quirk</label>${p.quirk||'â€”'}</div>
          <div><label class="small">Con</label>${p.con||'â€”'}</div>
        </div>
        <div style="margin-top:6px"><label class="small">Perks</label><ul>${perks}</ul></div>
      </div>`;
  }).join('') : 'â€”';
  ui('rosterList', html);
}

function renderLog(){
  const log = gameState.gameLog || [];
  const html = log.slice(-400).map(l=>`<div class="line"><strong>[${new Date(l.ts).toLocaleTimeString()}]</strong> ${l.msg}</div>`).join('');
  ui('logView', html || 'â€”');
  const el=$('logView'); el.scrollTop = el.scrollHeight;
}

/* ===== actions ===== */
async function useAbility(){
  if(!me?.ability) return;
  let st = me.abilityState || {usesLeft:1,lastResetDay:dayKey()};
  if(st.usesLeft<=0){ await postEvent(`âš ï¸ ${me.codename} tried to use ability but has no uses left.`); return; }
  const selId = $('abilityTargetSelect').value || '';
  const typed = ($('abilityTargetId').value||'').trim();
  const target = (gameState.players||[]).find(p=> p.id === (selId||typed));
  const tLabel = target ? `${target.codename} (${target.realName})` : 'â€”';

  st.usesLeft = Math.max(0,(st.usesLeft??1)-1); me.abilityState = st;
  await updateMe({abilityState:st});
  renderDossier();
  await postEvent(`âš¡ ${me.codename} used "${me.ability.name}" on ${tLabel}.`);
  $('abilityTargetId').value='';
}

function ensureMission(){
  me.missions = me.missions || {active:null,count:0};
  return me.missions;
}
async function reqMission(){
  const m = ensureMission();
  if(m.active){ await postEvent(`${me.codename} requested new mission without completing previous â†’ group consensus penalty?`); }
  m.active = pick(MISSIONS); ui('missionText', m.active);
  await updateMe({missions:m}); await postEvent(`ğŸ“‹ ${me.codename} drew a mission: "${m.active}"`);
}
async function completeMission(){
  const m = ensureMission(); if(!m.active) return;
  await postEvent(`âœ… ${me.codename} completed mission: "${m.active}"`);
  m.active=null; m.count=(m.count||0)+1; ui('missionText','None. Request one below.'); ui('missionCount', m.count);
  await updateMe({missions:m});
}
async function failMission(){
  const m = ensureMission();
  if(!m.active){ await reqMission(); return; }
  await postEvent(`âŒ ${me.codename} failed mission: "${m.active}" â€” new mission requested.`);
  m.active = pick(MISSIONS); ui('missionText', m.active);
  await updateMe({missions:m});
}

function labelFor(id){ const p=(gameState.players||[]).find(x=>x.id===id); return p? `${p.codename} (${p.realName})` : (id||'â€”'); }
async function submitAction(){
  const type = $('actionType').value;
  const target = $('actionTarget').value;
  const details = ($('actionDetails').value||'(no details)').trim();
  let text='';
  if(type==='penalty') text=`ğŸ“ Penalty on ${labelFor(target)} â€” ${details}`;
  else if(type==='task_complete') text=`ğŸ“ Task complete by ${me.codename} â€” ${details}`;
  else if(type==='murderer_act') text=`ğŸ“ Murderer act report by ${me.codename} â€” ${details}`;
  else text=`ğŸ“ Ability use by ${me.codename} on ${labelFor(target)} â€” ${details}`;
  await postEvent(text); $('actionDetails').value=''; $('actionTarget').value='';
}
<script>
  // show overlay if thereâ€™s no seat in localStorage
  function showQuickJoinIfNeeded(){
    const seat = localStorage.getItem('seatToken');
    const session = localStorage.getItem('session') || new URLSearchParams(location.search).get('session') || '';
    if(!seat){
      document.getElementById('quickJoin').style.display = '';
      document.getElementById('qj_session').value = (session||'').toUpperCase();
    }
  }

  async function quickJoin(){
    const sessionId = (document.getElementById('qj_session').value||'').toUpperCase().trim();
    const seatToken  = (document.getElementById('qj_seat').value||'').toUpperCase().trim();
    const playerName = (document.getElementById('qj_name').value||'').trim();
    const msg = t => document.getElementById('qj_msg').textContent = t;

    if(!sessionId || !seatToken){ msg('Enter game key + seat key'); return; }

    // same deterministic character pack as index.html
    function pickChar(seat){
      let h=0; for(const c of seat) h=(h*31 + c.charCodeAt(0))>>>0;
      return JSON.parse(JSON.stringify(CHARACTERS[h % CHARACTERS.length]));
    }
    const ch = pickChar(seatToken); ch.adoptedName = ch.alias;

    const res = await api('join', {
      sessionId, seatToken, playerName,
      character: ch,
      abilityState: { usesLeft: ch.ability?.usesPerDay ?? 1, lastResetDay: dayKey() }
    });

    if(!res.ok){ msg('Join failed: '+(res.error||'')); return; }

    localStorage.setItem('session', res.session.id);
    localStorage.setItem('seatToken', seatToken);
    localStorage.setItem('playerId', res.player.id);
    localStorage.setItem('playerName', playerName||'');
    document.getElementById('quickJoin').style.display='none';
    await refreshState(); startPoll();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    showQuickJoinIfNeeded();
    const btn = document.getElementById('qj_btn');
    if(btn) btn.onclick = quickJoin;
  });
</script>

/* ===== refresh/poll ===== */
async function refreshState(){
  const id = localStorage.getItem('session') || (new URLSearchParams(location.search).get('session')||'').toUpperCase();
  if(!id) return;
  const res = await api('get',{id}); if(!res.ok) return;
  gameState = res.session || {};
  const myId = localStorage.getItem('playerId');
  if(myId) me = (gameState.players||[]).find(p=>p.id===myId) || me;

  ui('gameKeyText', gameState.id || 'â€”');
  ui('finalNightText', gameState.finalNightAt ? new Date(gameState.finalNightAt).toLocaleString() : 'â€”');

  await ensureCharacterPatched(); // fills perks/quirk/con/etc if missing
  renderDossier(); populateTargets(); renderRoster(); renderLog();
}

function startPoll(){
  if(pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(refreshState, 4000);
}

/* ===== boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const qs = new URLSearchParams(location.search);
  const session = (qs.get('session')||'').toUpperCase();
  if(session){ localStorage.setItem('session', session); }

  // Try to keep the seat warm (safe even if already joined)
  const seat = localStorage.getItem('seatToken');
  const name = localStorage.getItem('playerName') || '';
  if(session && seat){
    const ch = charFromSeat(seat);
    ch.adoptedName = ch.alias;
    // Join (or rejoin) â€” server will ignore duplicate seat claim and return existing player
    try{
      const res = await api('join',{ sessionId:session, seatToken:seat, playerName:name, character:ch,
        abilityState:{usesLeft: ch.ability?.usesPerDay ?? 1, lastResetDay: dayKey()} });
      if(res?.player){ localStorage.setItem('playerId', res.player.id); }
    }catch(e){}
  }

  await refreshState(); startPoll();

  // controls
  $('btnUseAbility').onclick = useAbility;
  $('btnReqMission').onclick = reqMission;
  $('btnCompleteMission').onclick = completeMission;
  $('btnFailMission').onclick = failMission;
  $('btnSubmitAction').onclick = submitAction;
  $('btnRefresh').onclick = refreshState;
  $('btnLeave').onclick = ()=>{
    localStorage.removeItem('session'); localStorage.removeItem('seatToken'); localStorage.removeItem('playerId'); window.location.href='./index.html';
  };
});
</script>
</body>
</html>
